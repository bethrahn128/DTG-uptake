---
title: "IeDEA SA256: DTG uptake: 04 Follow up "
subtitle: ""
author: "Radek Panczak, Eliane Rohner, Elizabeth Zaniewski"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
    keep_md: no
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "docs") })
---

```{r r-setup, include = FALSE}
options(scipen = 999)
options(max.print = "75")
set.seed(12345)

library(pacman)
p_load(fst, tidyverse, magrittr, kableExtra, report)

import::from("sjmisc", "frq")
```

```{r conflicts, include = FALSE}
tidyverse::tidyverse_conflicts()

conflicted::conflict_scout()
```

```{r knit-setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE,
                      echo = FALSE)

knitr::opts_knit$set(width = 75)
```

<!-- ----------------------------------------------------- -->

# Data

From `01_data-preps.Rmd`  

```{r}
tblBAS <- as_tibble(read_fst("data/tblBAS.fst")) %>%
  mutate(dtg = factor(dtg, levels = c(1, 0),
                      labels = c("DTG", "Other ART")))

tblART <- as_tibble(read_fst("data/tblART.fst")) %>%  
  mutate(dtg = factor(dtg, levels = c(1, 0),
                          labels = c("DTG", "Other ART"))) 
```

<!-- ----------------------------------------------------- -->

# FU time - differences between cohorts

## Set up

Two things to remember:

- This is an overall FU time for patients, irrespectively of the medication  

- FU start at the later date of DTG initiation on the site *OR* patient starting any ART if later  

- DTG indicator is an indicator of DTG ever administered, even if stopped/switched  

## Examples 

Example, of patient with two ARTs and switch    

```{r}
tblBAS %>%
  filter(patient == "SMZS7225") %>% 
  select(recart_d, 
         dtg_min_program, dtg_min_pat,
         max_close_d, 
         start_fu, end_fu, FU_day)

tblBAS %>%
  filter(patient == "SMZS7225") %>% 
  select(recart_d, rev_outcome, rev_outcome_d, dtg_first)

tblART %>%
  filter(patient == "SMZS7225") %>% 
  select(- patient, -program)
```

<!-- ----------------------------------------------------- -->

# Results 

## Across program   

```{r}
ggplot(tblBAS, aes(x = program, y = FU_month, colour = dtg)) +
  geom_boxplot(outlier.alpha = 0.1) + 
  coord_flip() +
  theme_minimal() 
```

Scaled to number of patients  

```{r}
ggplot(tblBAS, aes(x = program, y = FU_month, colour = dtg)) +
  geom_boxplot(outlier.alpha = 0.1, varwidth = TRUE) + 
  coord_flip() +
  theme_minimal() 
```

Alternative views

```{r}
ggplot(tblBAS, aes(x = program, y = FU_month, fill = dtg)) +
  geom_violin(#scale = "count", 
    color = NA) +
  coord_flip() +
  theme_minimal() 
```

```{r}
ggplot(tblBAS, aes(x = FU_month, fill = dtg)) +
  geom_density(colour = NA, alpha = 0.4) + 
  facet_wrap(~program, scales = "free") +
  theme_minimal() 
```

## Outcome   

```{r}
ggplot(tblBAS, aes(x = rev_outcome, y = FU_month, colour = dtg)) +
  geom_boxplot(outlier.alpha = 0.1) + 
  coord_flip() +
  theme_minimal() 
```

## Sex

```{r}
ggplot(tblBAS, aes(x = factor(sex), y = FU_month, colour = dtg)) +
  geom_boxplot(outlier.alpha = 0.1, varwidth = TRUE) + 
  scale_y_continuous(breaks = seq(0, 60, 12)) + 
  coord_flip() +
  theme_minimal() + 
  xlab("") + ylab("FU time in months")
```

## Age

```{r}
ggplot(tblBAS, aes(x = factor(age_cat1), y = FU_month, colour = dtg)) +
  geom_boxplot(outlier.alpha = 0.1, varwidth = TRUE) + 
  scale_y_continuous(breaks = seq(0, 60, 12)) + 
  coord_flip() +
  theme_minimal() + 
  xlab("") + ylab("FU time in months")
```

<!-- ----------------------------------------------------- -->

# Computing Environment

```{r echo=FALSE, results='asis'}
report(sessionInfo())
```