---
title: "IeDEA SA256 DTG uptake <br> 021 Switching cohort Outcomes"
subtitle: " "
author: ""
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
    keep_md: no
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "docs") })
---

```{r r-setup, include = FALSE}
options(scipen = 999)
options(max.print = "200")
set.seed(12345)

library(pacman)
p_load(sf, tidyverse, kableExtra, report, magrittr, fst, data.table, survival, lubridate, ggsurvfit, gtsummary, tidycmprsk, Hmisc, survminer, survMisc)

p_load(
  kableExtra,
  scales, ggplot2, dplyr,
  fst, data.table, sjmisc,
  osfr
)

#install.packages("finalfit")

library(survival)
library(lubridate)
library(ggsurvfit)
library(gtsummary)
library(tidycmprsk)
library(Hmisc)
library(survminer)
library(forcats)
library(dplyr)
#library(condsurv)



import::from("sjmisc", "frq")
import::from("gmodels", "CrossTable")
```

```{r conflicts, include = FALSE}
tidyverse::tidyverse_conflicts()

conflicted::conflict_scout()
```

```{r knit-setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE,
                      echo = FALSE)

knitr::opts_knit$set(width = 200)
```

<!-- ----------------------------------------------------- -->

```{r include=FALSE}
#Clear existing data and graphics
rm(list=ls())
graphics.off()
```


<!-- ----------------------------------------------------- -->

# National DTG adoption dates

Pulled by @aezaniewski from different sources.  

```{r include=FALSE}
dtg_recomend = data.table(read_fst("data_temp/dtg_recomend_v1a.fst"))

dtg_recomend$ctry <- factor(dtg_recomend$country, levels = c( "LSO","MOZ" ,"MWI", "ZAF", "ZMB", "ZWE"),
 labels = c("Lesotho", "Mozambique", "Malawi", "South Africa", "Zambia", "Zimbabwe"))

```

```{r echo=FALSE}
dtg_recomend %>% select(country, ctry, dtg_recomend_d) %>%
  kbl() %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE
  ) %>%
  column_spec(1, italic = TRUE) %>%
  row_spec(1, italic = FALSE)
```



```{r include=FALSE}
tblBAS_orig = data.table(read_fst("data_temp/tblBAS_v1e_LTFU_who.fst"))


# transition cohort is those who started ART before DTG adoption date
tblBAS = tblBAS_orig[cohort ==2,]

#frq(tblBAS, program)

# remove AfA
tblBAS = tblBAS[program != "AfA",]

# correct dtg_switch to reflect any dtg that was made to zero and thus is no longer valid
frq(tblBAS, dtg)
frq(tblBAS, dtg_switch)
frq(tblBAS, dtg_status)
test1 <- tblBAS %>% filter(dtg_final ==0 & dtg_switch ==1)

tblBAS = tblBAS[, dtg_switch := 0]
tblBAS = tblBAS[dtg_final ==1, dtg_switch := 1]
frq(tblBAS, dtg_switch)

rm(test1)


tblBAS = tblBAS[, dtg_switch_txt := factor(dtg_switch, 
      levels = c(0, 1),
      labels = c("No switch", "Switched to DTG")
)]

frq(tblBAS, dtg_switch_txt)


tblBAS = tblBAS[, age_cat3 := cut(age, 
                                  breaks = c(seq(20, 50, 10), 100),
                                  include.lowest = TRUE,
                                  right = FALSE)]

tblBAS = tblBAS[, rev_naive_y := factor(rev_naive_y, 
                              levels = c(0, 1),
                              label = c("Not naive", "Naive"))]

frq(tblBAS, rev_naive_y)



setDT(tblBAS)[, recart_ym := format(as.Date(recart_d), "%Y-%m")] 



## Follow-up dates are referrring to outcome dates

tblBAS[dtg_switch == 1, end_fu := dtg_min_pat + 1]
tblBAS[dtg_switch == 0, end_fu := rev_outcome_d]
tblBAS[, FU_day := as.numeric(end_fu - start_fu)]
tblBAS[, FU_month := round(as.numeric(end_fu - start_fu) / (365.25 / 12), 1)]
tblBAS[, FU_year := round(as.numeric(end_fu - start_fu) / (365.25), 1)]


```

```{r}

tblBAS <- tblBAS %>%
  select(-birth_d, -aids_d, -aids_d_a, 
         -hiv_pos_d, -hiv_pos_d_a, 
         -drop_y, -drop_d, -drop_d_a, -drop_rs,
         -death_y, -death_d, -death_d_a,
         -l_alive_d, -l_alive_d_a) 
```


```{r}

tblBAS <- tblBAS %>% 
  mutate(sex_age1 = interaction(sex, age_cat1)) %>%
  mutate(sex_age2 = interaction(sex, age_cat2)) %>%
  mutate(sex_age3 = interaction(sex, age_cat3)) %>%
  as_tibble()


tblBAS$ctry <- factor(tblBAS$country, levels = c( "LSO","MOZ" ,"MWI", "ZAF", "ZMB", "ZWE"),
 labels = c("Lesotho", "Mozambique", "Malawi", "South Africa", "Zambia", "Zimbabwe"))

```


```{r}

# create variables for plots showing time as calendar year

tblBAS <- tblBAS %>%
  mutate(start_min_d = min(start_fu)) %>% 
  mutate(start_min_d3 = min(dtg_recomend_d)) %>% 
  mutate(end_max_d = max(end_fu)) %>%
  mutate(time_max_t = as.numeric(end_max_d) - as.numeric(start_min_d)) %>% ## gives range of start to end
  mutate(time_t = as.numeric(end_fu) - as.numeric(start_fu)) %>%  ##
  mutate(time_t2 = as.numeric(end_fu) - as.numeric(start_min_d)) %>%  ## gives end time relative to earliest start min date (=earliest dtg adoption date)
  mutate(dtg_recomend_t = as.numeric(dtg_recomend_d) - as.numeric(start_min_d)) # gives dtg adoption date relative to earliest dtg adoption date
 
```


```{r include=FALSE}

tblART = data.table(read_fst("data_temp/tblART_v1e_LTFU_who.fst"))

tblART <- tblART %>%
  select(-recart_d) %>%
  as_tibble() %>% 
  mutate(program_fac = factor(program)) %>%
  left_join(tblBAS %>% select(patient, recart_d, dtg_switch, dtg_switch_txt, rev_outcome, rev_outcome_d), by ="patient") %>%
  filter(!is.na(recart_d))

```


```{r eval=FALSE, include=FALSE}
testLSO <- tblART %>% filter(country == "LSO" & dtg_switch ==1) %>% arrange(art_sd)
```


```{r}

tblART = data.table(tblART)
dtg_index_by_program = tblART[dtg_switch == 1, c("program", "art_sd")]
dtg_index_by_program = dtg_index_by_program[, .SD[which.min(art_sd)], by = "program"][order(program)]

setnames(dtg_index_by_program, "art_sd", "dtg_min_program")


```


```{r}

tblBAS <- tblBAS %>%
  mutate(dtg_naive = interaction(rev_naive_y, dtg_switch_txt)) %>%
  mutate(time = FU_day) %>% 
  mutate(start_min_d = min(start_fu)) %>% 
  mutate(start_min_d3 = min(dtg_recomend_d)) %>% 
  mutate(end_max_d = max(end_fu)) %>%
  mutate(time_max_t = as.numeric(end_max_d) - as.numeric(start_min_d)) %>%
  mutate(time_t = as.numeric(end_fu) - as.numeric(start_fu)) %>%
  mutate(time_t2 = as.numeric(end_fu) - as.numeric(start_min_d)) %>%
  mutate(time_t3 = as.numeric(end_fu) - as.numeric(start_min_d3)) %>%
  mutate(dtg_recomend_t = as.numeric(dtg_recomend_d) - as.numeric(start_min_d)) %>%
  mutate(alt_start_fu = 2018.9 + (as.numeric(start_fu) - as.numeric(as.Date("2018-11-01"))) /365.25,
         alt_end_fu = 2018.9 + (as.numeric(end_fu) - as.numeric(as.Date("2018-11-01"))) /365.25) %>% 
  mutate(alt_start_fu2 = start_min_d + (as.numeric(start_fu) - as.numeric(as.Date("2018-11-01"))) /365.25,
        alt_end_fu2 = start_min_d + (as.numeric(end_fu) - as.numeric(as.Date("2018-11-01"))) /365.25) %>%
  mutate(alt_start_fu3 = as.numeric(start_fu) - as.numeric(start_min_d)) %>%
  mutate(alt_end_fu3 = as.numeric(end_fu) - as.numeric(start_min_d)) 


tblBAS$ctry <- factor(tblBAS$country, levels = c( "LSO","MWI", "MOZ" ,"ZAF", "ZMB", "ZWE"),
 labels = c("Lesotho", "Malawi", "Mozambique", "South Africa", "Zambia", "Zimbabwe"))
```


```{r eval=FALSE, include=FALSE}
tblBAS %>% summarise(min(start_fu))

tblBAS %>% summarise(min(dtg_recomend_d))

tblBAS %>% summarise(min(start_min_d))

tblBAS %>% summarise(min(start_min_d3))

frq(tblBAS, dtg_recomend_t)
```


```{r include=FALSE}

# Create outcome variable
# 0 = started DTG, numbers are for other outcomes
frq(tblBAS, dtg)
tblBAS <- tblBAS %>%
mutate(status_outcome = ifelse(dtg_switch ==1, 0, 
                    ifelse(dtg_switch ==0 & rev_outcome == "Death", 1, 
                                  ifelse(dtg ==0 & rev_outcome == "LTFU", 2,
                                         ifelse(dtg ==0 & rev_outcome == "Transfer", 3, 
                                                ifelse(dtg ==0 & rev_outcome == "RIC", 4, 5))))))

frq(tblBAS, status_outcome)


tblBAS <- tblBAS %>%
mutate(dtg_status = ifelse(dtg_switch == 1,1,0)) %>%
mutate(dtg_status_outcome = ifelse(dtg_switch ==1, 0, 
                    ifelse(status_outcome==1, 1,
                           ifelse(status_outcome==2, 2,
                                  ifelse(status_outcome==3, 3,
                                         ifelse(status_outcome==4, 4, 5))))))




frq(tblBAS, dtg_status_outcome)
frq(tblBAS, dtg_switch)

tblBAS = data.table(tblBAS)



tblBAS = tblBAS[, dtg_status_outcome_txt := factor(dtg_status_outcome, 
      levels = c(0, 1, 2, 3, 4),
      labels = c("DTG switch", "Death", "LTFU", "Transfer", "RIC")
)]

frq(tblBAS, dtg_status_outcome_txt)



frq(tblBAS, dtg_switch_txt)
frq(tblBAS, dtg_switch)
frq(tblBAS, dtg_status_outcome)
frq(tblBAS, dtg_status_outcome_txt)
frq(tblBAS, rev_outcome)
frq(tblBAS, program)

```

```{r include=FALSE}
frq(tblBAS, program)
frq(tblBAS, ctry)
frq(tblBAS, dtg_status_outcome_txt)
frq(tblBAS, dtg_switch)
```


```{r eval=FALSE, include=FALSE}

# poisson regression model

# make older age the reference category
frq(tblBAS, age_cat1)
tblBAS2 <- tblBAS %>% mutate(age_cat1b = relevel(age_cat1, ref = "[70,100]"))
frq(tblBAS2, age_cat1b)

results <- glm(dtg_switch ~ sex, data = tblBAS2, family = "poisson")
exp(coef(results))
print(summary(results)) 

results <- glm(dtg_switch ~ age_cat1b, data = tblBAS2, family = "poisson")
exp(coef(results))
print(summary(results)) 


results <- glm(dtg_switch ~ sex + age_cat1b, data = tblBAS2, family = "poisson")
results
print(summary(results))
## to get rate ratios
exp(coef(results))

# https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9150348/
# https://github.com/nyilin/DoublingOfCases
# https://sandwich.r-forge.r-project.org/articles/sandwich.html
# https://grodri.github.io/glms/r/robust
# https://eprints.whiterose.ac.uk/169886/3/Robust%20SE.%20manuscript.%20in%20White%20Rose.pdf
# https://www.youtube.com/watch?v=GDp5E-mA2iM (11:45)


```
  

<!-- ----------------------------------------------------- -->

# Data wrangling

All patients who were on ART at the national DTG adoption date.


Follow-up start/end dates are defined as follows:  


**Follow-up start for all patients:** begins on DTG adoption data (all patients are on ART at DTG adoption date).  

**Follow-up end for patients who switched to DTG:** follow-up ends one day after DTG switch.   

**Follow-up end for patients who do not switch to DTG:** follow-up ends at earliest of death, transfer, LTFU or remained in care (RIC) date.  



## Data inclusion criteria

### 1. Other previously applied inclusion/exclusion criteria  

A) No patients with DTG records:  
  none  
  
B) Less than 6 months of data between DTG adoption date and database close date:  
 none
  
C) Pediatric cohort  
  -Redcross   
  
D) Less than 100 patients in total data set:  
  -Rahimamoosa    
  
E) Excluded AfA (as private and not representative of South Africa or IeDEA-SA)
 
  
```{r echo=FALSE}
table1::label(tblBAS$sex) <- "Sex"
table1::label(tblBAS$age_cat3) <- "Age group"
table1::label(tblBAS$dtg_switch_txt) <- "Switch to DTG"
table1::label(tblBAS$dtg_status_outcome) <- "Outcome"
table1::label(tblBAS$sex_age2) <- "Sex & age group"
table1::label(tblBAS$sex_age3) <- "Sex & age group"
table1::label(tblBAS$program) <- "Program"
table1::label(tblBAS$ctry) <- "Country"
table1::label(tblBAS$dtg_status_outcome_txt) <- "Outcome"
table1::label(tblBAS$FU_day) <- "Follow-up time"

```


Programs:

```{r}
setDT(tblBAS)
tblBAS = tblBAS[, tempname := paste(program, max_close_d, sep = "")]
```


```{r echo=FALSE}
maxclose <- tblBAS %>% select(country, program, dtg_recomend_d, dtg_min_program, max_close_d) %>%
  arrange(dtg_recomend_d, country, program) %>%
  group_by(country, program, dtg_recomend_d, max_close_d) %>%
  mutate(Npatients = n()) %>%
  distinct()
  
maxclose %>% 
  kbl() %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE
  ) %>%
  column_spec(1, italic = TRUE) %>%
  row_spec(1, italic = FALSE)
```


### 2. Ensure all programs have patients starting ART >=24m after national DTG adoption date

Programs without patients starting ART >= 24m after national DTG adoption

```{r}
exclude = data.table(read_fst("data_temp/tblBAS_initiation_programsexcluded_ART24m_v2.fst"))


exclude %>% 
  kbl() %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE
  ) %>%
  column_spec(1, italic = TRUE) %>%
  row_spec(1, italic = FALSE)

```

Only keep programs with patients starting ART >= 24 months after national adoption date

```{r}

tblBAS = tblBAS[!tempname %in% exclude$tempname, ]

frq(tblBAS,program)

```


### 3. Ensure all patients have >=15 months of potential follow-up since national DTG adoption date

If looking at LTFU and VL outcomes, best if patients have at least 15 months of potential follow-up

LTFU algorithm: >90 days late to next scheduled appointment (which could be at one year interval)
Viral load: recommended at 4 or 6 months and then yearly after, but maybe look at viral load by 12 months (with an upper range of + 3 months == within first 15 months)

```{r echo=FALSE}

tblBAS = data.table(tblBAS)

# for LTFU outcome, ensure all patients have at least 365 + 91 = 456 days of time (15m) between recart_d and max_close_d
tblBAS[, FU_time_days := as.numeric(max_close_d - dtg_recomend_d)]
tblBAS[, FU_time_months := round(as.numeric(max_close_d - dtg_recomend_d) / (365.25 / 12), 1)]


tblBAS[, FU_time_15m := 0]
tblBAS[FU_time_days >= 456, FU_time_15m := 1]

```

Proportion with >= 15 months of potential follow-up == 1

```{r}
frq(tblBAS,FU_time_15m)
```

Only keep patients with >= 15 months of potential follow-up

```{r}
tblBAS = tblBAS[FU_time_15m ==1, ]

frq(tblBAS,program)

```


### 4. Ensure all programs have >= 100 patients

Programs with <100 patients

```{r echo=FALSE}
exclude <- tblBAS %>% select(country, program, dtg_recomend_d, dtg_min_program, max_close_d, tempname) %>%
  arrange(dtg_recomend_d, country, program, tempname) %>%
  group_by(country, program, dtg_recomend_d, max_close_d, tempname) %>%
  mutate(Npatients = n()) %>%
  distinct() %>%
  filter(Npatients < 100)


  
```

```{r eval=FALSE, include=FALSE}

exclude %>% 
  kbl() %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE
  ) %>%
  column_spec(1, italic = TRUE) %>%
  row_spec(1, italic = FALSE)
```


Only keep programs with >100 patients 

```{r}

tblBAS = tblBAS[!(tblBAS$tempname %in% exclude$tempname), ]

frq(tblBAS,program)

rm(listprograms, exclude, maxclose)

```


```{r}
tblBAS <- tblBAS %>% group_by(program) %>% mutate(Npatients = n()) %>% ungroup %>% filter(Npatients >=100)
```


## Final list of programs included in transition cohort



```{r echo=FALSE}
maxclose <- tblBAS %>% select(country, program, dtg_recomend_d, dtg_min_program, max_close_d) %>%
  arrange(dtg_recomend_d, country, program) %>%
  group_by(country, program, dtg_recomend_d, max_close_d) %>%
  mutate(Npatients = n()) %>%
  distinct()
  
maxclose %>% 
  kbl() %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE
  ) %>%
  column_spec(1, italic = TRUE) %>%
  row_spec(1, italic = FALSE)
```



```{r}
FU_time <- tblBAS %>% select(patient, country, ctry, program, sex, 
                    age, age_cat1, age_cat2,  age_cat3, 
                    sex_age1, sex_age2, sex_age3, 
                    start_fu, end_fu, FU_day, time,
                    dtg_switch, dtg_switch_txt, 
                    max_close_d, dtg_switch_txt, dtg_status_outcome, dtg_status_outcome_txt, 
                     dtg_recomend_d, dtg_recomend_t, 
                    time_t, time_t2
                  )

```


```{r}
write_fst(tblBAS, "data_temp/tblBAS_transition_v2_outcome_LTFU_who.fst")
```

<!-- ----------------------------------------------------- -->

# Baseline characteristics


## Overview by country


```{r}
sjPlot::tab_xtab(tblBAS$ctry,
                 tblBAS$sex,
                 show.row.prc = TRUE, show.summary = FALSE)
```


```{r}
sjPlot::tab_xtab(tblBAS$ctry,
                 tblBAS$sex_age2,
                 show.row.prc = TRUE, show.summary = FALSE)
```


```{r eval=FALSE, include=FALSE}
sjPlot::tab_xtab(tblBAS$dtg_switch_txt,
                 tblBAS$ctry,
                 show.col.prc = TRUE, show.summary = FALSE)
```


```{r eval=FALSE, include=FALSE}
table1::table1(~  sex + age_cat3 + dtg_switch + FU_day | ctry , data = tblBAS)

```


## Overview by program


```{r}
sjPlot::tab_xtab(tblBAS$program,
                 tblBAS$sex,
                 show.row.prc = TRUE, show.summary = FALSE)
```


```{r}
sjPlot::tab_xtab(tblBAS$program,
                 tblBAS$sex_age2,
                 show.row.prc = TRUE, show.summary = FALSE)
```


```{r eval=FALSE, include=FALSE}
sjPlot::tab_xtab(tblBAS$program,
                 tblBAS$dtg_switch_txt,
                 show.row.prc = TRUE, show.summary = FALSE)
```

<!-- ----------------------------------------------------- -->

# DTG switch

Number of adults that switched to DTG ART.

## by country

```{r}
sjPlot::tab_xtab(tblBAS$ctry,
                 tblBAS$dtg_switch_txt,
                 show.row.prc = TRUE, show.summary = FALSE)
```


## by program

```{r}
sjPlot::tab_xtab(tblBAS$program,
                 tblBAS$dtg_switch_txt,
                 show.row.prc = TRUE, show.summary = FALSE)
```


## by sex & age

```{r}
sjPlot::tab_xtab(tblBAS$sex_age3,
                 tblBAS$dtg_switch_txt,
                 show.row.prc = TRUE, show.summary = FALSE)
```


<!-- ----------------------------------------------------- -->

# DTG switch: stacked bar chart

The percentage (%) of adults that switched to DTG ART overall in the data set.

## by country

```{r include=FALSE}
tblBAS_tmp <- tblBAS %>% select(patient, country, ctry, dtg_switch, program, dtg_switch_txt, sex, age_cat1, age_cat2, rev_outcome, start_fu, end_fu, dtg_switch_txt)

frq(tblBAS_tmp, program)
frq(tblBAS_tmp, ctry)
frq(tblBAS_tmp, dtg_switch_txt)

# dtg_switch_txt
# none == 0, first == 1, switch == 2
df4 <- tblBAS_tmp %>%
  select(country, dtg_switch) %>%
  mutate(dtg_switch_txt1 = ifelse(dtg_switch ==1, 1, 0)) %>%
  mutate(dtg_switch_txt2 = ifelse(dtg_switch ==0, 1, 0))

# dtg first
cat1 <- df4 %>%
  group_by(country) %>%
  summarise(
    numer = sum(dtg_switch_txt1, na.rm =TRUE),
    denom = n()) %>%
  mutate(per = numer/denom *100) %>%
  mutate(percentage = round(per, 1)) %>%
  mutate(outcome = "a") %>%
  select(-c(per))

# dtg other
cat2 <- df4 %>%
  group_by(country) %>%
  summarise(
    numer = sum(dtg_switch_txt2, na.rm =TRUE),
    denom = n()) %>%
  mutate(per = numer/denom *100) %>%
  mutate(percentage = round(per, 1)) %>%
  mutate(outcome = "b") %>%
  select(-c(per))


## Append files
data <- rbind(cat1, cat2)


#### overall

# no dtg
cat1a <- df4 %>%
    mutate(country = "All") %>%
    group_by(country) %>%
    summarise(
    numer = sum(dtg_switch_txt1, na.rm =TRUE),
    denom = n()) %>%
  mutate(per = numer/denom *100) %>%
  mutate(percentage = round(per, 1)) %>%
  mutate(outcome = "a") %>%
  select(-c(per))

# dtg first
cat2a <- df4 %>%
      mutate(country = "All") %>%
    group_by(country) %>%
    summarise(
    numer = sum(dtg_switch_txt2, na.rm =TRUE),
    denom = n()) %>%
  mutate(per = numer/denom *100) %>%
  mutate(percentage = round(per, 1)) %>%
  mutate(outcome = "b") %>%
  select(-c(per))



## Append files
dataa <- rbind(cat1a, cat2a)

data <- rbind(data, dataa)

data <- data %>%
  mutate(text2 = round(percentage, 0))


## Plot percentage of HIV clinics that provide the following HIV-related services

data$country <- factor(data$country, levels = c( "LSO","MOZ","MWI","ZAF","ZMB","ZWE", "All"),
                      labels = c("Lesotho", "Mozambique", "Malawi","South Africa", "Zambia", "Zimbabwe" , "Total"))

data$outcome <- factor(data$outcome, levels = c( "a","b"),
                       labels = c("Switch to DTG", "No switch to DTG"))



# The palette with grey:
#cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

fill <- c("#56B4E9", "#D55E00")

#fill <- c("#3F6D9B", "#a94c4c")

#fill <- c("#3F6D9B", "#D55E00")

```



```{r echo=FALSE}
ggplot(data, aes(x=country, y=percentage, fill=outcome, label = text2)) + 
  geom_bar(position = position_stack(reverse = TRUE), stat="identity") +
  scale_fill_manual(labels = ~ stringr::str_wrap(.x, width = 30), values = fill)  +
  scale_color_manual(labels = ~ stringr::str_wrap(.x, width = 30), values = fill) +
  theme(legend.position="bottom", 
        legend.box.background = element_rect(color = "black"),
        legend.direction="horizontal", 
        legend.box.margin = margin(t = 1, l = 1),
        legend.title = element_blank(),
        axis.title.y = element_text(size=10),
        axis.title.x = element_text(size=10),
        axis.text.y = element_text(size=10),
        axis.text.x = element_text(size=10),
        legend.text = element_text(size=10)) +
  labs(x="", y="Percentage (%)", fill ="") +
  scale_y_continuous(n.breaks = 5) +
  guides(fill = guide_legend(reverse=TRUE)) +
  geom_text(size = 4.5, colour = "white", fontface = "bold", position = position_stack(reverse = TRUE, vjust = 0.8))
# Print plot to a png file
ggsave("output/Cohort_transition_outcomes/Descriptive/DTG_switch_by_country.png", width = 8, height =4)

```

## by program

```{r include=FALSE}
tblBAS_tmp <- tblBAS %>% select(patient, country, ctry, dtg_switch, program, dtg_switch_txt, sex, age_cat1, age_cat2, rev_outcome, start_fu, end_fu)

frq(tblBAS_tmp, program)
frq(tblBAS_tmp, ctry)
frq(tblBAS_tmp, dtg_switch_txt)

# dtg_switch_txt
# none == 0, first == 1, switch == 2
df4 <- tblBAS_tmp %>%
  select(program, dtg_switch) %>%
  mutate(dtg_switch_txt1 = ifelse(dtg_switch ==1, 1, 0)) %>%
  mutate(dtg_switch_txt2 = ifelse(dtg_switch ==0, 1, 0))

# dtg first
cat1 <- df4 %>%
  group_by(program) %>%
  summarise(
    numer = sum(dtg_switch_txt1, na.rm =TRUE),
    denom = n()) %>%
  mutate(per = numer/denom *100) %>%
  mutate(percentage = round(per, 1)) %>%
  mutate(outcome = "a") %>%
  select(-c(per))

# dtg other
cat2 <- df4 %>%
  group_by(program) %>%
  summarise(
    numer = sum(dtg_switch_txt2, na.rm =TRUE),
    denom = n()) %>%
  mutate(per = numer/denom *100) %>%
  mutate(percentage = round(per, 1)) %>%
  mutate(outcome = "b") %>%
  select(-c(per))


## Append files
data <- rbind(cat1, cat2)

data <- data %>%
  mutate(text2 = round(percentage, 0))


## Plot percentage of HIV clinics that provide the following HIV-related services


data$outcome <- factor(data$outcome, levels = c( "a","b"),
                       labels = c("Switch to DTG", "No switch to DTG"))

# The palette with grey:
#cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

fill <- c("#56B4E9", "#D55E00")

#fill <- c("#3F6D9B", "#a94c4c")

#fill <- c("#3F6D9B", "#D55E00")

```


```{r echo=FALSE}

ggplot(data, aes(x=program, y=percentage, fill=outcome, label = text2)) + 
  geom_bar(position = position_stack(reverse = TRUE), stat="identity") +
  scale_fill_manual(labels = ~ stringr::str_wrap(.x, width = 30), values = fill)  +
  scale_color_manual(labels = ~ stringr::str_wrap(.x, width = 30), values = fill) +
  theme(legend.position="bottom", 
        legend.box.background = element_rect(color = "black"),
        legend.direction="horizontal", 
        legend.box.margin = margin(t = 1, l = 1),
        legend.title = element_blank(),
        axis.title.y = element_text(size=10),
        axis.title.x = element_text(size=10),
        axis.text.y = element_text(size=10),
        axis.text.x = element_text(size=10, angle =90, hjust =0.5, vjust =0.5,),
        legend.text = element_text(size=10)) +
  labs(x="", y="Percentage (%)", fill ="") +
  scale_y_continuous(n.breaks = 5) +
  guides(fill = guide_legend(reverse=TRUE)) +
  geom_text(size = 4.5, colour = "white", fontface = "bold", position = position_stack(reverse = TRUE, vjust = 0.8))
# Print plot to a png file
ggsave("output/Cohort_transition_outcomes/Descriptive/DTG_switch_by_program.png", width = 8, height =4)

```


## by sex & age

```{r include=FALSE}

tblBAS_tmp <- tblBAS %>% select(patient, country, ctry, program, dtg_switch, sex, sex_age3, sex_age2, age_cat1, age_cat2, age_cat3, rev_outcome, start_fu, end_fu) 

frq(tblBAS_tmp, program)
frq(tblBAS_tmp, ctry)

# dtg_switch_txt
# none == 0, first == 1, switch == 2
df4 <- tblBAS_tmp %>%
  select(program, ctry, sex, dtg_switch, age_cat3) %>%
  mutate(dtg_switch_txt1 = ifelse(dtg_switch ==1, 1, 0)) %>%
  mutate(dtg_switch_txt2 = ifelse(dtg_switch ==0, 1, 0))


# dtg first
cat1 <- df4 %>%
  group_by(sex, age_cat3) %>%
  summarise(
    numer = sum(dtg_switch_txt1, na.rm =TRUE),
    denom = n()) %>%
  mutate(per = numer/denom *100) %>%
  mutate(percentage = round(per, 1)) %>%
  mutate(outcome = "a") %>%
  select(-c(per))

# dtg other
cat2 <- df4 %>%
  group_by(sex, age_cat3) %>%
  summarise(
    numer = sum(dtg_switch_txt2, na.rm =TRUE),
    denom = n()) %>%
  mutate(per = numer/denom *100) %>%
  mutate(percentage = round(per, 1)) %>%
  mutate(outcome = "b") %>%
  select(-c(per))


## Append files
data <- rbind(cat1, cat2)

data <- data %>%
  mutate(text2 = round(percentage, 0))


## Plot percentage of HIV clinics that provide the following HIV-related services


data$outcome <- factor(data$outcome, levels = c( "a","b"),
                      labels = c("Switch to DTG", "No switch to DTG"))

```


```{r include=FALSE}

# The palette with grey:
#cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

#fill <- c("royalblue4", "deepskyblue3","lightskyblue1")
fill <- c("#56B4E9", "#D55E00")

data_f <- data %>% filter(sex == "Female")

f <- ggplot(data_f, aes(x=age_cat3, y=percentage, fill=outcome, label = text2)) + 
  geom_bar(position = position_stack(reverse = TRUE), stat="identity", width=0.7) +
  scale_fill_manual(labels = ~ stringr::str_wrap(.x, width = 30), values = fill)  +
  scale_color_manual(labels = ~ stringr::str_wrap(.x, width = 30), values = fill) +
  theme(legend.position="bottom", 
        legend.box.background = element_rect(color = "black"),
        legend.direction="horizontal", 
        legend.box.margin = margin(t = 1, l = 1),
        legend.title = element_blank(),
        axis.title.y = element_text(size=10),
        axis.title.x = element_text(size=10),
        axis.text.y = element_text(size=10),
        axis.text.x = element_text(size=10, angle =0, hjust =0.5, vjust =0.5,),
        legend.text = element_text(size=10)) +
  labs(x="", y="Percentage (%)", fill ="") +
  scale_y_continuous(n.breaks = 5) +
  guides(fill = guide_legend(reverse=TRUE)) +
  geom_text(size = 4.5, colour = "white", fontface = "bold", position = position_stack(reverse = TRUE, vjust = 0.8)) +
  labs(title='Female') 

f

data_m <- data %>% filter(sex == "Male")
m <- ggplot(data_m, aes(x=age_cat3, y=percentage, fill=outcome, label = text2)) + 
  geom_bar(position = position_stack(reverse = TRUE), stat="identity", width=0.7) +
  scale_fill_manual(labels = ~ stringr::str_wrap(.x, width = 30), values = fill)  +
  scale_color_manual(labels = ~ stringr::str_wrap(.x, width = 30), values = fill) +
  theme(legend.position="bottom", 
        legend.box.background = element_rect(color = "black"),
        legend.direction="horizontal", 
        legend.box.margin = margin(t = 1, l = 1),
        legend.title = element_blank(),
        axis.title.y = element_text(size=10),
        axis.title.x = element_text(size=10),
        axis.text.y = element_text(size=10),
        axis.text.x = element_text(size=10, angle =0, hjust =0.5, vjust =0.5,),
        legend.text = element_text(size=10)) +
  labs(x="", y="Percentage (%)", fill ="") +
  scale_y_continuous(n.breaks = 5) +
  guides(fill = guide_legend(reverse=TRUE)) +
  geom_text(size = 4.5, colour = "white", fontface = "bold", position = position_stack(reverse = TRUE, vjust = 0.8)) +
  labs(title='Male') 

m

```


```{r echo=FALSE}
ggarrange(f, m, ncol =1, nrow =2, common.legend = TRUE, legend = "bottom") 
```


```{r include=FALSE}
rm("df4", "tblBAS_tmp", "cat1", "cat2", "cat1a", "cat2a", "dataa", "data", "data_f", "data_m", "f", "m")
```


<!-- ----------------------------------------------------- -->

# Number who switched to DTG over time

Number of adults who switched to DTG ART over time, aggregated by their DTG switch date.

Binwidth = 30. 

Black vertical lines are national DTG adoption dates.

## by country


```{r echo=FALSE}
# histogram
f <- tblBAS %>% 
  filter(dtg_switch ==1) %>%
  filter(sex == "Female") %>%
  ggplot(aes(x = dtg_min_pat, fill = dtg_switch_txt)) +
  geom_histogram(alpha = 0.8, binwidth =30, position = "identity") +
  theme_classic() + 
  facet_wrap(vars(ctry), scales = "free_y") +
  geom_vline(aes(xintercept = dtg_recomend_d)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  labs(fill='', x='DTG switch date', y='Number', title='Women') +
  scale_fill_manual("", values = c("#56B4E9")) +
  guides(fill=FALSE) 

f


# histogram
m <- tblBAS %>% 
  filter(dtg_switch ==1) %>%
  filter(sex == "Male") %>%
  ggplot(aes(x = dtg_min_pat, fill = dtg_switch_txt)) +
  geom_histogram(alpha = 0.8, binwidth =30, position = "identity") +
  theme_classic() + 
  facet_wrap(vars(ctry), scales = "free_y") +
  geom_vline(aes(xintercept = dtg_recomend_d)) +
  xlab("FU end (year)") + ylab("Number") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  labs(fill='Type of ART', x='DTG switch date', y='Number', title='Men') +
   scale_fill_manual("DTG switch date", values = c("#56B4E9")) +
  guides(fill=FALSE)

m

```


```{r eval=FALSE, include=FALSE}

ggarrange(f, m, ncol =1, nrow =2, common.legend = TRUE, legend = "bottom") 


ggsave("output/Cohort_transition_outcomes/Descriptive/DTG_switch_by_country_sex.png", width = 7, height =6)

```


## by program

```{r echo=FALSE}
# histogram
f <- tblBAS %>% 
  filter(dtg_switch ==1) %>%
  filter(sex == "Female") %>%
  ggplot(aes(x = dtg_min_pat, fill = dtg_switch_txt)) +
  geom_histogram(alpha = 0.8, binwidth =30, position = "identity") +
  theme_minimal() + 
  facet_wrap(vars(program), scales = "free_y") +
  geom_vline(aes(xintercept = dtg_recomend_d)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  labs(fill='', x='DTG switch date', y='Number', title='Women') +
  scale_fill_manual("", values = c("#56B4E9")) +
  guides(fill=FALSE)

f


# histogram
m <- tblBAS %>% 
  filter(dtg_switch ==1) %>%
  filter(sex == "Male") %>%
  ggplot(aes(x = dtg_min_pat, fill = dtg_switch_txt)) +
  geom_histogram(alpha = 0.8, binwidth =30, position = "identity") +
  theme_minimal() + 
  facet_wrap(vars(program), scales = "free_y") +
  geom_vline(aes(xintercept = dtg_recomend_d)) +
  xlab("FU end (year)") + ylab("Number") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  labs(fill='Type of ART', x='DTG switch date', y='Number', title='Men') +
   scale_fill_manual("DTG switch date", values = c("#56B4E9")) +
  guides(fill=FALSE)

m

```


```{r eval=FALSE, include=FALSE}
ggarrange(f, m, ncol =1, nrow =2, common.legend = TRUE, legend = "bottom") 
```



## by age

```{r include=FALSE}
# histogram
f <- tblBAS %>% 
  filter(dtg_switch ==1) %>%
  filter(sex == "Female") %>%
  ggplot(aes(x = dtg_min_pat, fill = dtg_switch_txt)) +
  geom_histogram(alpha = 0.8, binwidth =30, position = "identity") +
  theme_classic() + 
  facet_wrap(vars(age_cat2), nrow = 4, scales = "free_y") +
  geom_vline(aes(xintercept = dtg_recomend_d)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  labs(fill='', x='DTG switch date', y='Number', title='Women') +
  scale_fill_manual("", values = c("#56B4E9")) +
  guides(fill=FALSE)

f

# histogram
m <- tblBAS %>% 
  filter(dtg_switch ==1) %>%
  filter(sex == "Male") %>%
  ggplot(aes(x = dtg_min_pat, fill = dtg_switch_txt)) +
  geom_histogram(alpha = 0.8, binwidth =30, position = "identity") +
  theme_classic() + 
  facet_wrap(vars(age_cat2), nrow = 4, scales = "free_y") +
  geom_vline(aes(xintercept = dtg_recomend_d)) +
  xlab("FU end (year)") + ylab("Number") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  labs(fill='Type of ART', x='DTG switch date', y='Number', title='Men') +
   scale_fill_manual("DTG switch date", values = c("#56B4E9")) +
  guides(fill=FALSE)

m
```


```{r echo=FALSE}
ggarrange(f, m, ncol =2, nrow =1, common.legend = TRUE, legend = "bottom") 

ggsave("output/Cohort_transition_outcomes/Descriptive/DTG_switch_by_sex_age.png", width = 7, height =6)

```


```{r include=FALSE}
rm("f", "m")
```


<!-- ----------------------------------------------------- -->

# Density plots of number that switched to DTG

Density plots for patients switching to DTG by sex, aggregated by their DTG switch date.

Binwidth = 30


## by country  

```{r echo=FALSE}
tblBAS %>% 
  filter(dtg_switch ==1) %>%
  ggplot(aes(x = dtg_min_pat, color = sex)) +
  geom_density(alpha = 0.1) +
  facet_wrap(vars(ctry), scales = "free_y") +
  theme_minimal() + 
  xlab("ART switch date") + ylab("Density") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  ggtitle("") +
  labs(color='Type of ART') +
  scale_color_manual(values =c( "#56B4E9", "#D55E00")) +
  guides(color = guide_legend(reverse=TRUE)) 
```


## by program  

```{r echo=FALSE}
tblBAS %>% 
  filter(dtg_switch ==1) %>%
  ggplot(aes(x = dtg_min_pat, color = sex)) +
  geom_density(alpha = 0.1) +
  facet_wrap(vars(program), scales = "free_y") +
  theme_minimal() + 
  xlab("DTG switch date") + ylab("Density") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  ggtitle("") +
  labs(color='Type of ART') +
  scale_color_manual(values =c("#56B4E9", "#D55E00")) +
  guides(color = guide_legend(reverse=TRUE)) 
```

## by age

```{r echo=FALSE}
tblBAS %>% 
  filter(dtg_switch ==1) %>%
  ggplot(aes(x = dtg_min_pat, color = sex)) +
  geom_density(alpha = 0.1) +
  facet_wrap(vars(age_cat3), scales = "free_y") +
  theme_minimal() + 
  xlab("ART start date") + ylab("Density") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  ggtitle("") +
  labs(color='Type of ART') +
  scale_color_manual(values =c("#56B4E9", "#D55E00")) +
  guides(color = guide_legend(reverse=TRUE)) 
```


<!-- ----------------------------------------------------- -->

# DTG switch: proportion by sex

Among adults that switched to DTG ART, the percentage that are male or female.

Aggregated DTG switch date by month.



## by country

```{r echo=FALSE}

tblBAS2 <- tblBAS %>%
  filter(dtg_switch ==1)

tblBAS2 <- tblBAS2 %>%
  mutate(recart_date = floor_date(as_date(dtg_min_pat), "month")) %>%
  mutate(sex2 = ifelse(sex =="Female", 1, 0))
  

#tblBAS$Datetime <- as.Date(tblBAS$recart_ym)
#DT<- data.table(tblBAS)
#DT[,sum(dtg_first),by = Datetime]

dtg1 <- tblBAS2 %>%
  filter(dtg_switch ==1) %>%
  group_by(ctry, recart_date) %>%
  summarise(
    numer = sum(sex2),
    denom = n()) %>%
  mutate(line = "age") %>%
  mutate(outcome = "a") %>%
  mutate(per = numer/denom *100) %>%
  mutate(value = round(per, 1)) %>%
  select(-c(per))   
  
dtg2 <- tblBAS2 %>%
   filter(dtg_switch ==1) %>%
  group_by(ctry, recart_date) %>%
  summarise(
    numer_b = sum(sex2),
    denom = n(),
    numer = denom - numer_b) %>%
  mutate(line = "age") %>%
  mutate(outcome = "b") %>%
  mutate(per = numer/denom *100) %>%
  mutate(value = round(per, 1)) %>%
  select(-c(per, numer_b)) 


data <- rbind(dtg1, dtg2)

data$outcome <- factor(data$outcome, levels = c( "a", "b"),
                       labels = c("Female", "Male"))

data <- data %>% filter(recart_date != "2018-12-01")


#fill <- c( "#56B4E9", "#D55E00")

## stacked bar chart with legend on side 
 
ggplot(data, aes(x=recart_date, y=value, fill=outcome)) + 
  geom_bar(position = position_stack(reverse = FALSE), stat="identity") +
  scale_fill_manual(labels = ~ stringr::str_wrap(.x, width = 40), values = fill)  +
  scale_color_manual(labels = ~ stringr::str_wrap(.x, width = 40), values = fill) +
  theme(legend.position="bottom", 
        legend.box.background = element_rect(color = "black"),
        legend.direction="horizontal", 
        legend.box.margin = margin(t = 1, l = 1), 
        axis.title.y = element_text(size=9),
        axis.title.x = element_text(size=9),
        axis.text.y = element_text(size=9),
        axis.text.x = element_text(size=9),
        legend.text = element_text(size=9)) +
   theme_classic() + 
  labs(x="", y="Percentage (%)") +
  scale_y_continuous(n.breaks = 5) +
  guides(fill = guide_legend(reverse=FALSE)) +
  facet_wrap(vars(ctry), nrow = 6) +
  ggtitle("Among adults that switched to DTG the proportion by sex") +
  scale_fill_manual("Sex", values = c("#D55E00", "#56B4E9"),
            guide = guide_legend(reverse = FALSE)) 


ggsave("output/Cohort_transition_outcomes/Descriptive/DTG_switch_proportion_by_country_sex.png", width = 7, height =5)

```

## by age

```{r echo=FALSE}

tblBAS2 <- tblBAS %>%
  filter(dtg_switch ==1)

tblBAS2 <- tblBAS2 %>%
  mutate(recart_date = floor_date(as_date(dtg_min_pat), "month")) %>%
  mutate(sex2 = ifelse(sex =="Female", 1, 0))
  

#tblBAS$Datetime <- as.Date(tblBAS$recart_ym)
#DT<- data.table(tblBAS)
#DT[,sum(dtg_first),by = Datetime]

dtg1 <- tblBAS2 %>%
  filter(dtg_switch ==1) %>%
  group_by(age_cat2, recart_date) %>%
  summarise(
    numer = sum(sex2),
    denom = n()) %>%
  mutate(line = "age") %>%
  mutate(outcome = "a") %>%
  mutate(per = numer/denom *100) %>%
  mutate(value = round(per, 1)) %>%
  select(-c(per))   
  
dtg2 <- tblBAS2 %>%
   filter(dtg_switch ==1) %>%
  group_by(age_cat2, recart_date) %>%
  summarise(
    numer_b = sum(sex2),
    denom = n(),
    numer = denom - numer_b) %>%
  mutate(line = "age") %>%
  mutate(outcome = "b") %>%
  mutate(per = numer/denom *100) %>%
  mutate(value = round(per, 1)) %>%
  select(-c(per, numer_b)) 


data <- rbind(dtg1, dtg2)

data$outcome <- factor(data$outcome, levels = c( "a", "b"),
                       labels = c("Female", "Male"))


#fill <- c( "#56B4E9", "#D55E00")

## stacked bar chart with legend on side 
 
ggplot(data, aes(x=recart_date, y=value, fill=outcome)) + 
  geom_bar(position = position_stack(reverse = FALSE), stat="identity") +
  scale_fill_manual(labels = ~ stringr::str_wrap(.x, width = 40), values = fill)  +
  scale_color_manual(labels = ~ stringr::str_wrap(.x, width = 40), values = fill) +
  theme(legend.position="bottom", 
        legend.box.background = element_rect(color = "black"),
        legend.direction="horizontal", 
        legend.box.margin = margin(t = 1, l = 1), 
        axis.title.y = element_text(size=9),
        axis.title.x = element_text(size=9),
        axis.text.y = element_text(size=9),
        axis.text.x = element_text(size=9),
        legend.text = element_text(size=9)) +
   theme_classic() + 
  labs(x="", y="Percentage (%)") +
  scale_y_continuous(n.breaks = 5) +
  guides(fill = guide_legend(reverse=FALSE)) +
  facet_wrap(vars(age_cat2), nrow = 2) +
  ggtitle("Among adults that switched to DTG the proportion by sex") +
   scale_fill_manual("Sex", values =  c("#D55E00", "#56B4E9"),
            guide = guide_legend(reverse = FALSE)) 


ggsave("output/Cohort_transition_outcomes/Descriptive/DTG_switch_proportion_by_agegroup_sex.png", width = 7, height =4)

```


<!-- ----------------------------------------------------- -->

# DTG switch: number by sex (bidirectional histogram)

Among adults who switched to DTG ART, the number that were male and female.

% Female = 67%

Aggregated by DTG switch date.


```{r eval=FALSE, include=FALSE}
frq(tblBAS, dtg_switch_txt)
```


## by program

```{r include=FALSE}
dtg_type_by_var = tblBAS %>% 
  filter(dtg_switch == 1) %>%
  group_by(program, country, dtg_min_pat, sex, start_min_d, end_max_d) %>% 
  summarise(art_started = n()) %>%
  ungroup() %>% 
  mutate(art_started = ifelse(sex == "Female", art_started, art_started * (-1)))
```


ZAF programs 

```{r echo=FALSE}
#fill <- c("deepskyblue1", "royalblue4")
fill <- c("#56B4E9", "#D55E00")

dtg_type_by_var %>% 
  filter(country == "ZAF") %>% 
  ggplot(aes(x = dtg_min_pat, y = art_started, fill = sex)) +
  geom_col() +
  facet_grid(vars(program), scales = "free_y") +
  theme_minimal() + 
  labs(fill ="Sex") +
  scale_fill_manual(labels = ~ stringr::str_wrap(.x, width = 40), values = fill)  +
  scale_color_manual(labels = ~ stringr::str_wrap(.x, width = 40), values = fill) +
  ylab("Number of patients") + xlab("") +
  guides(fill = guide_legend(reverse=TRUE, byrow=TRUE)) +
  coord_cartesian(xlim = c(min(as.Date(dtg_type_by_var$start_min_d)), max(as.Date(dtg_type_by_var$end_max_d))))
```

Non-ZAF programs 

```{r echo=FALSE}

dtg_type_by_var %>% 
  filter(country != "ZAF") %>% 
  ggplot(aes(x = dtg_min_pat, y = art_started, fill = sex)) +
  geom_col() +
  facet_grid(vars(program), scales = "free_y") +
  theme_minimal() + 
  labs(fill ="Sex") +
  scale_fill_manual(labels = ~ stringr::str_wrap(.x, width = 40), values = fill)  +
  scale_color_manual(labels = ~ stringr::str_wrap(.x, width = 40), values = fill) +
  ylab("Number of patients") + xlab("") +
  guides(fill = guide_legend(reverse=TRUE, byrow=TRUE)) +
  coord_cartesian(xlim = c(min(as.Date(dtg_type_by_var$start_min_d)), max(as.Date(dtg_type_by_var$end_max_d))))
```


## by country 

```{r echo=FALSE}
dtg_type_by_var = tblBAS %>% 
  filter(dtg_switch == 1) %>%
  group_by(program, country, ctry, dtg_min_pat, sex, start_min_d, end_max_d) %>% 
  summarise(art_started = n()) %>%
  ungroup() %>% 
  mutate(art_started = ifelse(sex == "Female", art_started, art_started * (-1)))
```


```{r echo=FALSE}

dtg_type_by_var %>% 
  ggplot(aes(x = dtg_min_pat, y = art_started, fill = sex)) +
  geom_col() +
  facet_wrap(vars(ctry), nrow = 2, scales = "free_y") +
  theme_minimal() + 
  labs(fill ="Sex") +
  scale_fill_manual(labels = ~ stringr::str_wrap(.x, width = 40), values = fill)  +
  scale_color_manual(labels = ~ stringr::str_wrap(.x, width = 40), values = fill) +
  ylab("Number of patients") + xlab("") +
  guides(fill = guide_legend(reverse=TRUE, byrow=TRUE)) +
  coord_cartesian(xlim = c(min(as.Date(dtg_type_by_var$start_min_d)), max(as.Date(dtg_type_by_var$end_max_d))))
```


```{r echo=FALSE}
dtg_type_by_var %>% 
  ggplot(aes(x = dtg_min_pat, y = art_started, fill = sex)) +
  geom_col() +
  facet_grid(vars(ctry), scales = "free_y") +
  theme_minimal() + 
  labs(fill ="Sex") +
  scale_fill_manual(labels = ~ stringr::str_wrap(.x, width = 40), values = fill)  +
  scale_color_manual(labels = ~ stringr::str_wrap(.x, width = 40), values = fill) +
  ylab("Number of patients") + xlab("") +
  guides(fill = guide_legend(reverse=TRUE, byrow=TRUE)) +
  coord_cartesian(xlim = c(min(as.Date(dtg_type_by_var$start_min_d)), max(as.Date(dtg_type_by_var$end_max_d))))
```


## by age

```{r echo=FALSE} 
dtg_type_by_var = tblBAS %>% 
  filter(dtg_switch == 1) %>%
  group_by(program, country, ctry, age_cat3, dtg_min_pat, sex, start_min_d, end_max_d) %>% 
  summarise(art_started = n()) %>%
  ungroup() %>% 
  mutate(art_started = ifelse(sex == "Female", art_started, art_started * (-1)))
```


```{r echo=FALSE}
dtg_type_by_var %>% 
  ggplot(aes(x = dtg_min_pat, y = art_started, fill = sex)) +
  geom_col() +
  facet_wrap(vars(age_cat3), scales = "free_y", nrow =2) +
  theme_minimal() +
  labs(fill ="Sex") +
  scale_fill_manual(labels = ~ stringr::str_wrap(.x, width = 40), values = fill)  +
  scale_color_manual(labels = ~ stringr::str_wrap(.x, width = 40), values = fill) +
  ylab("Number of patients") + xlab("") +
  guides(fill = guide_legend(reverse=TRUE, byrow=TRUE)) +
  coord_cartesian(xlim = c(min(as.Date(dtg_type_by_var$start_min_d)), max(as.Date(dtg_type_by_var$end_max_d))))
```

```{r eval=FALSE, include=FALSE}
frq(tblBAS, sex)
```


<!-- ----------------------------------------------------- -->

# DTG switch status: number at end of follow-up.

Number that did or didn't switch to DTG over time at end of follow-up.

**Switch to DTG:** follow-up ends one day after DTG switch.   
**No switch to DTG:** follow-up ends at earliest of death, transfer, ltfu or RIC date. 

*Black vertical line is national dtg adoption date.*

## by country

```{r echo=FALSE}
# histogram

tblBAS %>% 
  ggplot(aes(x = end_fu, fill = dtg_switch_txt)) +
  geom_histogram(alpha = 0.8, binwidth = 5, position = "identity") +
  theme_minimal() + 
  facet_wrap(vars(ctry), scales = "free_y") +
  geom_vline(aes(xintercept = dtg_recomend_d)) +
  xlab("FU end (year)") + ylab("Number") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  labs( x='Year', y='Number', title='Number of adults that switched to DTG') +
 scale_fill_manual("Switched to DTG", values = c( "#D55E00", "#56B4E9"),
            guide = guide_legend(reverse = TRUE))

```


## by program

```{r echo=FALSE}
# histogram

tblBAS %>% 
  ggplot(aes(x = end_fu, fill = dtg_switch_txt)) +
  geom_histogram(alpha = 0.8, binwidth = 5, position = "identity") +
  theme_minimal() + 
  facet_wrap(vars(program), scales = "free_y") +
  geom_vline(aes(xintercept = dtg_recomend_d)) +
  xlab("FU end (year)") + ylab("Number") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
   labs( x='Year', y='Number', title='Number of adults that switched to DTG') +
 scale_fill_manual("Switched to DTG", values = c( "#D55E00", "#56B4E9"),
            guide = guide_legend(reverse = TRUE))


```


## by sex

```{r echo=FALSE}
# histogram

tblBAS %>% 
  ggplot(aes(x = end_fu, fill = dtg_switch_txt)) +
  geom_histogram(alpha = 0.8, binwidth = 5, position = "identity") +
  theme_minimal() + 
  facet_wrap(vars(sex_age3), scales = "free_y") +
  geom_vline(aes(xintercept = dtg_recomend_d)) +
  xlab("FU end (year)") + ylab("Number") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
   labs( x='Year', y='Number', title='Number of adults that switched to DTG') +
 scale_fill_manual("Switched to DTG", values = c( "#D55E00", "#56B4E9"),
            guide = guide_legend(reverse = TRUE))

```

<!-- ----------------------------------------------------- -->

# DTG switch status: number at last encounter.

Shows the number of patients and their switch dtg_switch_txt at last encounter date. 

frq(tblBAS, dtg_switch_txt)
## by country

```{r echo=FALSE}
dtg_yn_by_program = tblBAS %>% 
  group_by(program, country, ctry, dtg_switch, last_enc_d, dtg_switch_txt) %>% 
  summarise(art_started = n()) %>% 
  ungroup() %>% 
  mutate(art_started = ifelse(dtg_switch == "1", art_started, art_started * (-1)))
```


```{r echo=FALSE}
dtg_yn_by_program %>% 
  ggplot(aes(x = last_enc_d, y = art_started, fill = dtg_switch_txt)) +
  geom_col() +
  facet_grid(vars(country), scales = "free_y") +
  theme_minimal() + 
  ylab("Number of patients") + xlab("") +
   scale_fill_manual("Switched to DTG", values = c("#D55E00", "#56B4E9"),
            guide = guide_legend(reverse = TRUE))
```


## by program

```{r echo=FALSE}
dtg_yn_by_program = tblBAS %>% 
  group_by(program, country, ctry, dtg_switch, last_enc_d, dtg_switch_txt) %>% 
  summarise(art_started = n()) %>% 
  ungroup() %>% 
  mutate(art_started = ifelse(dtg_switch == "1", art_started, art_started * (-1)))
```


```{r eval=FALSE, include=FALSE}
dtg_yn_by_program %>% 
  filter(program == "AfA") %>% 
  ggplot(aes(x = last_enc_d, y = art_started, fill = dtg_switch_txt)) +
  geom_col() +
  theme_minimal() +
  ylab("Number of patients") + xlab("") +
   scale_fill_manual("Switched to DTG", values = c("#D55E00", "#56B4E9"),
            guide = guide_legend(reverse = TRUE))    

```

ZAF programs

```{r echo=FALSE}
dtg_yn_by_program %>% 
  filter(country == "ZAF") %>% 
 # filter(program != "AfA") %>% 
  ggplot(aes(x = last_enc_d, y = art_started, fill = dtg_switch_txt)) +
  geom_col() +
  facet_grid(vars(program), scales = "free_y") +
  theme_minimal() + 
 ylab("Number of patients") + xlab("") +
   scale_fill_manual("Switched to DTG", values = c("#D55E00", "#56B4E9"),
            guide = guide_legend(reverse = TRUE))    
```

Non-ZAF programs  

```{r echo=FALSE}
dtg_yn_by_program %>% 
  filter(country != "ZAF") %>% 
   ggplot(aes(x = last_enc_d, y = art_started, fill = dtg_switch_txt)) +
  geom_col() +
  facet_grid(vars(program), scales = "free_y") +
  theme_minimal() + 
 ylab("Number of patients") + xlab("") +
   scale_fill_manual("Switched to DTG", values = c("#D55E00", "#56B4E9"),
            guide = guide_legend(reverse = TRUE))      
```



## by sex & age

```{r echo=FALSE}
dtg_yn_by_program = tblBAS %>% 
  group_by(program, country, ctry, sex_age3, dtg_switch, last_enc_d, dtg_switch_txt) %>% 
  summarise(art_started = n()) %>% 
  ungroup() %>% 
  mutate(art_started = ifelse(dtg_switch == "1", art_started, art_started * (-1)))
```


```{r echo=FALSE}
dtg_yn_by_program %>% 
  ggplot(aes(x = last_enc_d, y = art_started, fill = dtg_switch_txt)) +
  geom_col() +
  facet_wrap(vars(sex_age3), nrow= 4, scales = "free_y") +
  theme_minimal() + 
  ylab("Number of patients") + xlab("") +
   scale_fill_manual("Switched to DTG", values = c("#D55E00", "#56B4E9"),
            guide = guide_legend(reverse = TRUE))     
```



<!-- ----------------------------------------------------- -->

# Outcomes: tables

Follow-up start/end dates are defined as follows:  
**Follow-up start for all patients:** begins on DTG adoption data (all patients are on ART at DTG adoption date).
**Follow-up end for patients who switched to DTG:** follow-up ends one day after DTG switch (regardless of later outcome).   
**Follow-up end for patients who do not switch to DTG:** follow-up ends at earliest of death, transfer, LTFU or remained in care (RIC) date without having switched to DTG.  

Definition of LTFU: patients were classified as LTFU if they were >90 days late to their last next scheduled appointment prior to database close date. LTFU date is date of last encounter.  

Transfers and deaths were defined as those recorded in the database.

Definition of RIC: patients were classified RIC if they did not switch to DTG and did not have one of the following outcomes: LTFU, transfer, death. The RIC date was the database close date.


```{r include=FALSE}
table1::label(tblBAS$naive_y) <- "Treatment naive"
table1::label(tblBAS$dtg_status_outcome_txt) <- "Outcome"
table1::label(tblBAS$FU_day) <- "Days of FU"
table1::label(tblBAS$rev_naive_y) <- "Treatment naive"
```

## Overall

```{r echo=FALSE}
#final number of patients
frq(tblBAS, dtg_status_outcome_txt)
```

```{r eval=FALSE, include=FALSE}
sjPlot::tab_xtab(tblBAS$dtg_status_outcome_txt,
                 tblBAS$sex,
                 show.row.prc = TRUE, show.summary = FALSE)
```


## by country

```{r echo=FALSE}
sjPlot::tab_xtab(tblBAS$ctry,
                 tblBAS$dtg_status_outcome_txt,
                 show.row.prc = TRUE, show.summary = FALSE)
```


## by program

```{r echo=FALSE}
sjPlot::tab_xtab(tblBAS$program,
                 tblBAS$dtg_status_outcome_txt,
                 show.row.prc = TRUE, show.summary = FALSE)
```


## by sex

```{r echo=FALSE}
sjPlot::tab_xtab(tblBAS$sex,
                 tblBAS$dtg_status_outcome_txt,
                 show.row.prc = TRUE, show.summary = FALSE)
```


## by sex & age

```{r echo=FALSE}
sjPlot::tab_xtab(tblBAS$sex_age3,
                 tblBAS$dtg_status_outcome_txt,
                 show.row.prc = TRUE, show.summary = FALSE)
```


<!-- ----------------------------------------------------- -->



# KM plots for DTG switch: ggsurvfit

Basic KM plots (cumulative incidence) for the probability of switching to DTG ART.

These plots do not take into account competing risks nor adjust for unreported deaths & silent transfers.  

```{r include=FALSE}

# https://www.emilyzabor.com/tutorials/survival_analysis_in_r_tutorial.html


#install.packages(c("survival", "lubridate", "ggsurvfit", "gtsummary", "tidycmprsk"))

library(survival)
library(lubridate)
library(ggsurvfit)
library(gtsummary)

```


```{r eval=FALSE, include=FALSE}
# https://shariq-mohammed.github.io/files/cbsa2019/1-intro-to-survival.html
```


```{r echo=FALSE}

# https://www.danieldsjoberg.com/ggsurvfit/articles/gallery.html

### survival plot with confidence intervals and at risk data

sf <- survfit2(Surv(time, dtg_switch) ~ 1, data = FU_time) %>% 
  ggsurvfit(type = "risk", linetype_aes = TRUE, linewidth = 1) +
  labs(
    x = "Time since national DTG adoption date (days)",
    y = "Cumulative incidence of no DTG"
  ) + 
  add_confidence_interval() +
  add_risktable() +
  add_quantile(y_value = 0.5, color = "gray50", linewidth = 0.75) 

a <- sf +
  coord_cartesian(xlim = c(0, 1200)) +
 labs(
    y = "Cumulative incidence",
    title = "DTG uptake since start of follow-up",
  ) +
  # reduce padding on edges of figure and format axes
  scale_y_continuous(label = scales::percent, 
                     breaks = seq(0, 1, by = 0.2),
                     expand = c(0.015, 0)) +
  scale_x_continuous(breaks = seq(0, 1200, by = 300), 
                     expand = c(0.02, 0))

a

```


## Probability of DTG switch 

by one month


```{r echo=FALSE}
### One year survival time

survfit(Surv(time, dtg_switch) ~ 1, data = FU_time) %>% 
  tbl_survfit(reverse = TRUE, 
    times = 30.25,
    label_header = "**1-month DTG uptake (95% CI)**"
  )

```

by one year

```{r echo=FALSE}
### One year survival time

survfit(Surv(time,dtg_switch) ~ 1, data = FU_time) %>% 
  tbl_survfit(reverse = TRUE,
    times = 365.25,
    label_header = "**1-year DTG uptake (95% CI)**"
  )

```


by two years

```{r echo=FALSE}
### One year survival time

survfit(Surv(time,dtg_switch) ~ 1, data = FU_time) %>% 
  tbl_survfit(reverse = TRUE,
    times = 730.50, 
    label_header = "**2-year DTG uptake (95% CI)**"
  )

```


<!-- ----------------------------------------------------- -->

# KM plots for DTG switch: ggsurvfit stratified

Basic KM plots (cumulative incidence) for the probability of switching to DTG ART.

These plots do not take into account competing risks nor adjust for unreported deaths & silent transfers.  

## by sex

```{r}

# plot

sf <- survfit2(Surv(time, dtg_switch) ~ sex, data = FU_time)

p <- sf %>% 
  ggsurvfit(type = "risk", linetype_aes = TRUE, linewidth = 1) +
  labs(
    x = "Time since national DTG adoption date (days)",
    y = "Cumulative incidence"
  ) +
  add_quantile(y_value = 0.5, color = "gray50", linewidth = 0.75) +
  add_confidence_interval() +
  annotate("text", x = 1000, y = 0.10, label = glue::glue("{survfit2_p(sf)}"))

  
  # add_censor_mark() +
  # add_confidence_interval() +
  # add_quantile() +
 #  add_risktable()
 # add_pvalue()


## edit with ggplot

p +
  # limit plot to show 8 years and less
  coord_cartesian(xlim = c(0, 1200)) +
  theme(legend.position = "right") +
  # update figure labels/titles
  labs(
    y = "Cumulative incidence",
    title = "DTG switch by sex",
  ) +
  # reduce padding on edges of figure and format axes
  scale_y_continuous(label = scales::percent, 
                     breaks = seq(0, 1, by = 0.2),
                     expand = c(0.015, 0)) +
  scale_x_continuous(breaks = seq(0, 1200, by = 300), 
                     expand = c(0.02, 0)) +
  add_risktable()


#ggsave("test.png", p, height = 6, width = 6)

#ggsave("output/Cohort_transition_outcomes/SA256_KM_DTG_survfit_cohort1_sex.png", width = 7, height =4)

```

```{r eval=FALSE, include=FALSE}

cox <- coxph(Surv(time, dtg_switch) ~ sex, data = FU_time) 
summary(cox)

cox_fit <- survfit(cox)

ggsurvfit(cox_fit)

plot(cox_fit, main = "cph model", xlab="Days")

```


## by age

```{r}

# plot

sf <- survfit2(Surv(time, dtg_switch) ~ age_cat3, data = FU_time)

p <- sf %>% 
  ggsurvfit(type = "risk", linetype_aes = TRUE, linewidth = 1) +
  labs(
    x = "Time since national DTG adoption date (days)",
    y = "Cumulative incidence"
  ) +
  add_confidence_interval() +
  annotate("text", x = 1000, y = 0.10, label = glue::glue("{survfit2_p(sf)}"))

  
  # add_censor_mark() +
  # add_confidence_interval() +
  # add_quantile() +
 #  add_risktable()
 # add_pvalue()


## edit with ggplot

p +
  # limit plot to show 8 years and less
  coord_cartesian(xlim = c(0, 1200)) +
  theme(legend.position = "right") +
  # update figure labels/titles
  labs(
    y = "Cumulative incidence",
    title = "DTG switch by age",
  ) +
  # reduce padding on edges of figure and format axes
  scale_y_continuous(label = scales::percent, 
                     breaks = seq(0, 1, by = 0.2),
                     expand = c(0.015, 0)) +
  scale_x_continuous(breaks = seq(0, 1200, by = 300), 
                     expand = c(0.02, 0)) 

#ggsave("output/Cohort_transition_outcomes/SA256_KM_DTG_survfit_cohort1_age3.png", width = 7, height =4)

```


```{r eval=FALSE, include=FALSE}

# with risk table

survfit2(Surv(time, dtg_switch) ~ age_cat3, data = FU_time) %>% 
  ggsurvfit(type = "risk", linetype_aes = TRUE, linewidth = 1) +
  labs(
    x = "Days",
    y = "Cumulative incidence"
  ) + 
  add_confidence_interval() +
  add_risktable()

```


```{r eval=FALSE, include=FALSE}
### Comparing survival times between groups

survdiff(Surv(time, dtg_switch) ~ age_cat3, data = FU_time)


coxph(Surv(time, dtg_switch) ~ age_cat3, data = FU_time)


coxph(Surv(time, dtg_switch) ~ age_cat3, data = FU_time) %>% 
  tbl_regression(exp = TRUE) 
```



```{r eval=FALSE, include=FALSE}

cox <- coxph(Surv(time, dtg_switch) ~ age_cat3, data = FU_time) 
summary(cox)

cox_fit <- survfit(cox)

ggsurvfit(cox_fit)

plot(cox_fit, main = "cph model", xlab="Days")

```

## by sex & age 

```{r}

# plot

sf <- survfit2(Surv(time, dtg_switch) ~ sex_age2, data = FU_time)

p <- sf %>% 
  ggsurvfit(type = "risk", linetype_aes = TRUE, linewidth = 1) +
  labs(
    x = "Time since national DTG adoption date (days)",
    y = "Cumulative incidence"
  ) +
  add_confidence_interval() +
  annotate("text", x = 1000, y = 0.10, label = glue::glue("{survfit2_p(sf)}"))

  
  # add_censor_mark() +
  # add_confidence_interval() +
  # add_quantile() +
 #  add_risktable()
 # add_pvalue()


## edit with ggplot

p +
  # limit plot to show 8 years and less
  coord_cartesian(xlim = c(0, 1200)) +
    theme(legend.position = "right") +
  # update figure labels/titles
  labs(
    y = "Cumulative incidence",
    title = "KM DTG switch by sex & age",
  ) +
  # reduce padding on edges of figure and format axes
  scale_y_continuous(label = scales::percent, 
                     breaks = seq(0, 1, by = 0.2),
                     expand = c(0.015, 0)) +
  scale_x_continuous(breaks = seq(0, 1200, by = 300), 
                     expand = c(0.02, 0))

ggsave("output/Cohort_transition_outcomes/KM/DTG_switch_KM_DTG_survfit_sex_age.png", width = 7, height =4)

```


```{r eval=FALSE, include=FALSE}

# with risk table

survfit2(Surv(time, dtg_switch) ~ sex_age2, data = FU_time) %>% 
  ggsurvfit(type = "risk", linetype_aes = TRUE, linewidth = 1) +
  labs(
    x = "Days",
    y = "Cumulative incidence"
  ) + 
  add_confidence_interval() +
  add_risktable()

```


```{r eval=FALSE, include=FALSE}
### Comparing survival times between groups

survdiff(Surv(time, dtg_switch) ~ sex_age2, data = FU_time)


coxph(Surv(time, dtg_switch) ~ sex_age2, data = FU_time)


coxph(Surv(time, dtg_switch) ~ sex_age2, data = FU_time) %>% 
  tbl_regression(exp = TRUE) 
```

## by country

```{r}

# plot

sf <- survfit2(Surv(time, dtg_switch) ~ ctry, data = FU_time)

p <- sf %>% 
  ggsurvfit(type = "risk", linetype_aes = TRUE, linewidth = 1) +
  labs(
    x = "Time since national DTG adoption date (days)",
    y = "Cumulative incidence"
  ) +
  add_confidence_interval() +
  annotate("text", x = 1000, y = 0.05, label = glue::glue("{survfit2_p(sf)}"))

  
  # add_censor_mark() +
  # add_confidence_interval() +
  # add_quantile() +
 #  add_risktable()
 # add_pvalue()


## edit with ggplot

p +
  # limit plot to show 8 years and less
  coord_cartesian(xlim = c(0, 1200)) +
    theme(legend.position = "right") +
  # update figure labels/titles
  labs(
    y = "Cumulative incidence",
    title = "DTG switch by country",
  ) +
  # reduce padding on edges of figure and format axes
  scale_y_continuous(label = scales::percent, 
                     breaks = seq(0, 1, by = 0.2),
                     expand = c(0.015, 0)) +
  scale_x_continuous(breaks = seq(0, 1200, by = 300), 
                     expand = c(0.02, 0))

ggsave("output/Cohort_transition_outcomes/KM/SA256_KM_DTG_survfit_Ctry.png", width = 7, height =4)

```




```{r eval=FALSE, include=FALSE}

# with risk table

survfit2(Surv(time, dtg_switch) ~ ctry, data = FU_time) %>% 
  ggsurvfit(type = "risk") +
  labs(
    x = "Days",
    y = "Cumulative incidence"
  ) + 
  add_confidence_interval() +
  add_risktable()

```


```{r eval=FALSE, include=FALSE}
### Comparing survival times between groups

survdiff(Surv(time, dtg_switch) ~ ctry, data = FU_time)


coxph(Surv(time, dtg_switch) ~ ctry, data = FU_time)


coxph(Surv(time, dtg_switch) ~ ctry, data = FU_time) %>% 
  tbl_regression(exp = TRUE) 
```

## by program

```{r}

# plot

sf <- survfit2(Surv(time, dtg_switch) ~ program, data = FU_time)

p <- sf %>% 
  ggsurvfit(type = "risk", linetype_aes = TRUE, linewidth = 1) +
  labs(
    x = "Time since national DTG adoption date (days)",
    y = "Cumulative incidence"
  ) +
  add_confidence_interval() +
  annotate("text", x = 1000, y = 0.05, label = glue::glue("{survfit2_p(sf)}"))

  
  # add_censor_mark() +
  # add_confidence_interval() +
  # add_quantile() +
 #  add_risktable()
 # add_pvalue()


## edit with ggplot

p +
  # limit plot to show 8 years and less
  coord_cartesian(xlim = c(0, 1200)) +
    theme(legend.position = "right") +
  # update figure labels/titles
  labs(
    y = "Cumulative incidence",
    title = "DTG switch by program",
  ) +
  # reduce padding on edges of figure and format axes
  scale_y_continuous(label = scales::percent, 
                     breaks = seq(0, 1, by = 0.2),
                     expand = c(0.015, 0)) +
  scale_x_continuous(breaks = seq(0, 1200, by = 300), 
                     expand = c(0.02, 0))

ggsave("output/Cohort_transition_outcomes/KM/SA256_KM_DTG_survfit_Prog.png", width = 7, height =4)

```


```{r eval=FALSE, include=FALSE}
### Comparing survival times between groups

survdiff(Surv(time,dtg_switch) ~ program, data = FU_time)


coxph(Surv(time, dtg_switch) ~ program, data = FU_time)


coxph(Surv(time, dtg_switch) ~ program, data = FU_time) %>% 
  tbl_regression(exp = TRUE) 
```


## Lesotho by sex & age


```{r eval=FALSE, include=FALSE}
class(FU_time1)

survfit2(Surv(time,dtg_switch) ~ sex_age2, data = FU_time) %>%
  ggsurvfit(type = "risk", linetype_aes = TRUE, linewidth = 1) +
  labs(
    x = "Time since national DTG adoption date (days)",
    y = "Cumulative incidence"
  ) +
  add_confidence_interval() +
  theme(legend.position = "none") +
  scale_x_continuous(n.breaks = 6) +
  labs(title = "PFS by Duration between Surgery and Treatment") 
```


```{r}

temp <- FU_time %>% filter(country == "LSO")


sf <- survfit2(Surv(time, dtg_switch) ~ sex_age2, data = temp)

p <- sf %>% 
  ggsurvfit(type = "risk", linetype_aes = TRUE, linewidth = 1) +
  labs(
    x = "Follow-up time (days)",
    y = "Cumulative incidence"
  ) +
  add_confidence_interval() +
  annotate("text", x = 1000, y = 0.10, label = glue::glue("{survfit2_p(sf)}"))

  
  # add_censor_mark() +
  # add_confidence_interval() +
  # add_quantile() +
 #  add_risktable()
 # add_pvalue()


## edit with ggplot

p +
  # limit plot to show 8 years and less
  coord_cartesian(xlim = c(0, 1200)) +
    theme(legend.position = "right") +
  # update figure labels/titles
  labs(
    y = "Cumulative incidence",
    title = "DTG switch by sex & age",
  ) +
  # reduce padding on edges of figure and format axes
  scale_y_continuous(label = scales::percent, 
                     breaks = seq(0, 1, by = 0.2),
                     expand = c(0.015, 0)) +
  scale_x_continuous(breaks = seq(0, 1200, by = 300), 
                     expand = c(0.02, 0))


#ggsave("output/Cohort_transition_outcomes/KM/SA256_KM_DTG_survfit_Sexage.png", width = 7, height =4)

```


## Malawi by sex & age

```{r}

# plot

temp <- FU_time %>% filter(country == "MWI")


sf <- survfit2(Surv(time, dtg_switch) ~ sex_age2, data = temp)

p <- sf %>% 
  ggsurvfit(type = "risk", linetype_aes = TRUE, linewidth = 1) +
  labs(
    x = "Time since national DTG adoption date (days)",
    y = "Cumulative incidence"
  ) +
  add_confidence_interval() +
  annotate("text", x = 1000, y = 0.10, label = glue::glue("{survfit2_p(sf)}"))

  
  # add_censor_mark() +
  # add_confidence_interval() +
  # add_quantile() +
 #  add_risktable()
 # add_pvalue()


## edit with ggplot

p +
  # limit plot to show 8 years and less
  coord_cartesian(xlim = c(0, 1200)) +
    theme(legend.position = "right") +
  # update figure labels/titles
  labs(
    y = "Cumulative incidence",
    title = "DTG switch by sex & age",
  ) +
  # reduce padding on edges of figure and format axes
  scale_y_continuous(label = scales::percent, 
                     breaks = seq(0, 1, by = 0.2),
                     expand = c(0.015, 0)) +
  scale_x_continuous(breaks = seq(0, 1200, by = 300), 
                     expand = c(0.02, 0))

#ggsave("output/Cohort_transition_outcomes/KM/SA256_KM_DTG_survfit_Sexage.png", width = 7, height =4)

```


## Mozambique by sex & age

```{r}

# plot

temp <- FU_time %>% filter(country == "MOZ")


sf <- survfit2(Surv(time, dtg_switch) ~ sex_age2, data = temp)

p <- sf %>% 
  ggsurvfit(type = "risk", linetype_aes = TRUE, linewidth = 1) +
  labs(
    x = "Time since national DTG adoption date (days)",
    y = "Cumulative incidence"
  ) +
  add_confidence_interval() +
  annotate("text", x = 1000, y = 0.10, label = glue::glue("{survfit2_p(sf)}"))

  
  # add_censor_mark() +
  # add_confidence_interval() +
  # add_quantile() +
 #  add_risktable()
 # add_pvalue()


## edit with ggplot

p +
  # limit plot to show 8 years and less
  coord_cartesian(xlim = c(0, 1200)) +
    theme(legend.position = "right") +
  # update figure labels/titles
  labs(
    y = "Cumulative incidence",
    title = "DTG switch by sex & age",
  ) +
  # reduce padding on edges of figure and format axes
  scale_y_continuous(label = scales::percent, 
                     breaks = seq(0, 1, by = 0.2),
                     expand = c(0.015, 0)) +
  scale_x_continuous(breaks = seq(0, 1200, by = 300), 
                     expand = c(0.02, 0))

#ggsave("output/Cohort_transition_outcomes/SA256_KM_DTG_survfit_Sexage.png", width = 7, height =4)

```

## South Africa by sex & age

```{r}

# plot

temp <- FU_time %>% filter(country == "ZAF")


sf <- survfit2(Surv(time, dtg_switch) ~ sex_age2, data = temp)

p <- sf %>% 
  ggsurvfit(type = "risk", linetype_aes = TRUE, linewidth = 1) +
  labs(
    x = "Time since national DTG adoption date (days)",
    y = "Cumulative incidence"
  ) +
  add_confidence_interval() +
  annotate("text", x = 1000, y = 0.10, label = glue::glue("{survfit2_p(sf)}"))

  
  # add_censor_mark() +
  # add_confidence_interval() +
  # add_quantile() +
 #  add_risktable()
 # add_pvalue()


## edit with ggplot

p +
  # limit plot to show 8 years and less
  coord_cartesian(xlim = c(0, 1200)) +
    theme(legend.position = "right") +
  # update figure labels/titles
  labs(
    y = "Cumulative incidence",
    title = "DTG switch by sex & age",
  ) +
  # reduce padding on edges of figure and format axes
  scale_y_continuous(label = scales::percent, 
                     breaks = seq(0, 1, by = 0.2),
                     expand = c(0.015, 0)) +
  scale_x_continuous(breaks = seq(0, 1200, by = 300), 
                     expand = c(0.02, 0))

#ggsave("output/Cohort_transition_outcomes/SA256_KM_DTG_survfit_Sexage.png", width = 7, height =4)

```

## Zambia by sex & age

```{r}

# plot

temp <- FU_time %>% filter(country == "ZMB")


sf <- survfit2(Surv(time, dtg_switch) ~ sex_age2, data = temp)

p <- sf %>% 
  ggsurvfit(type = "risk", linetype_aes = TRUE, linewidth = 1) +
  labs(
    x = "Time since national DTG adoption date (days)",
    y = "Cumulative incidence"
  ) +
  add_confidence_interval() +
  annotate("text", x = 1000, y = 0.10, label = glue::glue("{survfit2_p(sf)}"))

  
  # add_censor_mark() +
  # add_confidence_interval() +
  # add_quantile() +
 #  add_risktable()
 # add_pvalue()


## edit with ggplot

p +
  # limit plot to show 8 years and less
  coord_cartesian(xlim = c(0, 1200)) +
    theme(legend.position = "right") +
  # update figure labels/titles
  labs(
    y = "Cumulative incidence",
    title = "DTG switch by sex & age",
  ) +
  # reduce padding on edges of figure and format axes
  scale_y_continuous(label = scales::percent, 
                     breaks = seq(0, 1, by = 0.2),
                     expand = c(0.015, 0)) +
  scale_x_continuous(breaks = seq(0, 1200, by = 300), 
                     expand = c(0.02, 0))

#ggsave("output/Cohort_transition_outcomes/SA256_KM_DTG_survfit_Sexage.png", width = 7, height =4)

```


## Zimbabwe by sex & age


```{r}

# plot

temp <- FU_time %>% filter(country == "ZWE")


sf <- survfit2(Surv(time, dtg_switch) ~ sex_age2, data = temp)

p <- sf %>% 
  ggsurvfit(type = "risk", linetype_aes = TRUE, linewidth = 1) +
  labs(
    x = "Time since national DTG adoption date (days)",
    y = "Cumulative incidence"
  ) +
  add_confidence_interval() +
  annotate("text", x = 1000, y = 0.10, label = glue::glue("{survfit2_p(sf)}"))

  
  # add_censor_mark() +
  # add_confidence_interval() +
  # add_quantile() +
 #  add_risktable()
 # add_pvalue()


## edit with ggplot

p +
  # limit plot to show 8 years and less
  coord_cartesian(xlim = c(0, 1200)) +
    theme(legend.position = "right") +
  # update figure labels/titles
  labs(
    y = "Cumulative incidence",
    title = "DTG switch by sex & age",
  ) +
  # reduce padding on edges of figure and format axes
  scale_y_continuous(label = scales::percent, 
                     breaks = seq(0, 1, by = 0.2),
                     expand = c(0.015, 0)) +
  scale_x_continuous(breaks = seq(0, 1200, by = 300), 
                     expand = c(0.02, 0))

#ggsave("output/Cohort_transition_outcomes/SA256_KM_DTG_survfit_Sexage.png", width = 7, height =4)

```


<!-- ----------------------------------------------------- -->

# KM plots for DTG switch: ggsurvplot (by ctry & time)

```{r include=FALSE}
frq(FU_time, dtg_recomend_d)
frq(FU_time, dtg_recomend_t)
```


## by sex

```{r}

fit_t0 = survfit(Surv(time, dtg_switch) ~ sex, data = FU_time)


myplot <- ggsurvplot(fit_t0, data = FU_time, fun = "event",
           censor = FALSE,
           risk.table = FALSE,
           facet.by = "ctry",
           # to remove the heading within the facet.wrap panels
           short.panel.labs = TRUE, 
           ncol = 3, 
           surv.scale = "percent",
           xlab = "Years since national DTG adoption", 
           ylab = "Cumulative incidence of switch to DTG",
           title = "Cumulative incidence of adults switching to DTG by sex", 
           xlim = c(1, 1460), break.x.by = 365,
           legend.title="")

#myplot 

myplot +
  theme_ggsurvfit_default() +
  scale_x_continuous(breaks = c(0, 365,  730, 1095, 1460 ), limits = c(0,1460), 
                        labels = c("0", "1", "2", "3", "4")) + 
  theme(
    axis.title = element_text(size = 12),
   plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 12), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 12), #pad x axis label
          axis.text.x = element_text(size = 12),
          axis.text.y = element_text(size = 12),
          axis.text = element_text(size = 12),
          legend.text = element_text(size = 12),
          legend.title = element_text(size = 12),
          legend.position = "right", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
          strip.background = element_blank(),
         strip.text.x = element_text(size = 12)
  ) +
  guides(color = guide_legend(ncol = 1, reverse = TRUE))  +
  scale_color_manual(values=c('#1a53ff','#b30000'))

ggsave("output/Cohort_transition_outcomes/KM/Survplot_DTG_switch_ctry_sex_time.png", width = 5.5, height =8.5)


```


## by age

```{r}

fit_t0 = survfit(Surv(time, dtg_switch) ~ age_cat3, data = FU_time)


myplot <- ggsurvplot(fit_t0, data = FU_time, fun = "event",
           censor = FALSE,
           risk.table = FALSE,
           facet.by = "ctry",
           # to remove the heading within the facet.wrap panels
           short.panel.labs = TRUE, 
           ncol = 3, 
           surv.scale = "percent",
           xlab = "Years since national DTG adoption", 
           ylab = "Cumulative incidence of switch to DTG",
           title = "Cumulative incidence of adults switching to DTG by age", 
           xlim = c(1, 1460), break.x.by = 365,
           legend.title="")

#myplot 

myplot +
  theme_ggsurvfit_default() +
  scale_x_continuous(breaks = c(0, 365,  730, 1095, 1460 ), limits = c(0,1460), 
                        labels = c("0", "1", "2", "3", "4")) + 
  theme(
    axis.title = element_text(size = 12),
   plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 12), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 12), #pad x axis label
          axis.text.x = element_text(size = 12),
          axis.text.y = element_text(size = 12),
          axis.text = element_text(size = 12),
          legend.text = element_text(size = 12),
          legend.title = element_text(size = 12),
          legend.position = "right", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
          strip.background = element_blank(),
         strip.text.x = element_text(size = 12)
  ) +
  guides(color = guide_legend(ncol = 1, reverse = TRUE))  

ggsave("output/Cohort_transition_outcomes/KM/Survplot_DTG_switch_ctry_age_time.png", width = 5.5, height =8.5)


```


## by sex and age

```{r}

fit_t0 = survfit(Surv(time, dtg_switch) ~ sex_age2, data = FU_time)


myplot <- ggsurvplot(fit_t0, data = FU_time, fun = "event",
           censor = FALSE,
           risk.table = FALSE,
           facet.by = "ctry",
           # to remove the heading within the facet.wrap panels
           short.panel.labs = TRUE, 
           ncol = 3, 
           surv.scale = "percent",
           xlab = "Years since national DTG adoption", 
           ylab = "Cumulative incidence of switch to DTG",
           title = "Cumulative incidence of adults switching to DTG by sex and age", 
           xlim = c(1, 1460), break.x.by = 365,
           legend.title="")

#myplot 

myplot +
  theme_ggsurvfit_default() +
  scale_x_continuous(breaks = c(0, 365,  730, 1095, 1460 ), limits = c(0,1460), 
                        labels = c("0", "1", "2", "3", "4")) + 
  theme(
    axis.title = element_text(size = 12),
   plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 12), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 12), #pad x axis label
          axis.text.x = element_text(size = 12),
          axis.text.y = element_text(size = 12),
          axis.text = element_text(size = 12),
          legend.text = element_text(size = 12),
          legend.title = element_text(size = 12),
          legend.position = "right", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
          strip.background = element_blank(),
         strip.text.x = element_text(size = 12)
  ) +
  guides(color = guide_legend(ncol = 1, reverse = TRUE))  

ggsave("output/Cohort_transition_outcomes/KM/Survplot_DTG_switch_ctry_sexage_time.png", width = 5.5, height =8.5)


```



<!-- ----------------------------------------------------- -->

# KM plots for DTG switch: ggsurvplot (ctry & calendar)

Another r package to make KM plots (cumulative incidence) using calendar time rather than follow-up time.  




```{r}
FU_time1 <- as_tibble(FU_time)

```


```{r eval=FALSE, include=FALSE}
km = survfit(Surv(time = alt_start_fu, 
                  time2 = alt_end_fu,
                  event = dtg_switch_txt, 
                  type = "counting") ~ 1,
             id = patient, 
             data = FU_time)
km

#############################################

fit = survfit(Surv(time = FU_day, 
                   event = dtg_switch, 
                   type = "right") ~ sex,
              data = FU_time)

fit

ggsurvplot(fit, data = FU_time, fun = "event",
           censor = TRUE,
           risk.table = "nrisk_cumevents", risk.table.col = "strata")

####################################################################

# 'counting' type with two dates as numeric 
fit = survfit(Surv(time = as.numeric(start_fu), 
                   time2 = as.numeric(end_fu),
                   event = dtg_switch, 
                   type = "counting") ~ sex,
              data = FU_time)

fit

ggsurvplot(fit, data = FU_time, fun = "event",
           censor = TRUE,
           risk.table = "nrisk_cumevents", risk.table.col = "strata",
           xlim = c(as.numeric(min(FU_time$start_fu)) - 10, NA))

#################################################################

# 'counting' type with two dates rescaled to give correct scale 
fit = survfit(Surv(time = alt_start_fu, 
                   time2 = alt_end_fu,
                   event = dtg_switch, 
                   type = "counting") ~ sex,
              data = FU_time)

fit

ggsurvplot(fit, data = FU_time, fun = "event",
           censor = TRUE,
           risk.table = "nrisk_cumevents", risk.table.col = "Sex",
          facet.by = "ctry",
          xlim = c(min(FU_time$alt_start_fu) - 0.1, NA)) +
         scale_x_continuous(breaks = seq(0, 1200, by = 365), 
         labels = c("2019", "2020", "2021", "2022")) +
       theme(legend.position='right')

# extract results 
#broom::tidy(fit) %>% View()

#fortify(fit) %>% View()

```




```{r include=FALSE}
frq(FU_time, dtg_recomend_t)
frq(FU_time, dtg_switch)
```



## by sex

```{r}
fit_t0 = survfit(Surv(time_t2, dtg_switch) ~ sex , data = FU_time)

#fit_t0 = survfit2(Surv(time_t2, dtg_switch_txt_crr3) ~ sex , data = FU_time)


myplot <- ggsurvplot(fit_t0, data = FU_time, fun = "event",
           censor = FALSE,
           risk.table = FALSE,
           facet.by = "ctry",
           # to remove the heading within the facet.wrap panels
           short.panel.labs = TRUE, 
           ncol = 3, 
           surv.scale = "percent",
           xlab = "", 
           ylab = "Cumulative incidence",
           title = "KM plot for switching to DTG, among adults at risk, by sex", 
           xlim = c(0, 1613), break.x.by = 365,
           legend.title="")

#myplot 

myplot +
  theme_ggsurvfit_default() +
  scale_x_continuous(breaks = c(153, 518, 883, 1248, 1613 ), limits = c(0,1613), 
    labels = c("2019", "2020", "2021", "2022", "2023")) +
  theme(
    axis.title = element_text(size = 12),
   plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 12), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 12), #pad x axis label
          axis.text.x = element_text(size = 12, angle =45, vjust = 0.6, hjust = 0.5),
          axis.text.y = element_text(size = 12),
          axis.text = element_text(size = 12),
          legend.text = element_text(size = 12),
          legend.title = element_text(size = 12),
          legend.position = "right", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
          strip.background = element_blank(),
         strip.text.x = element_text(size = 12)
  ) +
  guides(color = guide_legend(ncol = 1, reverse = TRUE))  +
  scale_color_manual(values=c('#1a53ff','#b30000')) +
  geom_vline(data = FU_time, aes(xintercept = dtg_recomend_t),linetype="dashed") 

ggsave("output/Cohort_transition_outcomes/KM/Survplot_DTG_switch_ctry_sex_calendar.png", width = 7, height =5)


```



## by age

```{r echo=FALSE}
fit = survfit(Surv(time_t2, dtg_switch) ~ age_cat3, data = FU_time)


myplot <- ggsurvplot(fit, data = FU_time, fun = "event",
           censor = FALSE,
           risk.table = FALSE,
           facet.by = "ctry",
           surv.scale = "percent",
           ylab = "Cumulatie incidence",
           xlab = "",
           xlim = c(0, 1613), break.x.by = 300)


## how to get ride of "ctry" within facet?

myplot$plot <- myplot +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
   scale_x_continuous(breaks = c(153, 518, 883, 1248, 1613 ), limits = c(0,1613), 
    labels = c("2019", "2020", "2021", "2022", "2023")) +
  theme(legend.position='right')
  

myplot$plot

#ggsave("test.png", p, height = 6, width = 6)

#ggsave("output/Cohort_transition_outcomes/SA256_KM_DTG_survfit_date_age_cat3_facet_cohort2_ctry.png", width = 9, height =6)

```


## by sex & age

```{r echo=FALSE}
fit = survfit(Surv(time_t2, dtg_switch) ~ sex_age2, data = FU_time)


myplot <- ggsurvplot(fit, data = FU_time, fun = "event",
           censor = FALSE,
           risk.table = FALSE,
           facet.by = "ctry",
           surv.scale = "percent",
           ylab = "Cumulative incidence",
           xlab = "",
           xlim = c(0, 1613), break.x.by = 300)

## how to get ride of "ctry" within facet?

myplot$plot <- myplot +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_continuous(breaks = c(153, 518, 883, 1248, 1613 ), limits = c(0,1613), 
    labels = c("2019", "2020", "2021", "2022", "2023")) +
  theme(legend.position='right')
  

myplot$plot

#ggsave("test.png", p, height = 6, width = 6)

#ggsave("output/Cohort_transition_outcomes/SA256_KM_DTG_survfit_date_sexage_facet_cohort2_ctry.png", width = 12, height =6)

```


<!-- ----------------------------------------------------- -->

# Cox models for multiple covariates
 
## by sex

```{r include=FALSE}
### Comparing survival times between groups

survdiff(Surv(time, dtg_switch) ~ sex, data = FU_time)

coxph(Surv(time, dtg_switch) ~ sex, data = FU_time)

b <- coxph(Surv(time, dtg_switch) ~ sex, data = FU_time)

summary(b)

ph.assump <- cox.zph(b)

ph.assump

survdiff(Surv(time, dtg_switch) ~ sex, data = FU_time)

coxph(Surv(time, dtg_switch) ~ sex, data = FU_time)

```

```{r}

coxph(Surv(time, dtg_switch) ~ sex, data = FU_time) %>% 
  tbl_regression(exp = TRUE) 
```


## by sex & age

```{r include=FALSE}
### Comparing survival times between groups

survdiff(Surv(time, dtg_switch) ~ sex_age2 +  program, data = FU_time)

b <- coxph(Surv(time, dtg_switch) ~ sex_age2 +  program, data = FU_time)

summary(b)

ph.assump <- cox.zph(b)

ph.assump

survdiff(Surv(time, dtg_switch) ~ sex_age2, data = FU_time)

coxph(Surv(time, dtg_switch) ~ sex_age2, data = FU_time)

```

```{r echo=FALSE}
coxph(Surv(time, dtg_switch) ~ sex_age3, data = FU_time) %>% 
  tbl_regression(exp = TRUE) 
```

## by sex & age and country

```{r include=FALSE}
### Comparing survival times between groups

survdiff(Surv(time, dtg_switch) ~ sex_age2 + ctry, data = FU_time)

coxph(Surv(time, dtg_switch) ~ sex_age2 + ctry, data = FU_time)

```

```{r echo=FALSE}
coxph(Surv(time, dtg_switch) ~ sex_age2 + ctry, data = FU_time) %>% 
  tbl_regression(exp = TRUE) 
```


<!-- ----------------------------------------------------- -->

# Competing risks

DTG switch: patient switched to DTG following national adoption of DTG 
competing risks: any reason for censoring (e.g. Death, LTFU, Transfer) prior to DTG switch
No DTG switch:  patients who remained in care and did not switch to DTG


```{r include=FALSE}

#https://argoshare.is.ed.ac.uk/healthyr_book/recode-the-data-1.html

##########################################
# Recode

FU_time <- FU_time %>% mutate(dtg_comp = ifelse(dtg_switch ==0 & dtg_status_outcome_txt != "RIC", 1, 0))

FU_time <- FU_time %>% mutate(dtg_comp_b = ifelse(dtg_switch ==0 & dtg_status_outcome_txt == "RIC", 0, 1))


frq(FU_time, dtg_status_outcome)
frq(FU_time, dtg_status_outcome_txt)
frq(FU_time, dtg_comp)
frq(FU_time, dtg_comp_b)

FU_time = as.data.table(FU_time)

frq(FU_time, dtg_status_outcome)
frq(FU_time, dtg_status_outcome_txt)
frq(FU_time, dtg_switch)  # 1 == started DTG, 0 == didn't start DTG
frq(FU_time, dtg_comp)  # 1 == competing risk; prevented pat from being at risk to start dtg 

FU_time <- FU_time %>% 
  mutate(
    
  # Overall survival (alive ==0,  dtg ==1)
  dtg_switch_txt_os = case_when(
    dtg_switch == 1 ~ 1,  #started DTG
    dtg_switch == 0 ~ 0), #didn't start DTG

  # Diease-specific survival (alive ==0, dtg ==1)
  dtg_switch_txt_dss = case_when(
    dtg_status_outcome == 4 ~ 0, #still alive not on dtg
    dtg_switch == 1 ~ 1,         #started DTG
    dtg_comp == 1 ~ 0),      # censored
  
   # Competing risks regression (alive ==0, dtg ==1, death ==2, ltfu ==3, trans ==4)
  dtg_switch_txt_crr = case_when(
    dtg_status_outcome == 4 ~ 0, # still alive RIC no switch to DTG
    dtg_status_outcome == 0 ~ 1, # switched to DTG                 
    dtg_status_outcome == 1 ~ 2, # had other competing risk outcome Death
    dtg_status_outcome == 2 ~ 3, # had other competing risk outcome LTFU
    dtg_status_outcome == 3 ~ 4), # had other competing risk outcome Transfer
  
     # Competing risks regression (alive ==0, dtg ==1, death ==2, ltfu ==3, trans ==4)
  dtg_switch_txt_crr1b = case_when(
    dtg_status_outcome == 4 ~ 0, # still alive RIC no switch to DTG
    dtg_status_outcome == 0 ~ 4, # switched to DTG                 
    dtg_status_outcome == 1 ~ 1, # had other competing risk outcome Death
    dtg_status_outcome == 2 ~ 3, # had other competing risk outcome LTFU
    dtg_status_outcome == 3 ~ 2), # had other competing risk outcome Transfer

 # Competing risks regression (alive ==0, dtg ==1, all competing risks ==2)
  dtg_switch_txt_crr2 = case_when( 
    dtg_status_outcome == 4 ~ 0, # still alive RIC no switch to DTG
    dtg_status_outcome == 0 ~ 1, # switched to DTG                 
    dtg_status_outcome == 1 ~ 2, # had other competing risk outcome Death
    dtg_status_outcome == 2 ~ 2, # had other competing risk outcome LTFU
    dtg_status_outcome == 3 ~ 2), # had other competing risk outcome Transfer
   

 # Competing risks regression (alive ==0, dtg ==1, all competing risks ==0)
  dtg_switch_txt_crr3 = case_when( 
    dtg_status_outcome == 4 ~ 0, # still alive RIC no switch to DTG
    dtg_status_outcome == 0 ~ 1, # switched to DTG                 
    dtg_status_outcome == 1 ~ 0, # had other competing risk outcome Death
    dtg_status_outcome == 2 ~ 0, # had other competing risk outcome LTFU
    dtg_status_outcome == 3 ~ 0), # had other competing risk outcome Transfer
   ) 



# factor variables
FU_time$dtg_switch_txt_crr.factor <- factor(FU_time$dtg_switch_txt_crr, 
levels=c("0", "1", "2", "3", "4"),
labels = c("No DTG", "DTG switch", "Death", "LTFU", "Transfer"))

FU_time$dtg_switch_txt_crr1b.factor <- factor(FU_time$dtg_switch_txt_crr1b, 
levels=c("0", "1", "2", "3", "4"),
labels = c("a", "b", "c", "d", "e"))

FU_time$dtg_switch_txt_crr2.factor <- factor(FU_time$dtg_switch_txt_crr2,
levels=c("0", "1", "2"),
labels = c("a", "c", "b"))

FU_time$dtg_switch_txt_crr2b.factor <- factor(FU_time$dtg_switch_txt_crr2,
levels=c("0", "1", "2"),
labels = c("RIC", "DTG switch", "competing risks"))

FU_time$dtg_switch_txt_crr3b.factor <- factor(FU_time$dtg_switch_txt_crr3,
levels=c("0", "1"),
labels = c("No Switch", "DTG switch"))



frq(FU_time, dtg_switch_txt_os)
frq(FU_time, dtg_switch_txt_dss)
frq(FU_time, dtg_switch_txt_crr)
frq(FU_time, dtg_switch_txt_crr.factor)
frq(FU_time, dtg_switch_txt_crr2)
frq(FU_time, dtg_switch_txt_crr2.factor)
frq(FU_time, dtg_switch_txt_crr2b.factor)
frq(FU_time, dtg_switch_txt_crr3)
frq(FU_time, dtg_switch_txt_crr3b.factor)
   
```

```{r}
# Label and recode other variables
FU_time <- FU_time %>%
 mutate(sex2 = factor(sex) %>% 
 fct_recode("1" = "Male",
            "0" = "Female")) %>%
  mutate(dtg.factor = factor(dtg_switch))

```

## separate competing events (plot)

```{r}

fit0a = survfit(Surv(time, dtg_comp_b) ~ 1, data = FU_time, etype = dtg_switch_txt_crr)

plot(fit0a, fun = "event", col = c("black", "green", "red", "blue", "orange"), lwd = 2, ylim = c(0, 1), xlim = c(0,1500),
     xlab = "Follow-Up (days)", ylab = "Cumulative Incidence") 
legend("topleft", levels(FU_time$dtg_switch_txt_crr)[2:12], legend = c("Switched to DTG", "No DTG - Death",  "No DTG - LTFU", "No DTG - Transfer"), lty = 1, lwd = 2, col = c("black", "green", "red", "blue", "orange"), bty = "n")


```

## grouping competing events (plot)

Overall

```{r}
fit0b = survfit(Surv(time, dtg_comp_b) ~ 1, data = FU_time, etype = dtg_switch_txt_crr2)

plot(fit0b, fun = "event", col = c("black", "green", "red", "blue", "orange"), lwd = 2, ylim = c(0, 1), xlim = c(0,1500), 
     xlab = "Follow-Up (days)", ylab = "Cumulative Incidence") 
legend("topleft", levels(FU_time$dtg_switch_txt_crr2)[2:12], legend = c("Switched to DTG", "No DTG - competing risks"), lty = 1, lwd = 2, col = c("black", "green", "red", "blue", "orange"), bty = "n") 

```


by sex

```{r}
fit0c = survfit(Surv(time, dtg_comp_b) ~ sex, data = FU_time, etype = dtg_switch_txt_crr2)

plot(fit0c, fun = "event", col = c("blue", "red", "lightblue", "pink"), lwd = 2, ylim = c(0, 1), xlim = c(0,1500), 
     xlab = "Follow-Up (days)", ylab = "Cumulative Incidence") 
legend("topleft", levels(FU_time$dtg_switch_txt_crr2)[2:12], legend = c("M Switched DTG", "F Switched DTG", "M competing risk", "F competing risk"), lty = 1, lwd = 2, col = c("blue", "red", "lightblue", "pink"), bty = "n") 

```






```{r eval=FALSE, include=FALSE}

frq(FU_time, dtg_switch_txt_crr2)
frq(FU_time, dtg_switch_txt_crr2b.factor)
frq(FU_time, dtg_comp_b)

fit_t1 = survfit2(Surv(time_t2, dtg_comp_b) ~ sex , data = FU_time, etype = dtg_switch_txt_crr2.factor)

myplot <- ggsurvplot(fit_t1, data = FU_time, fun = "event", 
           censor = FALSE,
           risk.table = FALSE,
           facet.by = "ctry",
           # to remove the heading within the facet.wrap panels
           short.panel.labs = TRUE, 
           ncol = 1, 
           surv.scale = "percent",
           xlab = "Date", 
           ylab = "Cumulative incidence of switch to DTG",
           title = "Cumulative incidence of adults switching to DTG by sex", 
           xlim = c(0, 1613), break.x.by = 365,
           legend.title="")

myplot 

myplot +
  theme_ggsurvfit_default() +
  scale_x_continuous(breaks = c(153, 518, 883, 1248, 1613 ), limits = c(0,1613), 
    labels = c("2019", "2020", "2021", "2022", "2023")) +
  theme(
    axis.title = element_text(size = 12),
   plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 12), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 12), #pad x axis label
          axis.text.x = element_text(size = 12, angle =0),
          axis.text.y = element_text(size = 12),
          axis.text = element_text(size = 12),
          legend.text = element_text(size = 12),
          legend.title = element_text(size = 12),
          legend.position = "right", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
          strip.background = element_blank(),
         strip.text.x = element_text(size = 12)
  ) +
  guides(color = guide_legend(ncol = 1, reverse = TRUE))  +
  scale_color_manual(values=c('#1a53ff','#b30000')) +
  geom_vline(data = FU_time, aes(xintercept = dtg_recomend_t),linetype="dashed") 

#ggsave("output/Cohort_transition_outcomes/Competing_risks/Survplot_DTG_switch_ctry_sex_calendar.png", width = 5.5, height =8.5)



```


## grouping competing events (ggcuminc)

Using survfit2 and ggcuminc: multistate model Aalen-Johansen estimate (faster method)

- Overall

```{r echo=FALSE}

###################
# using survfit2 : multistate model Aelen-Johansen estimate (fast)
survfit2(Surv(time, dtg_switch_txt_crr2b.factor) ~ 1, data = FU_time) %>%
  ggcuminc(outcome = c("DTG switch", "competing risks")) +
 # ggcuminc(outcome = c("DTG switch")) +
  #add_risktable() +
  add_confidence_interval() +
  ylim(c(0, 1)) + 
  scale_x_continuous(breaks = c(0, 365,  730, 1095), limits = c(0,1095), 
  labels = c("0", "1", "2", "3")) +
    scale_color_manual(values = c( "red", "blue")) +
   labs(
    x = "Time since national DTG adoption date (years)",
    y = "Cumulative incidence"
  ) +
       theme(axis.title = element_text(size = 13),
           axis.text = element_text(size = 13),
           legend.text = element_text(size = 13)) +
  guides(color = guide_legend(ncol = 1)) 


```

<!-- ----------------------------------------------------- -->

# Cumulative incidence DTG switch calendar year (taking into account competing risks)

## by country and sex (calendar year)

```{r include=FALSE}

# LSO

FU_time_temp <- FU_time %>% filter(country =="LSO")


LSO <- survfit2(Surv(time_t2, dtg_switch_txt_crr2b.factor) ~ sex, data = FU_time_temp) %>%
  #ggcuminc(outcome = c("DTG switch", "competing risks")) +
  ggcuminc(outcome = c("DTG switch"), linetype_aes  = FALSE, theme = theme_ggsurvfit_default(), size = 1.5, groups ="country") +
  #add_risktable() +
  #add_confidence_interval() +
  ylim(c(0, 1)) + 
   scale_x_continuous(breaks = c(153, 518, 883, 1248, 1613 ), limits = c(0,1613), 
    labels = c("2019", "2020", "2021", "2022", "2023")) +
    scale_color_manual(values = c( "blue", "red")) +
   labs(
    x = "",
    y = "",
        title = "Lesotho"
  ) +
        theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 1, reverse = FALSE)) +
  geom_vline(data = FU_time_temp, aes(xintercept = dtg_recomend_t),linetype="dashed") 


LSO


# MWI

FU_time_temp <- FU_time %>% filter(country =="MWI")

MWI <- survfit2(Surv(time_t2, dtg_switch_txt_crr2b.factor) ~ sex, data = FU_time_temp) %>%
  ggcuminc(outcome = c("DTG switch"), linetype_aes  = FALSE, theme = theme_ggsurvfit_default(), size = 1.5) +
  ylim(c(0, 1)) + 
   scale_x_continuous(breaks = c(153, 518, 883, 1248, 1613 ), limits = c(0,1613), 
    labels = c("2019", "2020", "2021", "2022", "2023")) +
    scale_color_manual(values = c( "blue", "red")) +
   labs(
    x = "",
    y = "",
        title = "Malawi"
  ) +
        theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 1, reverse = FALSE)) +
  geom_vline(data = FU_time_temp, aes(xintercept = dtg_recomend_t),linetype="dashed") 

MWI




# MOZ

FU_time_temp <- FU_time %>% filter(country =="MOZ")

MOZ <- survfit2(Surv(time_t2, dtg_switch_txt_crr2b.factor) ~ sex, data = FU_time_temp) %>%
   ggcuminc(outcome = c("DTG switch"), linetype_aes  = FALSE, theme = theme_ggsurvfit_default(), size = 1.5) +
  ylim(c(0, 1)) + 
  scale_x_continuous(breaks = c(153, 518, 883, 1248, 1613 ), limits = c(0,1613), 
    labels = c("2019", "2020", "2021", "2022", "2023")) +
   scale_color_manual(values = c( "blue", "red")) +
   labs(
    x = "",
    y = "Cumulative incidence",
        title = "Mozambique"
  ) +
        theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 1, reverse = FALSE)) +
  geom_vline(data = FU_time_temp, aes(xintercept = dtg_recomend_t),linetype="dashed") 

MOZ


# ZAF

FU_time_temp <- FU_time %>% filter(country =="ZAF")

ZAF <- survfit2(Surv(time_t2, dtg_switch_txt_crr2b.factor) ~ sex, data = FU_time_temp) %>%
   ggcuminc(outcome = c("DTG switch"), linetype_aes  = FALSE, theme = theme_ggsurvfit_default(), size = 1.5) +
  ylim(c(0, 1)) + 
   scale_x_continuous(breaks = c(153, 518, 883, 1248, 1613 ), limits = c(0,1613), 
    labels = c("2019", "2020", "2021", "2022", "2023")) +
   scale_color_manual(values = c( "blue", "red")) +
   labs(
    x = "",
    y = "",
    title = "South Africa"
  ) +
  theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5, size = 14), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 1, reverse = FALSE)) +
  geom_vline(data = FU_time_temp, aes(xintercept = dtg_recomend_t),linetype="dashed") 

ZAF


# ZMB

FU_time_temp <- FU_time %>% filter(country =="ZMB")

ZMB <- survfit2(Surv(time_t2, dtg_switch_txt_crr2b.factor) ~ sex, data = FU_time_temp) %>%
  ggcuminc(outcome = c("DTG switch"), linetype_aes  = FALSE, theme = theme_ggsurvfit_default(), size = 1.5) +
  ylim(c(0, 1)) + 
  scale_x_continuous(breaks = c(153, 518, 883, 1248, 1613 ), limits = c(0,1613), 
    labels = c("2019", "2020", "2021", "2022", "2023")) +
   scale_color_manual(values = c( "blue", "red")) +
   labs(
    x = "",
    y = "",
    title = "Zambia"
  ) +
  theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5, size = 14), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 1, reverse = FALSE)) +
  geom_vline(data = FU_time_temp, aes(xintercept = dtg_recomend_t),linetype="dashed") 

ZMB


# ZWE

FU_time_temp <- FU_time %>% filter(country =="ZWE")

ZWE <- survfit2(Surv(time_t2, dtg_switch_txt_crr2b.factor) ~ sex, data = FU_time_temp) %>%
  ggcuminc(outcome = c("DTG switch"), linetype_aes  = FALSE, theme = theme_ggsurvfit_default(), size = 1.5) +
  ylim(c(0, 1)) + 
  scale_x_continuous(breaks = c(153, 518, 883, 1248, 1613 ), limits = c(0,1613), 
    labels = c("2019", "2020", "2021", "2022", "2023")) +
   scale_color_manual(values = c( "blue", "red")) +
   labs(
    x = "",
    y = "",
    title = "Zimbabwe"
  ) +
  theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5, size = 14), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 1, reverse = FALSE)) +
  geom_vline(data = FU_time_temp, aes(xintercept = dtg_recomend_t),linetype="dashed") 

ZWE

```

```{r}
plot <- ggarrange(LSO, MWI, MOZ, ZAF, ZMB, ZWE, ncol =2, nrow =3, common.legend = TRUE, legend = "right") 

annotate_figure(plot, top = text_grob("Cumulative incidence of DTG switch among all on ART at national DTG adoption", color = "black", face = "bold", size = 11))


ggsave("output/Cohort_transition_outcomes/Competing_risks/combine_DTG_Cumul_incid_DTG_switch_ctry_sex_calendar.png", width = 7, height =8)
```

## by country and sex 20-50 years (calendar year)

```{r include=FALSE}

# LSO

FU_time_temp <- FU_time %>% filter(country =="LSO" & age_cat2=="[20,50)")


LSO <- survfit2(Surv(time_t2, dtg_switch_txt_crr2b.factor) ~ sex, data = FU_time_temp) %>%
  #ggcuminc(outcome = c("DTG switch", "competing risks")) +
  ggcuminc(outcome = c("DTG switch"), linetype_aes  = FALSE, theme = theme_ggsurvfit_default(), size = 1.5, groups ="country") +
  #add_risktable() +
  #add_confidence_interval() +
  ylim(c(0, 1)) + 
  scale_x_continuous(breaks = c(153, 518, 883, 1248, 1613 ), limits = c(0,1613), 
    labels = c("2019", "2020", "2021", "2022", "2023")) +
    scale_color_manual(values = c( "blue", "red")) +
   labs(
    x = "",
    y = "",
        title = "Lesotho"
  ) +
        theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 1, reverse = FALSE)) +
  geom_vline(data = FU_time_temp, aes(xintercept = dtg_recomend_t),linetype="dashed") 


LSO


# MWI

FU_time_temp <- FU_time %>% filter(country =="MWI" & age_cat2=="[20,50)")

MWI <- survfit2(Surv(time_t2, dtg_switch_txt_crr2b.factor) ~ sex, data = FU_time_temp) %>%
  ggcuminc(outcome = c("DTG switch"), linetype_aes  = FALSE, theme = theme_ggsurvfit_default(), size = 1.5) +
  ylim(c(0, 1)) + 
  scale_x_continuous(breaks = c(153, 518, 883, 1248, 1613 ), limits = c(0,1613), 
    labels = c("2019", "2020", "2021", "2022", "2023")) +
    scale_color_manual(values = c( "blue", "red")) +
   labs(
    x = "",
    y = "",
        title = "Malawi"
  ) +
        theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 1, reverse = FALSE)) +
  geom_vline(data = FU_time_temp, aes(xintercept = dtg_recomend_t),linetype="dashed") 

MWI




# MOZ

FU_time_temp <- FU_time %>% filter(country =="MOZ" & age_cat2=="[20,50)")

MOZ <- survfit2(Surv(time_t2, dtg_switch_txt_crr2b.factor) ~ sex, data = FU_time_temp) %>%
   ggcuminc(outcome = c("DTG switch"), linetype_aes  = FALSE, theme = theme_ggsurvfit_default(), size = 1.5) +
  ylim(c(0, 1)) + 
   scale_x_continuous(breaks = c(153, 518, 883, 1248, 1613 ), limits = c(0,1613), 
    labels = c("2019", "2020", "2021", "2022", "2023")) +
   scale_color_manual(values = c( "blue", "red")) +
   labs(
    x = "",
    y = "Cumulative incidence",
        title = "Mozambique"
  ) +
        theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 1, reverse = FALSE)) +
  geom_vline(data = FU_time_temp, aes(xintercept = dtg_recomend_t),linetype="dashed") 

MOZ


# ZAF

FU_time_temp <- FU_time %>% filter(country =="ZAF" & age_cat2=="[20,50)")
 
ZAF <- survfit2(Surv(time_t2, dtg_switch_txt_crr2b.factor) ~ sex, data = FU_time_temp) %>%
   ggcuminc(outcome = c("DTG switch"), linetype_aes  = FALSE, theme = theme_ggsurvfit_default(), size = 1.5) +
  ylim(c(0, 1)) + 
   scale_x_continuous(breaks = c(153, 518, 883, 1248, 1613 ), limits = c(0,1613), 
    labels = c("2019", "2020", "2021", "2022", "2023")) +
   scale_color_manual(values = c( "blue", "red")) +
   labs(
    x = "",
    y = "",
    title = "South Africa"
  ) +
  theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5, size = 14), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 1, reverse = FALSE)) +
  geom_vline(data = FU_time_temp, aes(xintercept = dtg_recomend_t),linetype="dashed") 

ZAF


# ZMB

FU_time_temp <- FU_time %>% filter(country =="ZMB" & age_cat2=="[20,50)")

ZMB <- survfit2(Surv(time_t2, dtg_switch_txt_crr2b.factor) ~ sex, data = FU_time_temp) %>%
  ggcuminc(outcome = c("DTG switch"), linetype_aes  = FALSE, theme = theme_ggsurvfit_default(), size = 1.5) +
  ylim(c(0, 1)) + 
  scale_x_continuous(breaks = c(153, 518, 883, 1248, 1613 ), limits = c(0,1613), 
    labels = c("2019", "2020", "2021", "2022", "2023")) +
   scale_color_manual(values = c( "blue", "red")) +
   labs(
    x = "",
    y = "",
    title = "Zambia"
  ) +
  theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5, size = 14), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 1, reverse = FALSE)) +
  geom_vline(data = FU_time_temp, aes(xintercept = dtg_recomend_t),linetype="dashed") 

ZMB


# ZWE

FU_time_temp <- FU_time %>% filter(country =="ZWE" & age_cat2=="[20,50)")

ZWE <- survfit2(Surv(time_t2, dtg_switch_txt_crr2b.factor) ~ sex, data = FU_time_temp) %>%
  ggcuminc(outcome = c("DTG switch"), linetype_aes  = FALSE, theme = theme_ggsurvfit_default(), size = 1.5) +
  ylim(c(0, 1)) + 
  scale_x_continuous(breaks = c(153, 518, 883, 1248, 1613 ), limits = c(0,1613), 
    labels = c("2019", "2020", "2021", "2022", "2023")) +
   scale_color_manual(values = c( "blue", "red")) +
   labs(
    x = "",
    y = "",
    title = "Zimbabwe"
  ) +
  theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5, size = 14), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 1, reverse = FALSE)) +
  geom_vline(data = FU_time_temp, aes(xintercept = dtg_recomend_t),linetype="dashed") 

ZWE

```

```{r}
plot <- ggarrange(LSO, MWI, MOZ, ZAF, ZMB, ZWE, ncol =2, nrow =3, common.legend = TRUE, legend = "right") 

annotate_figure(plot, top = text_grob("Cumulative incidence of DTG switch among 20-50 yrs old on ART at national DTG adoption", color = "black", face = "bold", size = 11))


ggsave("output/Cohort_transition_outcomes/Competing_risks/combine_DTG_Cumul_incid_DTG_switch_ctry_sex20-50_calendar.png", width = 7, height =8)
```


## by country and sex 20-40 years (calendar year)

```{r include=FALSE}

# LSO
#frq(FU_time, age_cat3)

FU_time_temp <- FU_time %>% filter(country =="LSO" & age_cat3!="[40,50)" & age_cat3 != "[50,100]")


LSO <- survfit2(Surv(time_t2, dtg_switch_txt_crr2b.factor) ~ sex, data = FU_time_temp) %>%
  #ggcuminc(outcome = c("DTG switch", "competing risks")) +
  ggcuminc(outcome = c("DTG switch"), linetype_aes  = FALSE, theme = theme_ggsurvfit_default(), size = 1.5, groups ="country") +
  #add_risktable() +
  #add_confidence_interval() +
  ylim(c(0, 1)) + 
   scale_x_continuous(breaks = c(153, 518, 883, 1248, 1613 ), limits = c(0,1613), 
    labels = c("2019", "2020", "2021", "2022", "2023")) +
    scale_color_manual(values = c( "blue", "red")) +
   labs(
    x = "",
    y = "",
        title = "Lesotho"
  ) +
        theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 1, reverse = FALSE)) +
  geom_vline(data = FU_time_temp, aes(xintercept = dtg_recomend_t),linetype="dashed") 


LSO


# MWI

FU_time_temp <- FU_time %>% filter(country =="MWI" & age_cat3!="[40,50)" & age_cat3 != "[50,100]")

MWI <- survfit2(Surv(time_t2, dtg_switch_txt_crr2b.factor) ~ sex, data = FU_time_temp) %>%
  ggcuminc(outcome = c("DTG switch"), linetype_aes  = FALSE, theme = theme_ggsurvfit_default(), size = 1.5) +
  ylim(c(0, 1)) + 
   scale_x_continuous(breaks = c(153, 518, 883, 1248, 1613 ), limits = c(0,1613), 
    labels = c("2019", "2020", "2021", "2022", "2023")) +
    scale_color_manual(values = c( "blue", "red")) +
   labs(
    x = "",
    y = "",
        title = "Malawi"
  ) +
        theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 1, reverse = FALSE)) +
  geom_vline(data = FU_time_temp, aes(xintercept = dtg_recomend_t),linetype="dashed") 

MWI




# MOZ

FU_time_temp <- FU_time %>% filter(country =="MOZ" & age_cat3!="[40,50)" & age_cat3 != "[50,100]")

MOZ <- survfit2(Surv(time_t2, dtg_switch_txt_crr2b.factor) ~ sex, data = FU_time_temp) %>%
   ggcuminc(outcome = c("DTG switch"), linetype_aes  = FALSE, theme = theme_ggsurvfit_default(), size = 1.5) +
  ylim(c(0, 1)) + 
  scale_x_continuous(breaks = c(153, 518, 883, 1248, 1613 ), limits = c(0,1613), 
    labels = c("2019", "2020", "2021", "2022", "2023")) +
   scale_color_manual(values = c( "blue", "red")) +
   labs(
    x = "",
    y = "Cumulative incidence",
        title = "Mozambique"
  ) +
        theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 1, reverse = FALSE)) +
  geom_vline(data = FU_time_temp, aes(xintercept = dtg_recomend_t),linetype="dashed") 

MOZ


# ZAF

FU_time_temp <- FU_time %>% filter(country =="ZAF" & age_cat3!="[40,50)" & age_cat3 != "[50,100]")
 
ZAF <- survfit2(Surv(time_t2, dtg_switch_txt_crr2b.factor) ~ sex, data = FU_time_temp) %>%
   ggcuminc(outcome = c("DTG switch"), linetype_aes  = FALSE, theme = theme_ggsurvfit_default(), size = 1.5) +
  ylim(c(0, 1)) + 
 scale_x_continuous(breaks = c(153, 518, 883, 1248, 1613 ), limits = c(0,1613), 
    labels = c("2019", "2020", "2021", "2022", "2023")) +
   scale_color_manual(values = c( "blue", "red")) +
   labs(
    x = "",
    y = "",
    title = "South Africa"
  ) +
  theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5, size = 14), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 1, reverse = FALSE)) +
  geom_vline(data = FU_time_temp, aes(xintercept = dtg_recomend_t),linetype="dashed") 

ZAF


# ZMB

FU_time_temp <- FU_time %>% filter(country =="ZMB" & age_cat3!="[40,50)" & age_cat3 != "[50,100]")

ZMB <- survfit2(Surv(time_t2, dtg_switch_txt_crr2b.factor) ~ sex, data = FU_time_temp) %>%
  ggcuminc(outcome = c("DTG switch"), linetype_aes  = FALSE, theme = theme_ggsurvfit_default(), size = 1.5) +
  ylim(c(0, 1)) + 
  scale_x_continuous(breaks = c(153, 518, 883, 1248, 1613 ), limits = c(0,1613), 
    labels = c("2019", "2020", "2021", "2022", "2023")) +
   scale_color_manual(values = c( "blue", "red")) +
   labs(
    x = "",
    y = "",
    title = "Zambia"
  ) +
  theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5, size = 14), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 1, reverse = FALSE)) +
  geom_vline(data = FU_time_temp, aes(xintercept = dtg_recomend_t),linetype="dashed") 

ZMB


# ZWE

FU_time_temp <- FU_time %>% filter(country =="ZWE" & age_cat3!="[40,50)" & age_cat3 != "[50,100]")

ZWE <- survfit2(Surv(time_t2, dtg_switch_txt_crr2b.factor) ~ sex, data = FU_time_temp) %>%
  ggcuminc(outcome = c("DTG switch"), linetype_aes  = FALSE, theme = theme_ggsurvfit_default(), size = 1.5) +
  ylim(c(0, 1)) + 
  scale_x_continuous(breaks = c(153, 518, 883, 1248, 1613 ), limits = c(0,1613), 
    labels = c("2019", "2020", "2021", "2022", "2023")) +
   scale_color_manual(values = c( "blue", "red")) +
   labs(
    x = "",
    y = "",
    title = "Zimbabwe"
  ) +
  theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5, size = 14), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 1, reverse = FALSE)) +
  geom_vline(data = FU_time_temp, aes(xintercept = dtg_recomend_t),linetype="dashed") 

ZWE

```

```{r}
plot <- ggarrange(LSO, MWI, MOZ, ZAF, ZMB, ZWE, ncol =2, nrow =3, common.legend = TRUE, legend = "right") 

annotate_figure(plot, top = text_grob("Cumulative incidence of DTG switch among 20-40 yrs old adults on ART at national DTG adoption", color = "black", face = "bold", size = 11))


ggsave("output/Cohort_transition_outcomes/Competing_risks/combine_DTG_Cumul_incid_DTG_switch_ctry_sex20-40_calendar.png", width = 7, height =8)
```


## by country and sex & age (calendar year)

```{r include=FALSE}

# LSO
#frq(FU_time, age_cat3)


FU_time <- FU_time %>%
  mutate(sex_age2_txt = ifelse(sex_age2 =="Male.[20,50)", "Male 20-49",
                               ifelse(sex_age2 =="Female.[20,50)", "Female 20-49",
                                    ifelse(sex_age2 =="Male.[50,100]", "Male 50+",
                                         ifelse(sex_age2 =="Female.[50,100]", "Female 50+", "other"
                                      )))))

FU_time_temp <- FU_time %>% filter(country =="LSO")


LSO <- survfit2(Surv(time_t2, dtg_switch_txt_crr2b.factor) ~ sex_age2_txt, data = FU_time_temp) %>%
  #ggcuminc(outcome = c("DTG switch", "competing risks")) +
  ggcuminc(outcome = c("DTG switch"), linetype_aes  = FALSE, theme = theme_ggsurvfit_default(), size = 1.5, groups ="country") +
  #add_risktable() +
  #add_confidence_interval() +
  ylim(c(0, 1)) + 
   scale_x_continuous(breaks = c(153, 518, 883, 1248, 1613 ), limits = c(0,1613), 
    labels = c("2019", "2020", "2021", "2022", "2023")) +
     scale_color_manual(values = c( "#F4B942", "#97D8C4",  "#6B9AC4", "#4059AD")) +
   labs(
    x = "",
    y = "",
        title = "Lesotho"
  ) +
        theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 2, reverse = FALSE)) +
  geom_vline(data = FU_time_temp, aes(xintercept = dtg_recomend_t),linetype="dashed") 


LSO


# MWI

FU_time_temp <- FU_time %>% filter(country =="MWI")

MWI <- survfit2(Surv(time_t2, dtg_switch_txt_crr2b.factor) ~ sex_age2_txt, data = FU_time_temp) %>%
  ggcuminc(outcome = c("DTG switch"), linetype_aes  = FALSE, theme = theme_ggsurvfit_default(), size = 1.5) +
  ylim(c(0, 1)) + 
   scale_x_continuous(breaks = c(153, 518, 883, 1248, 1613 ), limits = c(0,1613), 
    labels = c("2019", "2020", "2021", "2022", "2023")) +
         scale_color_manual(values = c( "#F4B942", "#97D8C4",  "#6B9AC4", "#4059AD")) +
   labs(
    x = "",
    y = "",
        title = "Malawi"
  ) +
        theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 2, reverse = FALSE)) +
  geom_vline(data = FU_time_temp, aes(xintercept = dtg_recomend_t),linetype="dashed") 

MWI




# MOZ

FU_time_temp <- FU_time %>% filter(country =="MOZ")

MOZ <- survfit2(Surv(time_t2, dtg_switch_txt_crr2b.factor) ~ sex_age2_txt, data = FU_time_temp) %>%
   ggcuminc(outcome = c("DTG switch"), linetype_aes  = FALSE, theme = theme_ggsurvfit_default(), size = 1.5) +
  ylim(c(0, 1)) + 
  scale_x_continuous(breaks = c(153, 518, 883, 1248, 1613 ), limits = c(0,1613), 
    labels = c("2019", "2020", "2021", "2022", "2023")) +
        scale_color_manual(values = c( "#F4B942", "#97D8C4",  "#6B9AC4", "#4059AD")) +
   labs(
    x = "",
    y = "Cumulative incidence",
        title = "Mozambique"
  ) +
        theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 2, reverse = FALSE)) +
  geom_vline(data = FU_time_temp, aes(xintercept = dtg_recomend_t),linetype="dashed") 

MOZ


# ZAF

FU_time_temp <- FU_time %>% filter(country =="ZAF")
 
ZAF <- survfit2(Surv(time_t2, dtg_switch_txt_crr2b.factor) ~ sex_age2_txt, data = FU_time_temp) %>%
   ggcuminc(outcome = c("DTG switch"), linetype_aes  = FALSE, theme = theme_ggsurvfit_default(), size = 1.5) +
  ylim(c(0, 1)) + 
   scale_x_continuous(breaks = c(153, 518, 883, 1248, 1613 ), limits = c(0,1613), 
    labels = c("2019", "2020", "2021", "2022", "2023")) +
        scale_color_manual(values = c( "#F4B942", "#97D8C4",  "#6B9AC4", "#4059AD")) +
   labs(
    x = "",
    y = "",
    title = "South Africa"
  ) +
  theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5, size = 14), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 2, reverse = FALSE)) +
  geom_vline(data = FU_time_temp, aes(xintercept = dtg_recomend_t),linetype="dashed") 

ZAF


# ZMB

FU_time_temp <- FU_time %>% filter(country =="ZMB")

ZMB <- survfit2(Surv(time_t2, dtg_switch_txt_crr2b.factor) ~ sex_age2_txt, data = FU_time_temp) %>%
  ggcuminc(outcome = c("DTG switch"), linetype_aes  = FALSE, theme = theme_ggsurvfit_default(), size = 1.5) +
  ylim(c(0, 1)) + 
  scale_x_continuous(breaks = c(153, 518, 883, 1248, 1613 ), limits = c(0,1613), 
    labels = c("2019", "2020", "2021", "2022", "2023")) +
        scale_color_manual(values = c( "#F4B942", "#97D8C4",  "#6B9AC4", "#4059AD")) +
   labs(
    x = "",
    y = "",
    title = "Zambia"
  ) +
  theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5, size = 14), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 2, reverse = FALSE)) +
  geom_vline(data = FU_time_temp, aes(xintercept = dtg_recomend_t),linetype="dashed") 

ZMB


# ZWE

FU_time_temp <- FU_time %>% filter(country =="ZWE")

ZWE <- survfit2(Surv(time_t2, dtg_switch_txt_crr2b.factor) ~ sex_age2_txt, data = FU_time_temp) %>%
  ggcuminc(outcome = c("DTG switch"), linetype_aes  = FALSE, theme = theme_ggsurvfit_default(), size = 1.5) +
  ylim(c(0, 1)) + 
   scale_x_continuous(breaks = c(153, 518, 883, 1248, 1613 ), limits = c(0,1613), 
    labels = c("2019", "2020", "2021", "2022", "2023")) +
       scale_color_manual(values = c( "#F4B942", "#97D8C4",  "#6B9AC4", "#4059AD")) +
   labs(
    x = "",
    y = "",
    title = "Zimbabwe"
  ) +
  theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5, size = 14), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 2, reverse = FALSE)) +
  geom_vline(data = FU_time_temp, aes(xintercept = dtg_recomend_t),linetype="dashed") 

ZWE

```

```{r}
plot <- ggarrange(LSO, MWI, MOZ, ZAF, ZMB, ZWE, ncol =2, nrow =3, common.legend = TRUE, legend = "bottom") 

annotate_figure(plot, top = text_grob("Cumulative incidence of DTG switch among adults on ART at national DTG adoption", color = "black", face = "bold", size = 11))


ggsave("output/Cohort_transition_outcomes/Competing_risks/combine_DTG_Cumul_incid_DTG_switch_ctry_sexage_calendar.png", width = 7, height =8)
```



<!-- ----------------------------------------------------- -->

# Cumulative incidence DTG switch by time (taking into account competing risks)

## by country and sex (time since national adoption)

```{r include=FALSE}

# LSO

FU_time_temp <- FU_time %>% filter(country =="LSO")


LSO <- survfit2(Surv(time, dtg_switch_txt_crr2b.factor) ~ sex, data = FU_time_temp) %>%
  #ggcuminc(outcome = c("DTG switch", "competing risks")) +
  ggcuminc(outcome = c("DTG switch"), linetype_aes  = FALSE, theme = theme_ggsurvfit_default(), size = 1.5, groups ="country") +
  #add_risktable() +
  #add_confidence_interval() +
  ylim(c(0, 1)) + 
  scale_x_continuous(breaks = c(0, 365,  730, 1095, 1460), limits = c(0,1460), 
  labels = c("0", "1", "2", "3", "4")) +
    scale_color_manual(values = c( "blue", "red")) +
   labs(
    x = "",
    y = "",
        title = "Lesotho"
  ) +
        theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 1, reverse = FALSE)) +
  geom_vline(data = FU_time_temp, aes(xintercept = dtg_recomend_d),linetype="dashed") 


LSO


# MWI

FU_time_temp <- FU_time %>% filter(country =="MWI")

MWI <- survfit2(Surv(time, dtg_switch_txt_crr2b.factor) ~ sex, data = FU_time_temp) %>%
  ggcuminc(outcome = c("DTG switch"), linetype_aes  = FALSE, theme = theme_ggsurvfit_default(), size = 1.5) +
  ylim(c(0, 1)) + 
  scale_x_continuous(breaks = c(0, 365,  730, 1095, 1460), limits = c(0,1460), 
 labels = c("0", "1", "2", "3", "4")) +
    scale_color_manual(values = c( "blue", "red")) +
   labs(
    x = "",
    y = "",
        title = "Malawi"
  ) +
        theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 1, reverse = FALSE)) +
  geom_vline(data = FU_time_temp, aes(xintercept = dtg_recomend_d),linetype="dashed") 

MWI




# MOZ

FU_time_temp <- FU_time %>% filter(country =="MOZ")

MOZ <- survfit2(Surv(time, dtg_switch_txt_crr2b.factor) ~ sex, data = FU_time_temp) %>%
   ggcuminc(outcome = c("DTG switch"), linetype_aes  = FALSE, theme = theme_ggsurvfit_default(), size = 1.5) +
  ylim(c(0, 1)) + 
  scale_x_continuous(breaks = c(0, 365,  730, 1095, 1460), limits = c(0,1460), 
 labels = c("0", "1", "2", "3", "4")) +
   scale_color_manual(values = c( "blue", "red")) +
   labs(
    x = "",
    y = "Cumulative incidence",
        title = "Mozambique"
  ) +
        theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 1, reverse = FALSE)) +
  geom_vline(data = FU_time_temp, aes(xintercept = dtg_recomend_d),linetype="dashed") 

MOZ


# ZAF

FU_time_temp <- FU_time %>% filter(country =="ZAF")

ZAF <- survfit2(Surv(time, dtg_switch_txt_crr2b.factor) ~ sex, data = FU_time_temp) %>%
   ggcuminc(outcome = c("DTG switch"), linetype_aes  = FALSE, theme = theme_ggsurvfit_default(), size = 1.5) +
  ylim(c(0, 1)) + 
  scale_x_continuous(breaks = c(0, 365,  730, 1095, 1460), limits = c(0,1460), 
 labels = c("0", "1", "2", "3", "4")) +
   scale_color_manual(values = c( "blue", "red")) +
   labs(
    x = "",
    y = "",
    title = "South Africa"
  ) +
  theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5, size = 14), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 1, reverse = FALSE)) +
  geom_vline(data = FU_time_temp, aes(xintercept = dtg_recomend_d),linetype="dashed") 

ZAF


# ZMB

FU_time_temp <- FU_time %>% filter(country =="ZMB")

ZMB <- survfit2(Surv(time, dtg_switch_txt_crr2b.factor) ~ sex, data = FU_time_temp) %>%
  ggcuminc(outcome = c("DTG switch"), linetype_aes  = FALSE, theme = theme_ggsurvfit_default(), size = 1.5) +
  ylim(c(0, 1)) + 
  scale_x_continuous(breaks = c(0, 365,  730, 1095, 1460), limits = c(0,1460), 
 labels = c("0", "1", "2", "3", "4")) +
   scale_color_manual(values = c( "blue", "red")) +
   labs(
    x = "",
    y = "",
    title = "Zambia"
  ) +
  theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5, size = 14), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 1, reverse = FALSE)) +
  geom_vline(data = FU_time_temp, aes(xintercept = dtg_recomend_d),linetype="dashed") 

ZMB


# ZWE

FU_time_temp <- FU_time %>% filter(country =="ZWE")

ZWE <- survfit2(Surv(time, dtg_switch_txt_crr2b.factor) ~ sex, data = FU_time_temp) %>%
  ggcuminc(outcome = c("DTG switch"), linetype_aes  = FALSE, theme = theme_ggsurvfit_default(), size = 1.5) +
  ylim(c(0, 1)) + 
  scale_x_continuous(breaks = c(0, 365,  730, 1095, 1460), limits = c(0,1460), 
 labels = c("0", "1", "2", "3", "4")) +
   scale_color_manual(values = c( "blue", "red")) +
   labs(
    x = "",
    y = "",
    title = "Zimbabwe"
  ) +
  theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5, size = 14), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 1, reverse = FALSE)) +
  geom_vline(data = FU_time_temp, aes(xintercept = dtg_recomend_d),linetype="dashed") 

ZWE

```

```{r}
plot <- ggarrange(LSO, MWI, MOZ, ZAF, ZMB, ZWE, ncol =2, nrow =3, common.legend = TRUE, legend = "right") 

annotate_figure(plot, top = text_grob("Cumulative incidence of DTG switch among all on ART at national DTG adoption", color = "black", face = "bold", size = 11))


ggsave("output/Cohort_transition_outcomes/Competing_risks/combine_DTG_Cumul_incid_DTG_switch_ctry_sex_time.png", width = 7, height =8)
```




## by country and sex & age (time since national adoption)

```{r include=FALSE}

# LSO
#frq(FU_time, sex_age2)

FU_time <- FU_time %>%
  mutate(sex_age2_txt = ifelse(sex_age2 =="Male.[20,50)", "Male 20-49",
                               ifelse(sex_age2 =="Female.[20,50)", "Female 20-49",
                                    ifelse(sex_age2 =="Male.[50,100]", "Male 50+",
                                         ifelse(sex_age2 =="Female.[50,100]", "Female 50+", "other"
                                      )))))


FU_time_temp <- FU_time %>% filter(country =="LSO") 


LSO <- survfit2(Surv(time_t2, dtg_switch_txt_crr2b.factor) ~ sex_age2_txt, data = FU_time_temp) %>%
  #ggcuminc(outcome = c("DTG switch", "competing risks")) +
  ggcuminc(outcome = c("DTG switch"), linetype_aes  = FALSE, theme = theme_ggsurvfit_default(), size = 1.5, groups ="country") +
  #add_risktable() +
  #add_confidence_interval() +
  ylim(c(0, 1)) + 
   scale_x_continuous(breaks = c(0, 365,  730, 1095, 1460), limits = c(0,1460), 
 labels = c("0", "1", "2", "3", "4")) +
    scale_color_manual(values = c( "#F4B942", "#97D8C4",  "#6B9AC4", "#4059AD")) +
   labs(
    x = "",
    y = "",
        title = "Lesotho"
  ) +
        theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 2, reverse = FALSE)) +
  geom_vline(data = FU_time_temp, aes(xintercept = dtg_recomend_d),linetype="dashed") 


LSO


# MWI

FU_time_temp <- FU_time %>% filter(country =="MWI")

MWI <- survfit2(Surv(time, dtg_switch_txt_crr2b.factor) ~ sex_age2_txt, data = FU_time_temp) %>%
  ggcuminc(outcome = c("DTG switch"), linetype_aes  = FALSE, theme = theme_ggsurvfit_default(), size = 1.5) +
  ylim(c(0, 1)) + 
  scale_x_continuous(breaks = c(0, 365,  730, 1095, 1460), limits = c(0,1460), 
 labels = c("0", "1", "2", "3", "4")) +
   scale_color_manual(values = c( "#F4B942", "#97D8C4",  "#6B9AC4", "#4059AD")) +
   labs(
    x = "",
    y = "",
        title = "Malawi"
  ) +
        theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 2, reverse = FALSE)) +
  geom_vline(data = FU_time_temp, aes(xintercept = dtg_recomend_d),linetype="dashed") 

MWI




# MOZ

FU_time_temp <- FU_time %>% filter(country =="MOZ")

MOZ <- survfit2(Surv(time, dtg_switch_txt_crr2b.factor) ~ sex_age2_txt, data = FU_time_temp) %>%
   ggcuminc(outcome = c("DTG switch"), linetype_aes  = FALSE, theme = theme_ggsurvfit_default(), size = 1.5) +
  ylim(c(0, 1)) + 
  scale_x_continuous(breaks = c(0, 365,  730, 1095, 1460), limits = c(0,1460), 
 labels = c("0", "1", "2", "3", "4")) +
  scale_color_manual(values = c( "#F4B942", "#97D8C4",  "#6B9AC4", "#4059AD")) +
   labs(
    x = "",
    y = "Cumulative incidence",
        title = "Mozambique"
  ) +
        theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 2, reverse = FALSE)) +
  geom_vline(data = FU_time_temp, aes(xintercept = dtg_recomend_d),linetype="dashed") 

MOZ


# ZAF

FU_time_temp <- FU_time %>% filter(country =="ZAF")

ZAF <- survfit2(Surv(time, dtg_switch_txt_crr2b.factor) ~ sex_age2_txt, data = FU_time_temp) %>%
   ggcuminc(outcome = c("DTG switch"), linetype_aes  = FALSE, theme = theme_ggsurvfit_default(), size = 1.5) +
  ylim(c(0, 1)) + 
  scale_x_continuous(breaks = c(0, 365,  730, 1095, 1460), limits = c(0,1460), 
 labels = c("0", "1", "2", "3", "4")) +
  scale_color_manual(values = c( "#F4B942", "#97D8C4",  "#6B9AC4", "#4059AD")) +
   labs(
    x = "",
    y = "",
    title = "South Africa"
  ) +
  theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5, size = 14), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 2, reverse = FALSE)) +
  geom_vline(data = FU_time_temp, aes(xintercept = dtg_recomend_d),linetype="dashed") 

ZAF


# ZMB

FU_time_temp <- FU_time %>% filter(country =="ZMB")

ZMB <- survfit2(Surv(time, dtg_switch_txt_crr2b.factor) ~ sex_age2_txt, data = FU_time_temp) %>%
  ggcuminc(outcome = c("DTG switch"), linetype_aes  = FALSE, theme = theme_ggsurvfit_default(), size = 1.5) +
  ylim(c(0, 1)) + 
  scale_x_continuous(breaks = c(0, 365,  730, 1095, 1460), limits = c(0,1460), 
 labels = c("0", "1", "2", "3", "4")) +
  scale_color_manual(values = c( "#F4B942", "#97D8C4",  "#6B9AC4", "#4059AD")) +
   labs(
    x = "",
    y = "",
    title = "Zambia"
  ) +
  theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5, size = 14), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 2, reverse = FALSE)) +
  geom_vline(data = FU_time_temp, aes(xintercept = dtg_recomend_d),linetype="dashed") 

ZMB


# ZWE

FU_time_temp <- FU_time %>% filter(country =="ZWE")

ZWE <- survfit2(Surv(time, dtg_switch_txt_crr2b.factor) ~ sex_age2_txt, data = FU_time_temp) %>%
  ggcuminc(outcome = c("DTG switch"), linetype_aes  = FALSE, theme = theme_ggsurvfit_default(), size = 1.5) +
  ylim(c(0, 1)) + 
  scale_x_continuous(breaks = c(0, 365,  730, 1095, 1460), limits = c(0,1460), 
 labels = c("0", "1", "2", "3", "4")) +
   scale_color_manual(values = c( "#F4B942", "#97D8C4",  "#6B9AC4", "#4059AD")) +
   labs(
    x = "",
    y = "",
    title = "Zimbabwe"
  ) +
  theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5, size = 14), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "center",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 2, reverse = FALSE)) +
  geom_vline(data = FU_time_temp, aes(xintercept = dtg_recomend_d),linetype="dashed") 

ZWE

```

```{r}
plot <- ggarrange(LSO, MWI, MOZ, ZAF, ZMB, ZWE, ncol =2, nrow =3, common.legend = TRUE, legend = "bottom") 

annotate_figure(plot, top = text_grob("Cumulative incidence of DTG switch among all on ART at national DTG adoption", color = "black", face = "bold", size = 11))


ggsave("output/Cohort_transition_outcomes/Competing_risks/combine_DTG_Cumul_incid_DTG_switch_ctry_sexage_time.png", width = 7, height =8)
```




<!-- ----------------------------------------------------- -->

# Cumulative incidence plots (separate competing risks)

(ggcompetingrisks)

```{r eval=FALSE, include=FALSE}

# https://rdrr.io/cran/survminer/man/ggcompetingrisks.html

# https://github.com/kassambara/survminer/blob/master/R/ggcompetingrisks.R

# https://stat.ethz.ch/R-manual/R-devel/library/survival/html/survfit.formula.html

# https://cran.r-project.org/web/packages/survival/survival.pdf

# Computes an estimate of a survival curve for censored data using the Aalen-Johansen estimator. For ordinary (single event) survival this reduces to the Kaplan-Meier estimate.

```


## Overall


```{r eval=FALSE, include=FALSE}
# factor variables
FU_time$dtg_switch_txt_crr.factor <- factor(FU_time$dtg_switch_txt_crr, 
levels=c("0", "2", "3", "4", "1"),
labels = c("No DTG RIC", "Death", "LTFU", "Transfer", "DTG switch"))
```


```{r include=FALSE}
frq(FU_time,dtg_switch_txt_crr.factor )
frq(FU_time,dtg_switch_txt_crr)
frq(FU_time,dtg_switch_txt_crr1b.factor )
frq(FU_time,dtg_switch_txt_crr1b)
```


```{r include=FALSE}

fit1 <- survfit2(Surv(time, dtg_comp_b) ~ 1, data = FU_time, etype = dtg_switch_txt_crr1b.factor)
ggcompetingrisks(fit = fit1)

```

```{r}

p4 <-ggcompetingrisks(fit = fit1,
                 xlab = "Years since national DTG adoption", 
                  ylab = "Cumulative incidence",
                 title = "Cumulative Incidence of outcomes over time") +
     scale_x_continuous(breaks = c(0, 365,  730, 1095, 1460), limits = c(0,1460), 
                        labels = c("0", "1", "2", "3", "4")) +
  theme_ggsurvfit_default() +
 scale_fill_manual("",
  values = c("#9ef0f0", "gray", "#08bdba",  "purple","#0f62fe"), 
  labels = c("No DTG switch - RIC","No DTG switch - Death", "No DTG switch - Transfer","No DTG switch - LTFU", "Switched to DTG"),  
  name = "Outcome event")

#p4

p5 <- p4 + theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "left",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
          strip.background = element_blank(),
          strip.text.x = element_blank()) +
  guides(color = guide_legend(ncol = 2))  
  

p5

ggsave("output/Cohort_transition_outcomes/Competing_risks/Cumul_incid_all_outcomes.png", width = 7, height =6)

```

## by sex


```{r include=FALSE}
fit2 <- survfit2(Surv(time, dtg_comp_b) ~ sex, data = FU_time, etype = dtg_switch_txt_crr1b.factor)
ggcompetingrisks(fit = fit2)
```


```{r}

p4 <-ggcompetingrisks(fit = fit2,
                 xlab = "Years since national DTG adoption", 
                  ylab = "Cumulative incidence",
                 title = "Cumulative Incidence of outcomes over time") +
     scale_x_continuous(breaks = c(0, 365,  730, 1095, 1460), limits = c(0,1460), 
                        labels = c("0", "1", "2", "3", "4")) +
  theme_ggsurvfit_default() +
 scale_fill_manual("",
  values = c("#9ef0f0", "gray", "#08bdba",  "purple","#0f62fe"), 
  labels = c("No DTG switch - RIC","No DTG switch - Death", "No DTG switch - Transfer","No DTG switch - LTFU", "Switched to DTG"),  
  name = "Outcome event")

#p4

p5 <- p4 + theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "left",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
          #strip.background = element_blank(),
          strip.text.x = element_text(size = 13)
         ) +
  guides(color = guide_legend(ncol = 2))  
  

p5

ggsave("output/Cohort_transition_outcomes/Competing_risks/Cumul_incid_all_outcomes_sex.png", width = 7, height =6)

```


## by country

```{r include=FALSE}
fit3 <- survfit2(Surv(time, dtg_comp_b) ~ ctry, data = FU_time, etype = dtg_switch_txt_crr1b.factor)
ggcompetingrisks(fit = fit3)
```

```{r}

p4 <-ggcompetingrisks(fit = fit3,
                 xlab = "Years since national DTG adoption", 
                  ylab = "Cumulative incidence",
                 title = "Cumulative Incidence of outcomes over time") +
    scale_x_continuous(breaks = c(0, 365,  730, 1095, 1460), limits = c(0,1460), 
                        labels = c("0", "1", "2", "3", "4")) +
  theme_ggsurvfit_default() +
 scale_fill_manual("",
  values = c("#9ef0f0", "gray", "#08bdba",  "purple","#0f62fe"), 
  labels = c("No DTG switch - RIC","No DTG switch - Death", "No DTG switch - Transfer","No DTG switch - LTFU", "Switched to DTG"),  
  name = "Outcome event")

#p4

p5 <- p4 + theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "left",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
          #strip.background = element_blank(),
          strip.text.x = element_text(size = 13)) +
  guides(color = guide_legend(ncol = 2))  
  

p5

ggsave("output/Cohort_transition_outcomes/Competing_risks/Cumul_incid_all_outcomes_ctry.png", width = 7, height =5.5)

```


## by country & sex

```{r include=FALSE}
fit3b <- survfit2(Surv(time, dtg_comp_b) ~ country + sex, data = FU_time, etype = dtg_switch_txt_crr1b.factor)
ggcompetingrisks(fit = fit3b)  + 
 facet_wrap(~strata, ncol = 2)
```

```{r}

p4 <-ggcompetingrisks(fit = fit3b,
                 xlab = "Years since national DTG adoption", 
                  ylab = "Cumulative incidence",
                 title = "Cumulative Incidence of outcomes over time") +
    scale_x_continuous(breaks = c(0, 365,  730, 1095, 1460), limits = c(0,1460), 
                        labels = c("0", "1", "2", "3", "4")) +
  theme_ggsurvfit_default() +
 scale_fill_manual("",
  values = c("#9ef0f0", "gray", "#08bdba",  "purple","#0f62fe"), 
  labels = c("No DTG switch - RIC","No DTG switch - Death", "No DTG switch - Transfer","No DTG switch - LTFU", "Switched to DTG"),  
  name = "Outcome event")  + 
 facet_wrap(~strata, ncol = 2, labeller = labeller(strata = 
      c("country=LSO, sex=Female" = "Lesotho, Female", 
        "country=LSO, sex=Male  " = "Lesotho, Male",
         "country=MOZ, sex=Female" = "Mozambique, Female",
         "country=MOZ, sex=Male  " = "Mozambique, Male",
         "country=MWI, sex=Female" = "Malawi, Female",
         "country=MWI, sex=Male  " = "Malawi, Male",
        "country=ZAF, sex=Female" = "South Africa, Female",
         "country=ZAF, sex=Male  " = "South Africa, Male",
          "country=ZMB, sex=Female" = "Zambia, Female",
         "country=ZMB, sex=Male  " = "Zambia, Male",
         "country=ZWE, sex=Female" = "Zimbabwe, Female",
         "country=ZWE, sex=Male  " = "Zimbabwe, Male"
)))

#p4

p5 <- p4 + theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 12), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 12), #pad x axis label
          axis.text.x = element_text(size = 12),
          axis.text.y = element_text(size = 12),
          axis.text = element_text(size = 12),
          legend.text = element_text(size = 12),
          legend.title = element_text(size = 12),
          legend.position = "right", 
          legend.justification = "left",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
          #strip.background = element_blank(),
          strip.text.x = element_text(size = 12)) +
  guides(color = guide_legend(ncol = 2))  
  

p5

ggsave("output/Cohort_transition_outcomes/Competing_risks/Cumul_incid_all_outcomes_ctry_sex.png", width = 7, height =9.5)

```


```{r eval=FALSE, include=FALSE}
fit_test <- fit3b 

### Ways to name panels ####

panel_labels <- c("country=LSO, sex=Female" = "Lesotho, Female", 
        "country=LSO, sex=Male  " = "Lesotho, Male",
         "country=MOZ, sex=Female" = "Mozambique, Female",
         "country=MOZ, sex=Male  " = "Mozambique, Male",
         "country=MWI, sex=Female" = "Malawi, Female",
         "country=MWI, sex=Male  " = "Malawi, Male",
        "country=ZAF, sex=Female" = "South Africa, Female",
         "country=ZAF, sex=Male  " = "South Africa, Male",
          "country=ZMB, sex=Female" = "Zambia, Female",
         "country=ZMB, sex=Male  " = "Zambia, Male",
         "country=ZWE, sex=Female" = "Zimbabwe, Female",
         "country=ZWE, sex=Male  " = "Zimbabwe, Male")

ggcompetingrisks(fit = fit_test)  +
 facet_wrap(~strata, scales = "free", nrow =6, labeller = labeller(strata = 
      c("country=LSO, sex=Female" = "Lesotho, Female", 
        "country=LSO, sex=Male  " = "Lesotho, Male",
         "country=MOZ, sex=Female" = "Mozambique, Female",
         "country=MOZ, sex=Male  " = "Mozambique, Male",
         "country=MWI, sex=Female" = "Malawi, Female",
         "country=MWI, sex=Male  " = "Malawi, Male",
        "country=ZAF, sex=Female" = "South Africa, Female",
         "country=ZAF, sex=Male  " = "South Africa, Male",
          "country=ZMB, sex=Female" = "Zambia, Female",
         "country=ZMB, sex=Male  " = "Zambia, Male",
         "country=ZWE, sex=Female" = "Zimbabwe, Female",
         "country=ZWE, sex=Male  " = "Zimbabwe, Male"
)))



```


<!-- ----------------------------------------------------- -->

# Cumulative incidence plots (competing risks aggregated)

```{r include=FALSE}
fit4 <- survfit2(Surv(time, dtg_comp_b) ~ 1, data = FU_time, etype = dtg_switch_txt_crr2.factor)
ggcompetingrisks(fit = fit4)
```


```{r}

p4 <-ggcompetingrisks(fit = fit4,
                 xlab = "Years since national DTG adoption", 
                  ylab = "Cumulative incidence",
                 title = "Cumulative Incidence of outcomes over time") +
   scale_x_continuous(breaks = c(0, 365,  730, 1095, 1460), limits = c(0,1460), 
                        labels = c("0", "1", "2", "3", "4")) +
  theme_ggsurvfit_default() +
#  theme(plot.title = element_text(hjust = 0.5), #center title
  #      axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0)), #pad y axis label
    #    axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) + #pad x axis label
  #scale_color_manual(labels = c("No DTG switch","competing risk","DTG switch"),  
   #                  values = c("#9ef0f0", "#08bdba", "#0f62fe"), 
     #                name = "Outcome event") +   # do not name legend
  scale_fill_manual(labels = c("No DTG switch - remained in care", "No DTG switch - competing risk event","Switched to DTG"),  
                    values = c("#9ef0f0", "#08bdba", "#0f62fe"),
                    name = "Outcome event") 
#p4

p5 <- p4 + theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "left",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
          strip.background = element_blank(),
          strip.text.x = element_blank()) +
  guides(color = guide_legend(ncol = 1))  
  

p5

ggsave("output/Cohort_transition_outcomes/Competing_risks/Cumul_incid_onegroup.png", width = 7, height =5)

```


```{r eval=FALSE, include=FALSE}
frq(FU_time, dtg_switch_txt_crr2b.factor)
frq(FU_time, dtg_switch_txt_crr2.factor)
frq(FU_time, dtg_switch_txt_crr2)
```


## by sex

```{r include=FALSE}

fit5 <- survfit2(Surv(time, dtg_comp_b) ~ sex, data = FU_time, etype = dtg_switch_txt_crr2.factor)
#fit5 <- survfit2(Surv(time, dtg_switch_txt_crr2b.factor) ~ 1, data = FU_time)
ggcompetingrisks(fit = fit5)

```



```{r}
p4 <-ggcompetingrisks(fit = fit5,
                 xlab = "Years since national DTG adoption", 
                  ylab = "Cumulative incidence",
                 title = "Cumulative Incidence of outcomes over time") +
    scale_x_continuous(breaks = c(0, 365,  730, 1095, 1460), limits = c(0,1460), 
                        labels = c("0", "1", "2", "3", "4")) +
  theme_ggsurvfit_default() +
#  theme(plot.title = element_text(hjust = 0.5), #center title
#        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0)), #pad y axis label
  #      axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) + #pad x axis label
  #scale_color_manual(labels = c("No DTG switch","competing risk","DTG switch"),  
   #                  values = c("#9ef0f0", "#08bdba", "#0f62fe"), 
     #                name = "Outcome event") +   # do not name legend
  scale_fill_manual(labels = c("No DTG switch - remained in care", "No DTG switch - competing risk event","Switched to DTG"),  
                    values = c("#9ef0f0", "#08bdba", "#0f62fe"),
                    name = "Outcome event") 
#p4

p5 <- p4 + theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "left",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 1))  
  

p5

ggsave("output/Cohort_transition_outcomes/Competing_risks/Cumul_incid_sex.png", width = 7, height =5)

```



## by sex & age

```{r include=FALSE}

fit5b <- survfit2(Surv(time, dtg_comp_b) ~ sex_age2, data = FU_time, etype = dtg_switch_txt_crr2.factor)
ggcompetingrisks(fit = fit5b)

```


```{r}
p4 <-ggcompetingrisks(fit = fit5b,
                 xlab = "Years since national DTG adoption", 
                  ylab = "Cumulative incidence",
                 title = "Cumulative Incidence of outcomes over time") +
    scale_x_continuous(breaks = c(0, 365,  730, 1095, 1460), limits = c(0,1460), 
                        labels = c("0", "1", "2", "3", "4")) +
  theme_ggsurvfit_default() +
#  theme(plot.title = element_text(hjust = 0.5), #center title
#        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0)), #pad y axis label
  #      axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) + #pad x axis label
  #scale_color_manual(labels = c("No DTG switch","competing risk","DTG switch"),  
   #                  values = c("#9ef0f0", "#08bdba", "#0f62fe"), 
     #                name = "Outcome event") +   # do not name legend
  scale_fill_manual(labels = c("No DTG switch - remained in care", "No DTG switch - competing risk event","Switched to DTG"),  
                    values = c("#9ef0f0", "#08bdba", "#0f62fe"),
                    name = "Outcome event") 
#p4

p5 <- p4 + theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "left",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 1))  
  

p5

ggsave("output/Cohort_transition_outcomes/Competing_risks/Cumul_incid_sex_age.png", width = 7, height =5)

```


## by country (by calendar year)

```{r include=FALSE}

fit6 <- survfit2(Surv(time_t2, dtg_comp_b) ~ ctry, data = FU_time, etype = dtg_switch_txt_crr2.factor)
ggcompetingrisks(fit = fit6)

```


```{r}
p4 <-ggcompetingrisks(fit = fit6,
                 xlab = "", 
                  ylab = "Cumulative incidence",
                 title = "Cumulative Incidence of outcomes over time") +
    scale_x_continuous(breaks = c(153, 518, 883, 1248, 1613 ), limits = c(0,1613), 
    labels = c("2019", "2020", "2021", "2022", "2023")) +
  theme_ggsurvfit_default() +
#  theme(plot.title = element_text(hjust = 0.5), #center title
#        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0)), #pad y axis label
  #      axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) + #pad x axis label
  #scale_color_manual(labels = c("No DTG switch","competing risk","DTG switch"),  
   #                  values = c("#9ef0f0", "#08bdba", "#0f62fe"), 
     #                name = "Outcome event") +   # do not name legend
  scale_fill_manual(labels = c("No DTG switch - remained in care", "No DTG switch - competing risk event","Switched to DTG"),  
                    values = c("#9ef0f0", "#08bdba", "#0f62fe"),
                    name = "Outcome event") 
#p4

p5 <- p4 + theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13, angle =90, vjust = 0.6, hjust = 0.5),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "left",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 1))  
  

p5

ggsave("output/Cohort_transition_outcomes/Competing_risks/Cumul_incid_ctry.png", width = 7, height =5)

```


## by country and sex

```{r include=FALSE}

fit7 <- survfit2(Surv(time, dtg_comp_b) ~ country + sex, data = FU_time, etype = dtg_switch_txt_crr2.factor)
ggcompetingrisks(fit = fit7) + 
 facet_wrap(~strata, ncol = 2)

```


```{r}
p4 <-ggcompetingrisks(fit = fit7,
                 xlab = "Years since national DTG adoption", 
                  ylab = "Cumulative incidence",
                 title = "Cumulative Incidence of outcomes over time") +
     scale_x_continuous(breaks = c(0, 365,  730, 1095, 1460), limits = c(0,1460), 
                        labels = c("0", "1", "2", "3", "4")) +
  theme_ggsurvfit_default() +
#  theme(plot.title = element_text(hjust = 0.5), #center title
#        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0)), #pad y axis label
  #      axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) + #pad x axis label
  #scale_color_manual(labels = c("No DTG switch","competing risk","DTG switch"),  
   #                  values = c("#9ef0f0", "#08bdba", "#0f62fe"), 
     #                name = "Outcome event") +   # do not name legend
  scale_fill_manual(labels = c("No DTG switch - remained in care", "No DTG switch - competing risk event","Switched to DTG"),  
                    values = c("#9ef0f0", "#08bdba", "#0f62fe"),
                    name = "Outcome event") + 
 facet_wrap(~strata, ncol = 1, labeller = labeller(strata = 
      c("country=LSO, sex=Female" = "Lesotho, Female", 
        "country=LSO, sex=Male  " = "Lesotho, Male",
         "country=MOZ, sex=Female" = "Mozambique, Female",
         "country=MOZ, sex=Male  " = "Mozambique, Male",
         "country=MWI, sex=Female" = "Malawi, Female",
         "country=MWI, sex=Male  " = "Malawi, Male",
        "country=ZAF, sex=Female" = "South Africa, Female",
         "country=ZAF, sex=Male  " = "South Africa, Male",
          "country=ZMB, sex=Female" = "Zambia, Female",
         "country=ZMB, sex=Male  " = "Zambia, Male",
         "country=ZWE, sex=Female" = "Zimbabwe, Female",
         "country=ZWE, sex=Male  " = "Zimbabwe, Male"
)))

#p4

p5 <- p4 + theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "right", 
          legend.justification = "left",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         # strip.background = element_blank(),
         strip.text.x = element_text(size =13)
         ) +
  guides(color = guide_legend(ncol = 1))  
  

p5

ggsave("output/Cohort_transition_outcomes/Competing_risks/Cumul_incid_ctry_sex.png", width = 7.5, height =10)

```




<!-- ----------------------------------------------------- -->

# Outcomes among those switching and not switching to DTG

```{r include=FALSE}
frq(tblBAS, dtg_recomend_d)
frq(tblBAS, country)

tblBAS = data.table(tblBAS)
tblBAS[, start_fu3 := dtg_recomend_d] 
tblBAS[, end_fu3 := rev_outcome_d] 

tblBAS[, FU_day3 := as.numeric(end_fu3 - start_fu3)]
tblBAS[, FU_month3 := round(as.numeric(end_fu3 - start_fu3) / (365.25 / 12), 1)]
tblBAS[, FU_year3 := round(as.numeric(end_fu3 - start_fu3) / (365.25), 1)]

tblBAS[, time3 := FU_day3]

```


```{r}
table1::label(tblBAS$sex) <- "Sex"
table1::label(tblBAS$age_cat3) <- "Age group"

table1::label(tblBAS$rev_outcome) <- "Outcome"
table1::label(tblBAS$sex_age2) <- "Sex & age group"
table1::label(tblBAS$sex_age3) <- "Sex & age group"
table1::label(tblBAS$program) <- "Program"
table1::label(tblBAS$ctry) <- "Country"

```


```{r}
FU_time <- tblBAS %>% mutate(dtg_comp_b3 = ifelse(rev_outcome == "RIC", 0, 1))
```

```{r include=FALSE}
 # Competing risks regression (alive ==0, dtg ==1, death ==2, ltfu ==3, trans ==4)
  
frq(FU_time, rev_outcome)


FU_time <- FU_time %>% 
  mutate(
    
dtg_first_txt_crr3b = case_when(
    rev_outcome == "RIC" ~ 0, # still alive RIC (retained in care)
    rev_outcome == "Death" ~ 1, # outcome Death
    rev_outcome == "Transfer" ~ 2, # outcome LTFU
    rev_outcome == "LTFU" ~ 3), # outcome Transfer
)


FU_time$dtg_first_txt_crr3b.factor <- factor(FU_time$dtg_first_txt_crr3b, 
levels=c("0", "1", "2", "3"),
labels = c("a", "b", "c", "d"))

```


```{r include=FALSE}
# create two subcohorts: intitated DTG & did not initiate DTG
frq(FU_time, dtg)
frq(FU_time, rev_outcome)

FU_time_DTG <- FU_time %>% filter(dtg_switch == 1)
FU_time_noDTG <- FU_time %>% filter(dtg_switch == 0)

frq(FU_time_DTG, start_fu3)
## Need to fix issue with LSO not having anyone switching to DTG early...
test <- FU_time_DTG %>% filter(country =="LSO")
FU_time_DTG <- FU_time_DTG %>% mutate(time3 = ifelse(patient =="SMLM0002", 2, time3))
FU_time_DTG <- FU_time_DTG %>% mutate(time3 = ifelse(patient =="SMLM0007", 2, time3))

```


## Adults who switched to DTG ART

Table of outcomes for all data.

```{r eval=FALSE, include=FALSE}

## by country
sjPlot::tab_xtab(FU_time_DTG$ctry,
                 FU_time_DTG$rev_outcome,
                 show.row.prc = TRUE, show.summary = FALSE)
```

Cumulative incidence plot of outcomes among adults switching to DTG ART in first 4 years.


```{r include=FALSE}

fit3 <- survfit2(Surv(time3, dtg_comp_b3) ~ 1, data = FU_time_DTG, etype = dtg_first_txt_crr3b.factor)
ggcompetingrisks(fit = fit3)

```

```{r}

p4 <-ggcompetingrisks(fit = fit3,
                 xlab = "Years since national DTG adoption", 
                  ylab = "Cumulative incidence",
                 title = "Among adults who switched to DTG") +
     scale_x_continuous(breaks = c(0, 365,  730, 1095, 1460 ), limits = c(0,1460), 
                        labels = c("0", "1", "2", "3", "4")) +
  theme_ggsurvfit_default() +
 scale_fill_manual("",
  values = c("#9ef0f0", "gray", "#08bdba",  "purple","#0f62fe"), 
  labels = c("RIC", "Death", "Transfer","LTFU"),  
  name = "Outcome event")

#p4

p5dtg <- p4 + theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "left",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
          strip.background = element_blank(),
          strip.text.x = element_blank()) +
  guides(color = guide_legend(ncol = 2))  
  

p5dtg

ggsave("output/Cohort_transition_outcomes/Outcomes/DTGswitch_Cumul_incid_all_outcomes.png", width = 7, height =6)

```


## by sex


Cumulative incidence plot of outcomes among adults switching to DTG ART in first 4 years.


```{r include=FALSE}

fit3 <- survfit2(Surv(time3, dtg_comp_b3) ~ sex, data = FU_time_DTG, etype = dtg_first_txt_crr3b.factor)
ggcompetingrisks(fit = fit3)

```

```{r}

p4 <-ggcompetingrisks(fit = fit3,
                 xlab = "Years since national DTG adoption", 
                  ylab = "Cumulative incidence",
                 title = "Among adults who switched to DTG: Cumulative Incidence of outcomes") +
     scale_x_continuous(breaks = c(0, 365,  730, 1095, 1460 ), limits = c(0,1460), 
                        labels = c("0", "1", "2", "3", "4")) +
  theme_ggsurvfit_default() +
 scale_fill_manual("",
  values = c("#9ef0f0", "gray", "#08bdba",  "purple","#0f62fe"), 
  labels = c("RIC", "Death", "Transfer","LTFU"),  
  name = "Outcome event")

#p4

p5 <- p4 + theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "left",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
         strip.background = element_blank(),
          strip.text.x = element_text(size = 14)
          ) +
  guides(color = guide_legend(ncol = 2))  
  

p5

ggsave("output/Cohort_transition_outcomes/Outcomes/DTGswitch_sex_Cumul_incid_all_outcomes.png", width = 7, height =6)

```


## by country


Cumulative incidence plot of outcomes among adults switching to DTG ART in first 4 years.


```{r include=FALSE}

fit3c <- survfit2(Surv(time3, dtg_comp_b3) ~ ctry, data = FU_time_DTG, etype = dtg_first_txt_crr3b.factor)
ggcompetingrisks(fit = fit3c)

```

```{r}

p4 <-ggcompetingrisks(fit = fit3c,
                 xlab = "Years since national DTG adoption", 
                  ylab = "Cumulative incidence",
                 title = "Among adults who switched to DTG: Cumulative Incidence of outcomes") +
     scale_x_continuous(breaks = c(0, 365,  730, 1095, 1460 ), limits = c(0,1460), 
                        labels = c("0", "1", "2", "3", "4")) +
  theme_ggsurvfit_default() +
 scale_fill_manual("",
  values = c("#9ef0f0", "gray", "#08bdba",  "purple","#0f62fe"), 
  labels = c("RIC", "Death", "Transfer","LTFU"),  
  name = "Outcome event")

#p4

p5 <- p4 + theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "left",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
          strip.background = element_blank(),
         strip.text.x = element_text(size = 14)
          ) +
  guides(color = guide_legend(ncol = 2))  
  

p5

ggsave("output/Cohort_transition_outcomes/Outcomes/DTGswitch_ctry_Cumul_incid_all_outcomes.png", width = 7, height =6)

```



## by country and sex

```{r}

fit4c <- survfit2(Surv(time3, dtg_comp_b3) ~ country + sex, data = FU_time_DTG, etype = dtg_first_txt_crr3b.factor)

ggcompetingrisks(fit = fit4c) +
  facet_wrap(~strata, ncol = 2)
```


```{r}

p4 <-ggcompetingrisks(fit = fit4c,
                 xlab = "Years since national DTG adoption", 
                  ylab = "Cumulative incidence",
                 title = "Outcomes among adults who switched to DTG") +
     scale_x_continuous(breaks = c(0, 365,  730, 1095, 1460 ), limits = c(0,1460), 
                        labels = c("0", "1", "2", "3", "4")) +
  theme_ggsurvfit_default() +
 scale_fill_manual("",
  values = c("#9ef0f0", "gray", "#08bdba",  "purple","#0f62fe"), 
  labels = c("RIC", "Death", "Transfer","LTFU"),  
  name = "Outcome event") +
   facet_wrap(~strata, ncol = 2, labeller = labeller(strata = 
      c("country=LSO, sex=Female" = "Lesotho, Female", 
        "country=LSO, sex=Male  " = "Lesotho, Male",
         "country=MOZ, sex=Female" = "Mozambique, Female",
         "country=MOZ, sex=Male  " = "Mozambique, Male",
         "country=MWI, sex=Female" = "Malawi, Female",
         "country=MWI, sex=Male  " = "Malawi, Male",
        "country=ZAF, sex=Female" = "South Africa, Female",
         "country=ZAF, sex=Male  " = "South Africa, Male",
          "country=ZMB, sex=Female" = "Zambia, Female",
         "country=ZMB, sex=Male  " = "Zambia, Male",
         "country=ZWE, sex=Female" = "Zimbabwe, Female",
         "country=ZWE, sex=Male  " = "Zimbabwe, Male"
)))

#p4

p5 <- p4 + theme(axis.title = element_text(size = 12),
          plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 12), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 12), #pad x axis label
          axis.text.x = element_text(size = 12),
          axis.text.y = element_text(size = 12),
          axis.text = element_text(size = 12),
          legend.text = element_text(size = 12),
          legend.title = element_text(size = 12),
          legend.position = "right", 
          legend.justification = "left",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
          strip.background = element_blank(),
         strip.text.x = element_text(size = 12)
          ) +
  guides(color = guide_legend(ncol = 2))  
  

p5

ggsave("output/Cohort_transition_outcomes/Outcomes/DTGswitch_ctry_sex_Cumul_incid_all_outcomes.png", width = 7, height =9.5)

```


```{r eval=FALSE, include=FALSE}
facet_wrap(~strata, ncol = 2, labeller = labeller(strata = 
      c("country=LSO, sex=Female" = "Lesotho, Female", 
        "country=LSO, sex=Male  " = "Lesotho, Male",
         "country=MOZ, sex=Female" = "Mozambique, Female",
         "country=MOZ, sex=Male  " = "Mozambique, Male",
         "country=MWI, sex=Female" = "Malawi, Female",
         "country=MWI, sex=Male  " = "Malawi, Male",
        "country=ZAF, sex=Female" = "South Africa, Female",
         "country=ZAF, sex=Male  " = "South Africa, Male",
          "country=ZMB, sex=Female" = "Zambia, Female",
         "country=ZMB, sex=Male  " = "Zambia, Male",
         "country=ZWE, sex=Female" = "Zimbabwe, Female",
         "country=ZWE, sex=Male  " = "Zimbabwe, Male"
)))
```




## Adults who didn't switch to DTG

Table of outcomes for all data.

```{r eval=FALSE, include=FALSE}
## by country
sjPlot::tab_xtab(FU_time_noDTG$ctry,
                 FU_time_noDTG$rev_outcome,
                 show.row.prc = TRUE, show.summary = FALSE)
```

Cumulative incidence plot of outcomes among adults not switching DTG ART in first 4 years.


```{r include=FALSE}

fit4 <- survfit2(Surv(time3, dtg_comp_b3) ~ 1, data = FU_time_noDTG, etype = dtg_first_txt_crr3b.factor)
ggcompetingrisks(fit = fit4)

```

```{r echo=FALSE}

p4 <-ggcompetingrisks(fit = fit4,
                 xlab = "Years since national DTG adoption", 
                  ylab = "Cumulative incidence",
                 title = "Among adults not switching to DTG") +
     scale_x_continuous(breaks = c(0, 365,  730, 1095, 1460), limits = c(0,1460), 
                        labels = c("0", "1", "2", "3", "4")) +
  theme_ggsurvfit_default() +
 scale_fill_manual("",
  values = c("#9ef0f0", "gray", "#08bdba",  "purple","#0f62fe"), 
  labels = c("RIC", "Death", "Transfer","LTFU"),  
  name = "Outcome event")

#p4

p5nodtg <- p4 + theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "left",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
          strip.background = element_blank(),
          strip.text.x = element_blank()
          ) +
  guides(color = guide_legend(ncol = 2))  
  

p5nodtg

ggsave("output/Cohort_transition_outcomes/Outcomes/noDTGswitch_Cumul_incid_all_outcomes.png", width = 7, height =6)

```


```{r}
ggarrange(p5dtg, p5nodtg, ncol =2, nrow =1, common.legend = FALSE, legend = "bottom") 
ggsave("output/Cohort_transition_outcomes/Outcomes/combine_DTG_Cumul_incid_all_outcomes.png", width = 9, height =6)

```



## by sex 

Cumulative incidence plot of outcomes among adults not switching DTG ART in first 4 years.


```{r include=FALSE}

fit4 <- survfit2(Surv(time3, dtg_comp_b3) ~ sex, data = FU_time_noDTG, etype = dtg_first_txt_crr3b.factor)
ggcompetingrisks(fit = fit4)

```

```{r echo=FALSE}

p4 <-ggcompetingrisks(fit = fit4,
                 xlab = "Years since national DTG adoption", 
                  ylab = "Cumulative incidence",
                 title = "Among adults not switching to DTG: Cumulative Incidence of outcomes") +
     scale_x_continuous(breaks = c(0, 365,  730, 1095, 1460), limits = c(0,1460), 
                        labels = c("0", "1", "2", "3", "4")) +
  theme_ggsurvfit_default() +
 scale_fill_manual("",
  values = c("#9ef0f0", "gray", "#08bdba",  "purple","#0f62fe"), 
  labels = c("RIC", "Death", "Transfer","LTFU"),  
  name = "Outcome event")

#p4

p5 <- p4 + theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "left",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
          strip.background = element_blank(),
          strip.text.x = element_text(size = 14)
          ) +
  guides(color = guide_legend(ncol = 2))  
  

p5

ggsave("output/Cohort_transition_outcomes/Outcomes/noDTGswitch_sex_Cumul_incid_all_outcomes.png", width = 7, height =6)

```



## by country 

Cumulative incidence plot of outcomes among adults not switching DTG ART in first 4 years.


```{r include=FALSE}

fit4 <- survfit2(Surv(time3, dtg_comp_b3) ~ ctry, data = FU_time_noDTG, etype = dtg_first_txt_crr3b.factor)
ggcompetingrisks(fit = fit4)

```

```{r echo=FALSE}

p4 <-ggcompetingrisks(fit = fit4,
                 xlab = "Years since national DTG adoption", 
                  ylab = "Cumulative incidence",
                 title = "Among adults not switching to DTG: Cumulative Incidence of outcomes") +
     scale_x_continuous(breaks = c(0, 365,  730, 1095, 1460), limits = c(0,1460), 
                        labels = c("0", "1", "2", "3", "4")) +
  theme_ggsurvfit_default() +
 scale_fill_manual("",
  values = c("#9ef0f0", "gray", "#08bdba",  "purple","#0f62fe"), 
  labels = c("RIC", "Death", "Transfer","LTFU"),  
  name = "Outcome event")

#p4

p5 <- p4 + theme(axis.title = element_text(size = 14),
          plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 14), #pad x axis label
          axis.text.x = element_text(size = 13),
          axis.text.y = element_text(size = 13),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 13),
          legend.position = "bottom", 
          legend.justification = "left",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
          strip.background = element_blank(),
           strip.text.x = element_text(size = 14)
          ) +
  guides(color = guide_legend(ncol = 2))  
  

p5

ggsave("output/Cohort_transition_outcomes/Outcomes/noDTGswitch_ctry_Cumul_incid_all_outcomes.png", width = 7, height =6)

```


## by country and sex

```{r include=FALSE}

fit5c <- survfit2(Surv(time3, dtg_comp_b3) ~ country + sex, data = FU_time_noDTG, etype = dtg_first_txt_crr3b.factor)

ggcompetingrisks(fit = fit5c) +
  facet_wrap(~strata, ncol = 2)
```


```{r}

p4 <-ggcompetingrisks(fit = fit5c,
                 xlab = "Years since national DTG adoption", 
                  ylab = "Cumulative incidence",
                 title = "Outcomes among adults who didn't switch to DTG") +
     scale_x_continuous(breaks = c(0, 365,  730, 1095, 1460 ), limits = c(0,1460), 
                        labels = c("0", "1", "2", "3", "4")) +
  theme_ggsurvfit_default() +
 scale_fill_manual("",
  values = c("#9ef0f0", "gray", "#08bdba",  "purple","#0f62fe"), 
  labels = c("RIC", "Death", "Transfer","LTFU"),  
  name = "Outcome event") +
   facet_wrap(~strata, ncol = 2, labeller = labeller(strata = 
      c("country=LSO, sex=Female" = "Lesotho, Female", 
        "country=LSO, sex=Male  " = "Lesotho, Male",
         "country=MOZ, sex=Female" = "Mozambique, Female",
         "country=MOZ, sex=Male  " = "Mozambique, Male",
         "country=MWI, sex=Female" = "Malawi, Female",
         "country=MWI, sex=Male  " = "Malawi, Male",
        "country=ZAF, sex=Female" = "South Africa, Female",
         "country=ZAF, sex=Male  " = "South Africa, Male",
          "country=ZMB, sex=Female" = "Zambia, Female",
         "country=ZMB, sex=Male  " = "Zambia, Male",
         "country=ZWE, sex=Female" = "Zimbabwe, Female",
         "country=ZWE, sex=Male  " = "Zimbabwe, Male"
)))

#p4

p5 <- p4 + theme(axis.title = element_text(size = 12),
          plot.title = element_text(hjust = 0.5), #center title
          axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 12), #pad y axis label
          axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 12), #pad x axis label
          axis.text.x = element_text(size = 12),
          axis.text.y = element_text(size = 12),
          axis.text = element_text(size = 12),
          legend.text = element_text(size = 12),
          legend.title = element_text(size = 12),
          legend.position = "right", 
          legend.justification = "left",
          legend.box.background = element_rect(color = "black"),
          legend.direction="vertical", 
          legend.margin=margin(0,0,0,0),
          legend.box.margin = margin(-5, -5, -5, -5), 
          legend.key.size = unit(0.7, "cm"), 
          strip.background = element_blank(),
         strip.text.x = element_text(size = 12)
          ) +
  guides(color = guide_legend(ncol = 2))  
  

p5

ggsave("output/Cohort_transition_outcomes/Outcomes/noDTGswitch_ctry_sex_Cumul_incid_all_outcomes.png", width = 7, height =9.5)

```






<!-- ----------------------------------------------------- -->



























```{r eval=FALSE, include=FALSE}

ggcompetingrisks(fit = fit3d, 
                       multiple_panels = F, 
                       ggtheme = theme_minimal(),
                       coef = 1.96, #95% CI
                       conf.int = T,
                       xlab = "Days", 
                       ylab = "Probability",
                       title = "Cumulative Incidence by Time Period") +
  theme(legend.position="bottom", 
        legend.box.background = element_rect(color = "black"),
        legend.direction="horizontal", 
        legend.margin=margin(0,0,0,0),
        legend.box.margin = margin(-5, -5, -5, -5), 
        legend.title = element_blank(),
        legend.key.size = unit(0.7, "cm"), 
        legend.text = element_text(size=10)) 

```


```{r eval=FALSE, include=FALSE}
#https://stackoverflow.com/questions/72983580/how-can-i-change-the-aesthetic-mapping-for-confidence-intervals-when-using-ggcom

p3 <- ggcompetingrisks(fit = x, 
                       multiple_panels = F, 
                       ggtheme = theme_minimal(),
                       coef = 1.96, #95% CI
                       conf.int = T,
                       xlim = c(0, 15),
                       ylim = c(0, 0.1),
                       xlab = "Days", 
                       ylab = "Probability",
                       title = "Cumulative Incidence by Time Period") +
  theme(plot.title = element_text(hjust = 0.5), #center title
        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0)), #pad y axis label
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) + #pad x axis label
  scale_color_manual(labels = c("Period 1","Period 2","Period 3"),  
                     values = c("#9ef0f0", "#08bdba", "#0f62fe"), 
                     name = element_blank()) +   # do not name legend
  scale_fill_manual(labels = c("Period 1"),  
                    values = c("#9ef0f0", "#08bdba", "#0f62fe"))
p3$mapping <- aes(x = time, y = est, colour = group, linetype = event, fill = event) # overwrite aes to flip linetype and color mappings

p3

```




```{r eval=FALSE, include=FALSE}

####################
# Simple KM
survfit2(Surv(time, dtg) ~ sex, data = FU_time2b) %>%
  ggsurvfit(type = "risk") +
  add_risktable() +
  add_confidence_interval() +
  ylim(c(0, 1)) + 
  scale_x_continuous(breaks = c(0, 182, 365, 547, 730), limits = c(0,730), 
  labels = c("0", "6m", "12m", "18m", "24m")) 

###################
# using survfit2 : multistate model Aelen-Johansen estimate (fast)
survfit2(Surv(time, dtg_switch_txt_crr2.factor) ~ 1, data = FU_time) %>%
  ggcuminc(outcome = c("DTG switch", "Competing risk")) +
  add_risktable() +
  add_confidence_interval() +
  ylim(c(0, 1)) + 
  scale_x_continuous(breaks = c(0, 182, 365, 547, 730), limits = c(0,730), 
  labels = c("0", "6m", "12m", "18m", "24m")) 

#################
# using cuminc : cumulative incidence (slow)
cuminc(Surv(time, dtg_switch_txt_crr2) ~ sex, data = FU_time2b) %>%
  ggcuminc(outcome = c("DTG switch")) +
  add_risktable() +
  add_confidence_interval() +
  ylim(c(0, 1)) + 
  scale_x_continuous(breaks = c(0, 182, 365, 547, 730), limits = c(0,730), 
  labels = c("0", "6m", "12m", "18m", "24m")) 
  
  
  
  xlim(c(0,730))
  labs(
    x = "Days"
  )


cuminc(Surv(time, dtg_comp_b) ~ 1, data = FU_time2b) %>%
  ggcuminc(outcome = c("DTG", "compete"))



p <- ggcompetingrisks(fit3c) + ggtitle("title 2b") +
  theme(legend.position="right", 
        legend.box.background = element_rect(color = "black"),
        legend.direction="vertical", 
        legend.margin=margin(0,0,0,0),
        legend.box.margin = margin(-5, -5, -5, -5), 
        legend.title = element_blank(),
        legend.key.size = unit(0.7, "cm"), 
        legend.text = element_text(size=10)) +
  scale_fill_discrete(labels=c("No DTG", "Competing risks", "DTG switch")) +
  scale_x_continuous(breaks = c(0, 182, 365, 547, 730), limits = c(0,730), 
  labels = c("0", "6m", "12m", "18m", "24m")) 

p
```


```{r eval=FALSE, include=FALSE}
km = survfit(Surv(time = alt_start_fu, 
                  time2 = alt_end_fu,
                  event = dtg, 
                  type = "counting") ~ 1,
             id = patient, 
             data = FU_time)

cr0 = survfit(Surv(time = alt_start_fu, 
                   time2 = alt_end_fu,
                   event = dtg_comp_b, 
                   type = "counting") ~ 1,
              id = patient, 
              etype = dtg,
              data = FU_time)

km
cr0

```

```{r eval=FALSE, include=FALSE}
plot(cr0, col = 2:4, conf.int = FALSE, xlim = c(2018.9, 2022), ylim = c(0, 1)) 
lines(km, fun = 'event', xlim = c(2018.9, 2022), conf.int = FALSE) 

text(2021.5, .8, "Competing risk: DTG", col = 3)
text(2021.5, .2, "Competing risk: other", col = 2)
text(2019.5, .6,"KM")

#ggsave("output/Cohort_transition_outcomes/SA256_KM_DTG_compete.png", width = 8, height =4)

```



```{r eval=FALSE, include=FALSE}
cr1 = survfit(Surv(time = alt_start_fu, 
                   time2 = alt_end_fu,
                   event = dtg_comp, 
                   type = "counting") ~ country,
              id = patient, 
              etype = dtg_switch_txt,
              data = FU_time)

cr1

```



```{r eval=FALSE, include=FALSE}

plot(cr1, xlim = c(2018.9, 2022)) 

plot(cr1, col = 2:3, xlim = c(2018.9, 2022)) 


```



```{r eval=FALSE, include=FALSE}
broom::tidy(cr1) %>% 
  filter(state != "(s0)") %>% 
  ggplot(aes(x = time, y = estimate, color = state)) +
  geom_line() + 
  facet_wrap(vars(strata)) + 
  theme_bw()


```

 

```{r eval=FALSE, include=FALSE}
cr2 = survfit(Surv(time = alt_start_fu, 
                   time2 = alt_end_fu,
                   event = dtg_comp, 
                   type = "counting") ~ country + sex_age1,
              id = patient, 
              etype = dtg_switch_txt,
              data = FU_time)

cr2
```



```{r eval=FALSE, include=FALSE}
plot(cr2, xlim = c(2018.9, 2022)) 
```



```{r eval=FALSE, include=FALSE}
broom::tidy(cr2) %>% 
  mutate(country = word(strata, 1),
         country = str_replace(country, fixed("country="), ""),
         country = str_replace(country, fixed(","), ""),
         age_sex = word(strata, 2),
         age_sex = str_replace(age_sex, fixed("age_sex="), "")) %>% 
  filter(state != "(s0)") %>% 
  ggplot(aes(x = time, y = estimate, color = age_sex, linetype = rev(state))) +
  geom_line() + 
  facet_wrap(vars(country)) + 
  theme_bw()
```


<!-- ----------------------------------------------------- -->


```{r eval=FALSE, include=FALSE}
# Kaplan Meier: ggsurvplot 

## by sex


# https://rpkgs.datanovia.com/survminer/

# install.packages("survminer")

library("survminer")

fit_sex <- survfit(Surv(time, dtg_switch_txt) ~ sex, data = FU_time)

surv_sex <- ggsurvplot(fit_sex, data = FU_time, fun = function(x) {1 - x}, ylab = "Cumulative incidence (%)",  xlab = "Follow-up time (days)")

surv_sex

#ggsave("output/Cohort_transition_outcomes/SA256_KM_DTG_sex.png", width = 8, height =4)

#ggsave(file = "output/Cohort_transition_outcomes/ggsurv_v1.png", print(survp))

```



```{r eval=FALSE, include=FALSE}

# by sex with at risk table

p <- ggsurvplot(
   fit_sex,                     # survfit object with calculated statistics.
   data = FU_time,             # data used to fit survival curves.
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = TRUE,         # show confidence intervals for 
  surv.plot.height =0.75,        # point estimates of survival curves.
   xlim = c(0,1200),         # present narrower X axis, but not affect
   fun = function(x) {1 - x},             # Cumulative probability plot   
                            # survival estimates.
   xlab = "Follow-up time (days)",   # customize X axis label.
   ylab = "Cumulative incidence (%)",   # customize X axis label.
   break.time.by = 365,     # break X axis in time intervals by 500.
   ggtheme = theme_light(), # customize plot and risk table with a theme.
  risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE,
  risk.table.height = 0.25,
 legend ="right"
                           # show bars instead of names in text annotations
                            # in legend of risk table
  )
p


#ggsave("output/Cohort_transition_outcomes/SA256_KM_DTG_sex_v2.png", width = 8, height =4)

#ggsave("output/Cohort_transition_outcomes/survival_v2.png", plot = p, 
#       width = 10, height = 7, units = "in")

```




```{r eval=FALSE, include=FALSE}

## by country

# https://rpkgs.datanovia.com/survminer/

# install.packages("survminer")

#library("survminer")

fit_ctry <- survfit(Surv(time, dtg_switch_txt) ~ country, data = FU_time)

surv_ctry <- ggsurvplot(fit_ctry, data = FU_time,  fun = function(x) {1 - x},ylab = "Cumulative incidence (%)",  xlab = "Follow-up time (days)"
                    )

surv_ctry

#ggsave("output/Cohort_transition_outcomes/SA256_KM_DTG_ctry.png", width = 8, height =4)

#ggsave(file = "output/Cohort_transition_outcomes/ggsurv_v1.png", print(survp))

```




```{r eval=FALSE, include=FALSE}

# by country with at risk table

p <- ggsurvplot(
   fit_ctry,                     # survfit object with calculated statistics.
   data = FU_time,             # data used to fit survival curves.
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
 
   conf.int = TRUE,         # show confidence intervals for 
                            # point estimates of survival curves.
   surv.plot.height =0.75,
   xlim = c(0,1200),         # present narrower X axis, but not affect
   fun = function(x) {1 - x},             # Cumulative probability plot   
                            # survival estimates.
   ylab = "Cumulative incidence (%)",   # customize X axis label.
   xlab = "Follow-up time (days)",   # customize X axis label.
   break.time.by = 365,     # break X axis in time intervals by 500.
   ggtheme = theme_light(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE, # show bars instead of names in text annotations
  risk.table.height = 0.35,
 legend ="right"
                            # in legend of risk table
)

p

#ggsave("output/Cohort_transition_outcomes/SA256_KM_DTG_ctry_v2.png", width = 8, height =10)

#ggsave("output/Cohort_transition_outcomes/survival_v2.png", plot = p, 
#       width = 10, height = 7, units = "in")

```





```{r eval=FALSE, include=FALSE}
## by program


# https://rpkgs.datanovia.com/survminer/

# install.packages("survminer")

#library("survminer")

fit_prog <- survfit(Surv(time, dtg_switch_txt) ~ program, data = FU_time)

surv_prog <- ggsurvplot(fit_prog, data = FU_time,  fun = function(x) {1 - x},ylab = "Cumulative incidence (%)",  xlab = "Follow-up time (days)"
                    )

surv_prog

#ggsave("output/Cohort_transition_outcomes/SA256_KM_DTG_prog.png", width = 8, height =4)

#ggsave(file = "output/Cohort_transition_outcomes/ggsurv_v1.png", print(survp))

```




```{r eval=FALSE, include=FALSE}

# by program with at risk table

p <- ggsurvplot(
   fit_prog,                     # survfit object with calculated statistics.
   data = FU_time,             # data used to fit survival curves.
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
 
   conf.int = TRUE,         # show confidence intervals for 
                            # point estimates of survival curves.
   surv.plot.height =0.75,
   xlim = c(0,1200),         # present narrower X axis, but not affect
   fun = function(x) {1 - x},             # Cumulative probability plot   
                            # survival estimates.
   ylab = "Cumulative incidence (%)",   # customize X axis label.
   xlab = "Follow-up time (days)",   # customize X axis label.
   break.time.by = 365,     # break X axis in time intervals by 500.
   ggtheme = theme_light(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE, # show bars instead of names in text annotations
  risk.table.height = 0.35,
 legend ="right"
                            # in legend of risk table
)

p

#ggsave("output/Cohort_transition_outcomes/SA256_KM_DTG_prog_v2.png", width = 8, height =10)

#ggsave("output/Cohort_transition_outcomes/survival_v2.png", plot = p, 
#       width = 10, height = 7, units = "in")

```





```{r eval=FALSE, include=FALSE}

## by sex & age

# https://rpkgs.datanovia.com/survminer/

# install.packages("survminer")

#library("survminer")

fit_sexage <- survfit(Surv(time, dtg_switch_txt) ~ sex_age2, data = FU_time)

surv_sexage <- ggsurvplot(fit_sexage, data = FU_time,  fun = function(x) {1 - x},ylab = "Cumulative incidence (%)",  xlab = "Follow-up time (days)"
                    )

surv_sexage

#ggsave("output/Cohort_transition_outcomes/SA256_KM_DTG_sex_age2.png", width = 8, height =4)

#ggsave(file = "output/Cohort_transition_outcomes/ggsurv_v1.png", print(survp))

```




```{r eval=FALSE, include=FALSE}
## by sex & age with at risk table


p <- ggsurvplot(
   fit_sexage,                     # survfit object with calculated statistics.
   data = FU_time,             # data used to fit survival curves.
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = TRUE,         # show confidence intervals for 
                            # point estimates of survival curves.
   surv.plot.height =0.75,
   xlim = c(0,1200),         # present narrower X axis, but not affect
   fun = function(x) {1 - x},             # Cumulative probability plot   
                            # survival estimates.
   ylab = "Cumulative incidence (%)",   # customize X axis label.
   xlab = "Follow-up time (days)",   # customize X axis label.
   break.time.by = 183,     # break X axis in time intervals by 500.
   ggtheme = theme_light(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE,  # show bars instead of names in text annotations
  risk.table.height = 0.35
                            # in legend of risk table
)

p

#ggsave("output/Cohort_transition_outcomes/SA256_KM_DTG_sex_age2_v2.png", width = 8, height =10)

#ggsave("output/Cohort_transition_outcomes/survival_v2.png", plot = p, 
#       width = 10, height = 7, units = "in")

```




<!-- ----------------------------------------------------- -->


```{r include=FALSE}

# Cumulative incidence

# https://www.emilyzabor.com/tutorials/survival_analysis_in_r_tutorial.html

#install.packages("ggplot2")
#install.packages("ggfortify")

library(survival)
library(ggfortify)


```


```{r eval=FALSE, include=FALSE}

cuminc(Surv(time, dtg_switch_txt) ~ 1, data = FU_time) %>% 
  ggcuminc() + 
  labs(
    x = "Days"
  ) + 
  add_confidence_interval() +
  add_risktable()
```


```{r eval=FALSE, include=FALSE}
cuminc(Surv(time, dtg_switch_txt) ~ 1, data = FU_time) %>% 
  ggcuminc(outcome = c("1", "2")) +
  ylim(c(0, 1)) + 
  labs(
    x = "Days"
  )

```




```{r}

# https://cran.r-project.org/web/packages/survival/vignettes/compete.pdf

```

<!-- ----------------------------------------------------- -->



```{r eval=FALSE, include=FALSE}
# https://rviews.rstudio.com/2022/09/06/deep-survival/

set.seed(1952)

# KM by country

# start with a KM curve
surv.obj <- with(FU_time, Surv(time, dtg_switch_txt == 1))
fit.by_ctry <- survfit(surv.obj ~ country, data = FU_time, conf.type = "log-log")
autoplot(fit.by_sex, fun = 'event',
          xlab = "Follow-up time (Days) ", 
          ylab = "Survival Probabilities",
         main = "Kaplan-Meier plot of DTG uptake data by country") +  
 theme(plot.title = element_text(hjust = 0.5))

```


```{r eval=FALSE, include=FALSE}
# start with a KM curve
surv.obj <- with(FU_time, Surv(time, dtg_switch_txt == 1))
fit.by_ctry <- survfit(surv.obj ~ country, data = FU_time, conf.type = "log-log")

d <- ggsurvplot(
   fit.by_sex,                     # survfit object with calculated statistics.
   data = FU_time,             # data used to fit survival curves.
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = TRUE,         # show confidence intervals for 
                            # point estimates of survival curves.
   xlim = c(0,1200),         # present narrower X axis, but not affect
   fun = function(x) {1 - x},             # Cumulative probability plot   
                            # survival estimates.
   ylab = "Cumulative probability (%)",   # customize X axis label.
   xlab = "Follow-up time (days)",   # customize X axis label.
   break.time.by = 183,     # break X axis in time intervals by 500.
   ggtheme = theme_light(), # customize plot and risk table with a theme.
   risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)

d

```



```{r eval=FALSE, include=FALSE}
# https://rviews.rstudio.com/2022/09/06/deep-survival/

set.seed(1952)

# KM by sex

# start with a KM curve
surv.obj <- with(FU_time, Surv(time, dtg_switch_txt == 1))
fit.by_sex <- survfit(surv.obj ~ sex, data = FU_time, conf.type = "log-log")
autoplot(fit.by_sex, fun = 'event',
          xlab = "Follow-up time (Days) ", 
          ylab = "Survival Probabilities",
         main = "Kaplan-Meier plot of DTG uptake data by sex") +  
 theme(plot.title = element_text(hjust = 0.5))

```



```{r eval=FALSE, include=FALSE}
# https://rviews.rstudio.com/2022/09/06/deep-survival/

set.seed(1952)

# KM by sex & age

# start with a KM curve
surv.obj <- with(FU_time, Surv(time, dtg_switch_txt == 1))
fit.by_sex <- survfit(surv.obj ~ sex_age2, data = FU_time, conf.type = "log-log")
autoplot(fit.by_sex, fun = 'event',
          xlab = "Follow-up time (Days) ", 
          ylab = "Survival Probabilities",
         main = "Kaplan-Meier plot of DTG uptake data by sex & age") +  
 theme(plot.title = element_text(hjust = 0.5))

```


<!-- ----------------------------------------------------- -->



```{r eval=FALSE, include=FALSE}
# https://rpubs.com/alecri/258589

# KM by country  

fit_km <- survfit(Surv(time, dtg_switch_txt) ~ 1, data = FU_time)
print(fit_km, print.rmean = TRUE)

dat_km <- fortify(fit_km)
head(dat_km)

# no competing risks

s <- ggsurvplot(fit_km, risk.table = TRUE, xlab = "Time (years)", censor = F)

s


```

```{r eval=FALSE, include=FALSE}

glist <- list(
  ggsurvplot(fit_km, fun = "event", main = "Cumulative proportion"),
  ggsurvplot(fit_km, fun = "cumhaz",  main = "Cumulative Hazard"),
  ggsurvplot(fit_km, fun = "cloglog", main = "Complementary loglog")
)
arrange_ggsurvplots(glist, print = TRUE, ncol = 3, nrow = 1)

```

```{r eval=FALSE, include=FALSE}

#ci.exp(glm(all ~ 0 + stage, data = orca, family = "poisson", offset = log(time)))
group_by(FU_time, country) %>%
  summarise(
    D = sum(dtg_switch_txt),
    Y = sum(time)
  ) 

```


```{r eval=FALSE, include=FALSE}
su_stg  <- survfit(Surv(time, dtg_switch_txt) ~ country, data = FU_time)
su_stg

ggsurvplot(su_stg, fun = "event", censor = F, xlab = "Time (days)")
```

<!-- ----------------------------------------------------- -->



```{r eval=FALSE, include=FALSE}
# https://rpubs.com/alecri/258589

# KM by sex & age

fit_km <- survfit(Surv(time, dtg_switch_txt) ~ 1, data = FU_time)
print(fit_km, print.rmean = TRUE)

```

```{r eval=FALSE, include=FALSE}
dat_km <- fortify(fit_km)
head(dat_km)

```

```{r eval=FALSE, include=FALSE}
# no competing risks
ggsurvplot(fit_km, risk.table = TRUE, xlab = "Time (years)", censor = F)

```


```{r eval=FALSE, include=FALSE}
glist <- list(
  ggsurvplot(fit_km, fun = "event", main = "Cumulative proportion"),
  ggsurvplot(fit_km, fun = "cumhaz",  main = "Cumulative Hazard"),
  ggsurvplot(fit_km, fun = "cloglog", main = "Complementary loglog")
)
arrange_ggsurvplots(glist, print = TRUE, ncol = 3, nrow = 1)

```

```{r eval=FALSE, include=FALSE}
#ci.exp(glm(all ~ 0 + stage, data = orca, family = "poisson", offset = log(time)))
group_by(FU_time, sex_age2) %>%
  summarise(
    D = sum(dtg_switch_txt),
    Y = sum(time)
  ) 

```


```{r eval=FALSE, include=FALSE}
su_stg  <- survfit(Surv(time, dtg_switch_txt) ~ sex_age2, data = FU_time)
su_stg
```


```{r eval=FALSE, include=FALSE}
ggsurvplot(su_stg, fun = "event", censor = F, xlab = "Time (days)")
```


```{r eval=FALSE, include=FALSE}
frq(tblBAS, max_close_d)
```


<!-- ----------------------------------------------------- -->

# Computing Environment

```{r echo=FALSE, results='asis'}
report(sessionInfo())
```