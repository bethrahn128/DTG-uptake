
## Treatment collapse

```{r include=FALSE}
setorder(tblART, patient, art_sd)
tblART[, c("drug1", "drug2", "drug3") := tstrsplit(drug, " ", fixed = TRUE)]
gc()
```

Treatments were then collapsed on the basis of **both start & end date**.  

```{r results=FALSE}
tblART_end = data.table::melt(tblART,
                              id.vars = c("patient", "art_sd", "art_ed"),
                              measure.vars = c("drug1", "drug2", "drug3"),
                              na.rm = TRUE
)

tblART_end = unique(tblART_end,
                    by = c("patient", "art_sd", "art_ed", "value")
)

# all in one row (by start, end date, by patient)
setorder(tblART_end, patient, art_sd, art_ed, value)

gc()
tblART_end = data.table::dcast(
  tblART_end,
  patient + art_sd + art_ed ~ variable,
  function(x) paste(x, collapse = " ")
)

tblART_end[, trt_raw := trimws(paste(drug1, drug2, drug3), which = "both")]

gc()
tblART_end[, trt := lapply(strsplit(trt_raw, " "), function(x) paste0(sort(x), collapse = " "))]
tblART_end[, trt := as.character(trt)]

# View(tblART_end[trt_raw != trt, ])
# frq(tblART_end, trt, sort.frq = "desc")

tblART_end[, c("drug1", "drug2", "drug3", "trt_raw") := NULL]

# removing duplicates
if (nrow(tblART_end) - nrow(unique(tblART_end)) > 0) {
  tblART_end = unique(tblART_end)
}
setorder(tblART_end, patient, art_sd, art_ed, na.last = TRUE)
```

Additional, simplified dataset was created collapsing on the basis of **start date only**.

```{r include=FALSE}
gc()
tblART_start = data.table::melt(tblART,
                                id.vars = c("patient", "art_sd"),
                                measure.vars = c("drug1", "drug2", "drug3"),
                                na.rm = TRUE
)

tblART_start = unique(tblART_start,
                      by = c("patient", "art_sd", "value")
)

# all in one row (by start, by patient)
setorder(tblART_start, patient, art_sd, value)

gc()
tblART_start = data.table::dcast(
  tblART_start,
  patient + art_sd ~ variable,
  function(x) paste(x, collapse = " ")
)

tblART_start[, trt_raw := trimws(paste(drug1, drug2, drug3), which = "both")]

gc()
tblART_start[, trt := lapply(strsplit(trt_raw, " "), function(x) paste0(sort(x), collapse = " "))]
tblART_start[, trt := as.character(trt)]

# View(tblART_start[trt_raw != trt, ])
# frq(tblART_start, trt, sort.frq = "desc")

tblART_start[, c("drug1", "drug2", "drug3", "trt_raw") := NULL]

# removing duplicates
if (nrow(tblART_start) - nrow(unique(tblART_start)) > 0) {
  tblART_start = unique(tblART_start)
}
setorder(tblART_start, patient, art_sd, na.last = TRUE)
```

```{r include=FALSE}
tblART[, c("drug1", "drug2", "drug3") := NULL]
setcolorder(tblART, "patient")

# get program back
tblART_end = merge(tblBAS[, .(patient, program)],
                   tblART_end,
                   by = "patient",
                   all.x = FALSE, all.y = FALSE
)

# get close_d
tblART_end = merge(tblART_end, program_close_d,
                   by = "program",
                   all.x = TRUE, all.y = FALSE
)

tblART_end[, dtg := 0]
tblART_end[trt %like% "DTG", dtg := 1]


tblART_start = merge(tblBAS[, .(patient, program)],
                     tblART_start,
                     by = "patient",
                     all.x = FALSE, all.y = FALSE
)

tblART_start = merge(tblART_start, program_close_d,
                     by = "program",
                     all.x = TRUE, all.y = FALSE
)

gc()

tblART_start[, dtg := 0]
tblART_start[trt %like% "DTG", dtg := 1]
```

- during that process treatments were additionally sorted alphabetically when different permutations of two or more drugs were used so that `3TC LPV AZT RTV` or `3TC RTV LPV AZT` both became `3TC AZT LPV RTV`

- number of medications per ~~treatment~~ **record** was calculated  

```{r include=FALSE}
tblART_end[, ndrugs := sapply(trt, ngram::wordcount)]
tblART_start[, ndrugs := sapply(trt, ngram::wordcount)]
```

```{r echo=FALSE}
frq(tblART_end, ndrugs)
```

- number of treatment with 1 & 2 meds in 'start only' dataset is slightly lower  

```{r echo=FALSE}
frq(tblART_start, ndrugs)
```

## Check: incorrect treatment collapse

- note that we have a problem with treatments starting/ending at different times. Consider example of a patient with three records of meds.  

```{r echo=FALSE}
tblART_end[
  patient == "TYTY999418108",
  c("patient", "art_sd", "art_ed", "trt", "ndrugs")
]
```

`ndrugs` pattern of **1, 2, 1** is not consistent with reality in such case since patient was most likely using **3** meds through all the time!:  

```{r echo=FALSE}
tblART_end[patient == "TYTY999418108", ] %>%
  dplyr::mutate(order = dplyr::row_number()) %>%
  ggplot(aes(x = order, ymin = art_sd, ymax = art_ed)) +
  geom_linerange() +
  coord_flip() +
  xlab("") +
  ylab("Treatment duration") +
  scale_y_date() +
  scale_x_continuous(
    n.breaks = 3,
    minor_breaks = NULL,
    labels = tblART_end[patient == "TYTY999418108", ]$trt
  ) +
  theme_minimal()
```
